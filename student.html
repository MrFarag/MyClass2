<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MyClass2 - Ø§Ù„Ø·Ø§Ù„Ø¨</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100dvh;overflow:hidden;touch-action:none;font-family:'Segoe UI',sans-serif;background:#111b27;color:#fff;display:flex;flex-direction:column}
.hdr{height:48px;min-height:48px;background:#1e2d3d;padding:0 12px;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #3498db;flex-shrink:0}
.logo{font-size:15px;font-weight:bold;display:flex;align-items:center;gap:6px}.logo i{color:#3498db}
.perm{background:#27ae60;padding:4px 10px;border-radius:20px;font-size:12px;display:flex;align-items:center;gap:5px;transition:background .3s;white-space:nowrap}
.boards{flex:1;display:flex;flex-direction:column;padding:6px;gap:6px;overflow:hidden;min-height:0}
.board{flex:1;display:flex;flex-direction:column;background:#1e2d3d;border-radius:10px;overflow:hidden;border:1px solid #2c4159;min-height:0}
.bhead{padding:7px 12px;background:#243447;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.bhead.t{border-bottom:3px solid #e67e22}.bhead.s{border-bottom:3px solid #27ae60}
.bhead span{font-size:12px;font-weight:bold;display:flex;align-items:center;gap:5px}
.audge{background:#e67e22;padding:2px 8px;border-radius:20px;font-size:10px;display:flex;align-items:center;gap:3px;animation:blink 1s infinite;white-space:nowrap}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.5}}
.cbox{flex:1;overflow:hidden;background:#fff;position:relative;min-height:0}
.cbox canvas{
  position:absolute;top:0;left:0;
  background:#fff;
  transform-origin:top left;
}
#myC{touch-action:none;cursor:crosshair}
#tC{touch-action:pan-x pan-y;cursor:default;pointer-events:none}
.tb{height:58px;min-height:58px;background:#1e2d3d;border-top:2px solid #3498db;display:flex;align-items:center;justify-content:center;gap:6px;padding:0 8px;flex-shrink:0;overflow-x:auto;flex-wrap:nowrap}
.tb::-webkit-scrollbar{display:none}
.tg{display:flex;gap:3px;background:#111b27;padding:4px 6px;border-radius:20px;align-items:center;flex-shrink:0}
.clr{width:26px;height:26px;border-radius:50%;border:2px solid transparent;cursor:pointer;flex-shrink:0;transition:.12s}
.clr.sel{border-color:#fff;box-shadow:0 0 5px rgba(255,255,255,.5);transform:scale(1.15)}
.tbtn{width:34px;height:34px;border:none;border-radius:50%;background:#2c4159;color:#fff;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:.12s}
.tbtn.sel,.tbtn:hover{background:#3498db}
.tbtn.del{color:#e74c3c}.tbtn.del:hover{background:#e74c3c;color:#fff}
.tbtn.recording{background:#27ae60!important;animation:pulse-green 1.5s infinite}
.tbtn.speaking{background:#f39c12!important;animation:pulse-orange 1.5s infinite}
@keyframes pulse-green{0%,100%{box-shadow:0 0 0 0 rgba(39,174,96,.6)}50%{box-shadow:0 0 0 8px rgba(39,174,96,0)}}
@keyframes pulse-orange{0%,100%{box-shadow:0 0 0 0 rgba(243,156,18,.6)}50%{box-shadow:0 0 0 8px rgba(243,156,18,0)}}
.status{height:36px;min-height:36px;background:#0e1820;border-top:1px solid #1e2d3d;display:flex;align-items:center;justify-content:space-between;padding:0 12px;font-size:12px;color:#8a9bb0;flex-shrink:0}
.sdot{width:8px;height:8px;border-radius:50%;flex-shrink:0;display:inline-block}
.sdot.on{background:#27ae60;box-shadow:0 0 5px #27ae60}.sdot.off{background:#e74c3c}.sdot.aud{background:#e67e22;animation:blink 1s infinite}
.waves{display:flex;gap:2px;align-items:center}
.waves span{display:block;width:3px;background:#e67e22;border-radius:2px;animation:wv .8s infinite}
.waves span:nth-child(1){height:6px}.waves span:nth-child(2){height:12px;animation-delay:.15s}.waves span:nth-child(3){height:6px;animation-delay:.3s}
@keyframes wv{0%,100%{transform:scaleY(.5)}50%{transform:scaleY(1.2)}}
</style>
</head>
<body>

<div class="hdr">
  <div class="logo"><i class="fas fa-user-graduate"></i>MyClass2</div>
  <div class="perm" id="perm"><i class="fas fa-lock-open"></i> ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ÙƒØªØ§Ø¨Ø©</div>
</div>

<div class="boards">
  <div class="board">
    <div class="bhead t">
      <span><i class="fas fa-chalkboard-teacher" style="color:#e67e22"></i>Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³</span>
      <span id="audBadge" style="display:none" class="audge"><i class="fas fa-volume-up"></i>ØµÙˆØª Ù…Ø¨Ø§Ø´Ø±</span>
    </div>
    <div class="cbox" id="tBox"><canvas id="tC"></canvas></div>
  </div>
  <div class="board">
    <div class="bhead s">
      <span><i class="fas fa-pencil-alt" style="color:#27ae60"></i>Ø³Ø¨ÙˆØ±ØªÙŠ</span>
    </div>
    <div class="cbox" id="mBox"><canvas id="myC"></canvas></div>
  </div>
</div>

<div class="tb">
  <div class="tg">
    <div class="clr sel" style="background:#111" onclick="pClr('black',this)"></div>
    <div class="clr" style="background:#e74c3c" onclick="pClr('#e74c3c',this)"></div>
    <div class="clr" style="background:#3498db" onclick="pClr('#3498db',this)"></div>
    <div class="clr" style="background:#27ae60" onclick="pClr('#27ae60',this)"></div>
    <div class="clr" style="background:#f39c12" onclick="pClr('#f39c12',this)"></div>
    <div class="clr" style="background:#fff;border:2px solid #666" onclick="pClr('#fff',this)"></div>
  </div>
  <div class="tg">
    <button class="tbtn" onclick="pSz(3,this)"><i class="fas fa-pen" style="font-size:10px"></i></button>
    <button class="tbtn sel" onclick="pSz(6,this)"><i class="fas fa-pen-fancy" style="font-size:11px"></i></button>
    <button class="tbtn" onclick="pSz(14,this)"><i class="fas fa-paint-brush"></i></button>
  </div>
  <div class="tg">
    <button class="tbtn sel" id="penBtn" onclick="pTool('pen')"><i class="fas fa-pencil-alt"></i></button>
    <button class="tbtn" id="eraserBtn" onclick="pTool('eraser')"><i class="fas fa-eraser"></i></button>
    <button class="tbtn del" onclick="clearMine()"><i class="fas fa-trash-alt"></i></button>
  </div>
  <div class="tg">
    <button class="tbtn" id="myMicBtn" onclick="requestMic()">
      <i class="fas fa-microphone-slash" id="myMicIcon"></i>
    </button>
  </div>
</div>

<div class="status">
  <div style="display:flex;align-items:center;gap:6px">
    <span class="sdot off" id="sdot"></span>
    <span id="stxt">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
  </div>
  <div style="display:flex;align-items:center;gap:6px">
    <i class="fas fa-volume-up" id="spkIcon" style="color:#e67e22; display:none"></i>
    <div class="waves" id="waves" style="display:none"><span></span><span></span><span></span></div>
  </div>
</div>

<audio id="audioEl" autoplay playsinline style="display:none"></audio>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
// â”€â”€ Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
firebase.initializeApp({
  apiKey:"AIzaSyB7E4NsGQbCehVSQ3Kj97yExRZwpHzTOl8",
  authDomain:"myclaive.firebaseapp.com",
  databaseURL:"https://myclaive-default-rtdb.firebaseio.com",
  projectId:"myclaive",
  storageBucket:"myclaive.firebasestorage.app",
  messagingSenderId:"507299311714",
  appId:"1:507299311714:web:c90440ee4353cfac17613b"
});
const db = firebase.database();

// â”€â”€ Canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CW=1600, CH=1200;
const tC   = document.getElementById('tC');
const myC  = document.getElementById('myC');
const tCtx = tC.getContext('2d');
const mCtx = myC.getContext('2d');
const tBox = document.getElementById('tBox');
const mBox = document.getElementById('mBox');

tC.width=CW;  tC.height=CH;
myC.width=CW; myC.height=CH;
[tCtx,mCtx].forEach(c=>{c.lineCap='round';c.lineJoin='round';});

let mSx=1, mSy=1;

function fitBoxes(){
  function fit(canvas, box){
    const bw=box.clientWidth, bh=box.clientHeight;
    if(!bw||!bh)return;
    const sx=bw/CW, sy=bh/CH;
    canvas.style.width=CW+'px'; canvas.style.height=CH+'px';
    canvas.style.transform=`scale(${sx},${sy})`;
    canvas.style.transformOrigin='top left';
    return {sx,sy};
  }
  fit(tC,tBox);
  const r=fit(myC,mBox);
  if(r){mSx=r.sx;mSy=r.sy;}
}
fitBoxes(); setTimeout(fitBoxes,100);
window.addEventListener('resize',fitBoxes);

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var penColor='black', penSize=6, penTool='pen';
var drawing=false, lx=0, ly=0;
var canDraw=true;
const SESSION='S'+Date.now()+'_'+Math.random().toString(36).substr(2,4);
var strokeN=0;
var myMicOn=false, myMicStream=null, myRecInterval=null, myAudioSlot=0;
var micPermission=false;
const studentId = 'stu_'+Date.now()+'_'+Math.random().toString(36).substr(2,5);
const studentName = 'Ø·Ø§Ù„Ø¨_' + Math.floor(Math.random()*1000);
var currentSpeaker = null;

// â”€â”€ Ø±Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getXY(e){
  const r=mBox.getBoundingClientRect();
  const cx=e.touches?e.touches[0].clientX:e.clientX;
  const cy=e.touches?e.touches[0].clientY:e.clientY;
  return{x:(cx-r.left)/mSx, y:(cy-r.top)/mSy};
}

var buf=[], bufTimer=null, curKey='';

function flushBuf(){
  if(!buf.length)return;
  db.ref('draw_st').push({
    k:curKey,
    c:penTool==='eraser'?null:penColor,
    s:penTool==='eraser'?-1:penSize,
    pts:buf.splice(0),
    ts:Date.now()
  });
}

function onDown(e){
  e.preventDefault();
  if(!canDraw){shakePerm();return;}
  drawing=true; strokeN++;
  curKey=SESSION+'_'+strokeN;
  const p=getXY(e); lx=p.x; ly=p.y; buf=[{x:p.x,y:p.y}];
  mCtx.save();
  mCtx.globalCompositeOperation=penTool==='eraser'?'destination-out':'source-over';
  mCtx.fillStyle=penTool==='eraser'?'rgba(0,0,0,1)':penColor;
  mCtx.beginPath(); mCtx.arc(p.x,p.y,(penTool==='eraser'?penSize*5:penSize)/2,0,Math.PI*2); mCtx.fill();
  mCtx.restore();
}

function onMove(e){
  e.preventDefault(); if(!drawing||!canDraw)return;
  const p=getXY(e);
  mCtx.save();
  mCtx.globalCompositeOperation=penTool==='eraser'?'destination-out':'source-over';
  mCtx.strokeStyle=penTool==='eraser'?'rgba(0,0,0,1)':penColor;
  mCtx.lineWidth=penTool==='eraser'?penSize*5:penSize;
  mCtx.lineCap='round'; mCtx.lineJoin='round';
  mCtx.beginPath(); mCtx.moveTo(lx,ly); mCtx.lineTo(p.x,p.y); mCtx.stroke();
  mCtx.restore();
  buf.push({x:p.x,y:p.y});
  if(!bufTimer)bufTimer=setTimeout(()=>{flushBuf();bufTimer=null;},25);
  lx=p.x; ly=p.y;
}

function onUp(){
  if(!drawing)return; drawing=false;
  clearTimeout(bufTimer); bufTimer=null; flushBuf();
}

myC.addEventListener('mousedown',  onDown);
myC.addEventListener('mousemove',  onMove);
myC.addEventListener('mouseup',    onUp);
myC.addEventListener('mouseleave', onUp);
myC.addEventListener('touchstart', onDown,{passive:false});
myC.addEventListener('touchmove',  onMove,{passive:false});
myC.addEventListener('touchend',   onUp);
myC.addEventListener('touchcancel',onUp);

// â”€â”€ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const remSt={};

function applyRemote(ctx, box, d){
  if(!d||!d.pts||!d.pts.length)return;
  const key=d.k||String(d.ts);
  const isE=d.s===-1, lw=isE?50:(d.s||3);
  if(!remSt[key]){
    const p=d.pts[0];
    remSt[key]={lx:p.x,ly:p.y};
    ctx.save();
    ctx.globalCompositeOperation=isE?'destination-out':'source-over';
    ctx.fillStyle=isE?'rgba(0,0,0,1)':(d.c||'#000');
    ctx.beginPath();ctx.arc(p.x,p.y,lw/2,0,Math.PI*2);ctx.fill();ctx.restore();
  }
  const st=remSt[key];
  ctx.save();
  ctx.globalCompositeOperation=isE?'destination-out':'source-over';
  ctx.strokeStyle=isE?'rgba(0,0,0,1)':(d.c||'#000');
  ctx.lineWidth=lw; ctx.lineCap='round'; ctx.lineJoin='round';
  ctx.beginPath(); ctx.moveTo(st.lx,st.ly);
  for(const p of d.pts){ctx.lineTo(p.x,p.y); st.lx=p.x; st.ly=p.y;}
  ctx.stroke(); ctx.restore();
}

db.ref('draw_t').on('child_added', snap=>applyRemote(tCtx,tBox,snap.val()));
db.ref('draw_s').on('child_added', snap=>applyRemote(mCtx,mBox,snap.val()));

db.ref('cmd').on('child_added',snap=>{
  const d=snap.val();if(!d)return;
  if(d.t==='clrAll'||d.t==='clrT')tCtx.clearRect(0,0,CW,CH);
  if(d.t==='clrAll'||d.t==='clrS')mCtx.clearRect(0,0,CW,CH);
});

db.ref('ctrl').on('value',snap=>{
  const v=snap.val();if(!v)return;
  canDraw=v.studentsCanDraw!==false;
  const el=document.getElementById('perm');
  el.innerHTML=canDraw?'<i class="fas fa-lock-open"></i> ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ÙƒØªØ§Ø¨Ø©':'<i class="fas fa-lock"></i> Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù…Ù…Ù†ÙˆØ¹Ø©';
  el.style.background=canDraw?'#27ae60':'#e74c3c';
});

function shakePerm(){
  const el=document.getElementById('perm');
  [0,-6,6,-6,6,0].forEach((v,i)=>setTimeout(()=>el.style.transform=`translateX(${v}px)`,i*50));
}

// â”€â”€ Ø§Ù„ØµÙˆØª (Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³ Ø£Ùˆ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡Ù…) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const audioEl=document.getElementById('audioEl');
var audioQueue=[], audioPlaying=false;
const heardTs=new Set();

function playNext(){
  if(audioPlaying||!audioQueue.length)return;
  audioPlaying=true;
  audioEl.src=audioQueue.shift();
  audioEl.onended=()=>{audioPlaying=false;playNext();};
  audioEl.onerror=()=>{audioPlaying=false;playNext();};
  audioEl.play().catch(()=>{audioPlaying=false;});
}

function gotAudio(d){
  if(!d||!d.d||heardTs.has(d.ts))return;
  heardTs.add(d.ts); audioQueue.push(d.d); playNext();
}

db.ref('audio/s0').on('value',snap=>gotAudio(snap.val()));
db.ref('audio/s1').on('value',snap=>gotAudio(snap.val()));

db.ref('audioMeta').on('value',snap=>{
  const v=snap.val(), active=v&&v.active;
  document.getElementById('audBadge').style.display=active?'flex':'none';
  document.getElementById('spkIcon').style.display=active?'inline':'none';
  document.getElementById('waves').style.display=active?'flex':'none';
  
  if(active){
    if(v.speaker === 'teacher'){
      document.getElementById('stxt').textContent = 'ðŸŽ¤ Ø§Ù„Ù…Ø¯Ø±Ø³ ÙŠØªÙƒÙ„Ù…';
      document.getElementById('sdot').className = 'sdot aud';
    } else if(v.speaker === 'student' && v.studentId === studentId){
      document.getElementById('stxt').textContent = 'ðŸŽ¤ Ø£Ù†Øª ØªØªØ­Ø¯Ø«';
      document.getElementById('sdot').className = 'sdot aud';
    } else if(v.speaker === 'student'){
      document.getElementById('stxt').textContent = 'ðŸŽ¤ Ø·Ø§Ù„Ø¨ ÙŠØªØ­Ø¯Ø«';
      document.getElementById('sdot').className = 'sdot aud';
    }
  } else {
    document.getElementById('stxt').textContent = 'Ù…ØªØµÙ„';
    document.getElementById('sdot').className = 'sdot on';
    audioQueue=[]; audioPlaying=false; audioEl.src=''; heardTs.clear();
  }
});

function unlockAudio(){try{audioEl.play().catch(()=>{});}catch(e){}}
document.body.addEventListener('touchstart',unlockAudio,{once:true});
document.body.addEventListener('click',unlockAudio,{once:true});

// â”€â”€ Ù…Ø§ÙŠÙƒ Ø§Ù„Ø·Ø§Ù„Ø¨ (Ø·Ù„Ø¨ Ø¥Ø°Ù†) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getMime(){for(const t of['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus'])if(MediaRecorder.isTypeSupported(t))return t;return'';}
function toB64(blob){return new Promise(r=>{const f=new FileReader();f.onloadend=()=>r(f.result);f.readAsDataURL(blob);});}

function myRecordOnce(){
  if(!myMicStream||!myMicOn)return;
  const mime=getMime(), rec=new MediaRecorder(myMicStream,mime?{mimeType:mime}:{});
  const chunks=[];
  rec.ondataavailable=ev=>{if(ev.data&&ev.data.size>0)chunks.push(ev.data);};
  rec.onstop=async()=>{
    if(!myMicOn||!chunks.length)return;
    const b64=await toB64(new Blob(chunks,{type:mime||'audio/webm'}));
    myAudioSlot=myAudioSlot===0?1:0;
    db.ref('stuAudio/s'+myAudioSlot).set({d:b64,ts:Date.now()});
  };
  rec.start(); setTimeout(()=>{try{rec.stop();}catch(e){}},2800);
}

async function startMyMic(){
  const btn=document.getElementById('myMicBtn'), icon=document.getElementById('myMicIcon');
  icon.className='fas fa-spinner fa-spin';
  try{
    myMicStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:true}});
    myMicOn=true; 
    btn.classList.remove('recording', 'speaking');
    btn.classList.add('speaking');
    icon.className='fas fa-microphone';
    myRecordOnce(); 
    myRecInterval=setInterval(myRecordOnce,3000);
  } catch(err){
    icon.className='fas fa-microphone-slash';
    alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†:\n'+err.message);
  }
}

function stopMyMic(){
  clearInterval(myRecInterval);myRecInterval=null;
  if(myMicStream)myMicStream.getTracks().forEach(t=>t.stop());
  myMicStream=null;myMicOn=false;
  db.ref('stuAudio').remove();
  const btn=document.getElementById('myMicBtn');
  btn.classList.remove('recording', 'speaking');
  document.getElementById('myMicIcon').className='fas fa-microphone-slash';
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¥Ø°Ù† Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³
db.ref('micPermissions/'+studentId).on('value', snap=>{
  const perm = snap.val();
  if(perm && perm.allowed===true){
    micPermission=true;
    startMyMic();
    // Ø­Ø°Ù Ø§Ù„Ø¥Ø°Ù† Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
    setTimeout(()=>{
      db.ref('micPermissions/'+studentId).remove();
    }, 1000);
  } else if(perm && perm.allowed===false){
    micPermission=false;
    alert('Ù„Ù… ÙŠØ³Ù…Ø­ Ø§Ù„Ù…Ø¯Ø±Ø³ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø§ÙŠÙƒ');
    document.getElementById('myMicIcon').className='fas fa-microphone-slash';
  }
});

function requestMic(){
  if(myMicOn){
    // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØªØ­Ø¯Ø«ØŒ ÙŠÙˆÙ‚Ù Ù†ÙØ³Ù‡
    stopMyMic();
    micPermission=false;
  } else {
    // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³
    db.ref('micRequests').push({
      studentId: studentId,
      studentName: studentName,
      ts: Date.now()
    });
    document.getElementById('myMicIcon').className='fas fa-hourglass-half';
    setTimeout(()=>{
      if(!myMicOn){
        document.getElementById('myMicIcon').className='fas fa-microphone-slash';
      }
    }, 5000);
  }
}

// â”€â”€ Ø£Ø¯ÙˆØ§Øª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pClr(c,el){penColor=c;document.querySelectorAll('.clr').forEach(b=>b.classList.remove('sel'));el.classList.add('sel');pTool('pen');}
function pSz(s,el){penSize=s;document.querySelectorAll('.tg:nth-child(2) .tbtn').forEach(b=>b.classList.remove('sel'));el.classList.add('sel');}
function pTool(t){penTool=t;document.getElementById('penBtn').classList.toggle('sel',t==='pen');document.getElementById('eraserBtn').classList.toggle('sel',t==='eraser');}
function clearMine(){mCtx.clearRect(0,0,CW,CH);}

// â”€â”€ Connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
db.ref('.info/connected').on('value',snap=>{
  document.getElementById('sdot').className='sdot '+(snap.val()?'on':'off');
  document.getElementById('stxt').textContent=snap.val()?'Ù…ØªØµÙ„':'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
});
db.ref('onlineStudents/'+studentId).set({online:true,ts:Date.now(), name:studentName});
window.addEventListener('beforeunload',()=>{
  db.ref('onlineStudents/'+studentId).remove();
  db.ref('stuAudio').remove();
  db.ref('micPermissions/'+studentId).remove();
  if(myMicStream)myMicStream.getTracks().forEach(t=>t.stop());
});
[tC,myC].forEach(c=>c.addEventListener('contextmenu',e=>e.preventDefault()));
</script>
</body>
</html>
