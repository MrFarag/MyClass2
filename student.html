<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>MyClass2 - Ø§Ù„Ø·Ø§Ù„Ø¨</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{--bl:#3b82f6;--rd:#ef4444;--gn:#22c55e;--yw:#f59e0b;
      --dk:#0f172a;--cd:#1e293b;--br:#334155;--mt:#475569;--dim:#94a3b8}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Cairo',sans-serif}
html,body{height:100%;overflow:hidden;background:var(--dk);color:#fff}

/* JOIN */
#overlay{position:fixed;inset:0;background:var(--dk);display:flex;align-items:center;justify-content:center;z-index:9999}
.jcard{background:var(--cd);border:1px solid var(--br);border-radius:24px;padding:40px 28px;width:300px;text-align:center}
.jlogo{font-size:30px;font-weight:900;color:var(--bl)}.jlogo b{color:#fff}
.jsub{font-size:13px;color:var(--dim);margin:6px 0 22px}
.jcard input{width:100%;padding:12px;background:var(--br);border:1px solid var(--mt);
  border-radius:12px;color:#fff;font-size:15px;font-family:'Cairo',sans-serif;
  text-align:center;outline:none;margin-bottom:12px}
.jcard input:focus{border-color:var(--bl)}
.jbtn{width:100%;padding:12px;background:var(--bl);border:none;border-radius:12px;
  color:#fff;font-size:15px;font-weight:700;cursor:pointer;font-family:'Cairo',sans-serif}
.jbtn:disabled{opacity:.5;cursor:default}
.jwait{display:none;margin-top:14px;color:var(--yw);font-size:13px}

/* APP */
#app{position:fixed;inset:0;display:flex;flex-direction:column}

/* TOPBAR */
.top{height:48px;background:var(--cd);border-bottom:2px solid var(--br);
     padding:0 12px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.logo{font-size:17px;font-weight:900;color:var(--bl)}.logo b{color:#fff}
.topright{display:flex;align-items:center;gap:8px}
.nchip{background:var(--br);padding:4px 12px;border-radius:20px;font-size:12px}
.hbtn{width:36px;height:36px;border-radius:50%;border:none;background:var(--br);
  color:var(--dim);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}
.hbtn.up{background:var(--yw);color:#fff;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

/* BOARDS */
.boards{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0;padding:5px;gap:5px}
.bcard{flex:1;background:var(--cd);border-radius:12px;border:1px solid var(--br);
  display:flex;flex-direction:column;overflow:hidden;min-height:0}
.bhead{height:33px;padding:0 10px;background:var(--br);border-bottom:2px solid transparent;
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.tboard .bhead{border-bottom-color:var(--rd)}.sboard .bhead{border-bottom-color:var(--bl)}
.btitle{font-size:12px;font-weight:700;display:flex;align-items:center;gap:6px}
.carea{flex:1;background:#fff;position:relative;overflow:hidden;min-height:0}
.carea canvas{position:absolute;inset:0;display:block;width:100%;height:100%}
#sc{touch-action:none;cursor:crosshair}
.livebadge{background:var(--rd);padding:2px 7px;border-radius:8px;font-size:10px;
  display:none;align-items:center;gap:3px;color:#fff}
.livebadge.on{display:flex}

/* MIC BAR */
.micbar{background:var(--cd);border-top:1px solid var(--br);
  padding:7px 12px;display:flex;align-items:center;gap:10px;flex-shrink:0}
.micbtn{width:46px;height:46px;border-radius:50%;border:none;
  background:var(--br);color:var(--dim);cursor:pointer;font-size:19px;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:.2s}
.micbtn.req{background:rgba(245,158,11,.2);color:var(--yw);animation:pulse 1s infinite}
.micbtn.spk{background:var(--gn);color:#fff;box-shadow:0 0 0 4px rgba(34,197,94,.25);animation:pulse 1s infinite}
.miclbl{font-size:13px;color:var(--dim);flex:1}
.volwrap{display:flex;align-items:center;gap:6px;flex-shrink:0}
.volwrap i{font-size:11px;color:var(--dim)}
input.vol{width:72px;height:4px;-webkit-appearance:none;background:var(--mt);border-radius:2px}
input.vol::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:var(--bl);border-radius:50%;cursor:pointer}

/* TOOLBAR */
.tbar{background:var(--cd);border-top:1px solid var(--br);
  padding:6px 10px;display:flex;align-items:center;gap:5px;flex-shrink:0;overflow-x:auto}
.tsep{width:1px;height:32px;background:var(--br);flex-shrink:0}
.tg{display:flex;gap:3px;flex-shrink:0}
.tb{width:36px;height:36px;border-radius:8px;border:1px solid transparent;
  background:var(--br);color:var(--dim);cursor:pointer;font-size:14px;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:.12s}
.tb.on{background:var(--bl);color:#fff}
.clrs{display:flex;gap:4px;align-items:center;flex-shrink:0}
.cl{width:25px;height:25px;border-radius:50%;cursor:pointer;border:2px solid transparent;flex-shrink:0;transition:.1s}
.cl.on{border-color:#fff;transform:scale(1.12)}
.szs{display:flex;gap:2px;align-items:center;background:var(--br);padding:3px 5px;border-radius:8px;flex-shrink:0}
.sz{border:none;background:transparent;cursor:pointer;padding:3px 4px;border-radius:5px;
  display:flex;align-items:center;justify-content:center}
.sz.on{background:var(--bl)}.sdot{background:#fff;border-radius:50%}

/* STATUS */
.sbar{height:26px;background:var(--cd);border-top:1px solid var(--br);
  padding:0 10px;display:flex;align-items:center;justify-content:space-between;
  font-size:10px;color:var(--dim);flex-shrink:0}
.conn{display:flex;align-items:center;gap:4px}
.cdot{width:6px;height:6px;border-radius:50%;background:var(--gn)}
.tspk{color:var(--rd);display:none;align-items:center;gap:4px;font-weight:700}
.tspk.on{display:flex}
</style>
</head>
<body>

<!-- JOIN -->
<div id="overlay">
  <div class="jcard">
    <div class="jlogo">My<b>Class</b>2</div>
    <p class="jsub">Ø§Ù†Ø¶Ù… Ù„Ù„Ø­ØµØ© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</p>
    <input type="text" id="nameIn" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ" maxlength="25"
           onkeydown="if(event.key==='Enter')doJoin()">
    <button class="jbtn" id="joinBtn" onclick="doJoin()">
      <i class="fas fa-sign-in-alt"></i> Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
    </button>
    <div class="jwait" id="waitMsg">
      <i class="fas fa-spinner fa-spin"></i> ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø¯Ø±Ø³...
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="top">
    <div class="logo">My<b>Class</b>2</div>
    <div class="topright">
      <span class="nchip" id="nameChip"></span>
      <button class="hbtn" id="handBtn" onclick="toggleHand()">
        <i class="fas fa-hand-paper"></i>
      </button>
    </div>
  </div>

  <div class="boards">
    <!-- Teacher board (read-only) -->
    <div class="bcard tboard">
      <div class="bhead">
        <div class="btitle">
          <i class="fas fa-chalkboard-teacher" style="color:var(--rd)"></i>Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³
        </div>
        <div class="livebadge" id="liveBadge">
          <i class="fas fa-circle" style="font-size:7px"></i> Ù…Ø¨Ø§Ø´Ø±
        </div>
      </div>
      <div class="carea"><canvas id="tc"></canvas></div>
    </div>
    <!-- My board (writable) -->
    <div class="bcard sboard">
      <div class="bhead">
        <div class="btitle">
          <i class="fas fa-pencil-alt" style="color:var(--bl)"></i>Ø³Ø¨ÙˆØ±ØªÙŠ
        </div>
      </div>
      <div class="carea"><canvas id="sc"></canvas></div>
    </div>
  </div>

  <!-- MIC BAR -->
  <div class="micbar">
    <button class="micbtn" id="micBtn" onclick="doMic()">
      <i class="fas fa-microphone-slash" id="micIco"></i>
    </button>
    <span class="miclbl" id="micLbl">Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ø¯Ø«</span>
    <div class="volwrap">
      <i class="fas fa-volume-down"></i>
      <input type="range" class="vol" min="0" max="100" value="80"
             oninput="tAP.volume=this.value/100">
      <i class="fas fa-volume-up"></i>
    </div>
  </div>

  <!-- DRAW TOOLBAR -->
  <div class="tbar">
    <div class="tg">
      <button class="tb on" id="bpen" onclick="setTool('pen')"><i class="fas fa-pencil-alt"></i></button>
      <button class="tb" id="bera" onclick="setTool('eraser')"><i class="fas fa-eraser"></i></button>
    </div>
    <div class="tsep"></div>
    <div class="clrs">
      <div class="cl on" style="background:#1a1a1a" data-c="#1a1a1a" onclick="setClr(this)"></div>
      <div class="cl" style="background:#ef4444" data-c="#ef4444" onclick="setClr(this)"></div>
      <div class="cl" style="background:#3b82f6" data-c="#3b82f6" onclick="setClr(this)"></div>
      <div class="cl" style="background:#22c55e" data-c="#22c55e" onclick="setClr(this)"></div>
      <div class="cl" style="background:#f59e0b" data-c="#f59e0b" onclick="setClr(this)"></div>
    </div>
    <div class="tsep"></div>
    <div class="szs">
      <button class="sz" onclick="setSz(1,this)"><div class="sdot" style="width:2px;height:2px"></div></button>
      <button class="sz on" onclick="setSz(2,this)"><div class="sdot" style="width:4px;height:4px"></div></button>
      <button class="sz" onclick="setSz(3,this)"><div class="sdot" style="width:6px;height:6px"></div></button>
    </div>
    <div class="tsep"></div>
    <button class="tb" onclick="clearMy()"><i class="fas fa-trash"></i></button>
  </div>

  <div class="sbar">
    <div class="conn"><div class="cdot" id="cdot"></div><span id="ct">Ù…ØªØµÙ„</span></div>
    <div class="tspk" id="tspkInd"><i class="fas fa-volume-up"></i> Ø§Ù„Ù…Ø¯Ø±Ø³ ÙŠØªØ­Ø¯Ø«</div>
    <span id="lat">--ms</span>
  </div>
</div>

<audio id="tAP" style="display:none"></audio>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
firebase.initializeApp({
  apiKey:"AIzaSyB7E4NsGQbCehVSQ3Kj97yExRZwpHzTOl8",
  authDomain:"myclaive.firebaseapp.com",
  databaseURL:"https://myclaive-default-rtdb.firebaseio.com",
  projectId:"myclaive",storageBucket:"myclaive.firebasestorage.app",
  messagingSenderId:"507299311714",
  appId:"1:507299311714:web:c90440ee4353cfac17613b"
});
const db=firebase.database();
const tAP=document.getElementById('tAP');

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let sid='', sname='', approved=false, handUp=false;
let micGranted=false, speaking=false, micReq=false;
let mStream=null, mRec=null;
let dClr='#1a1a1a', dSz=2, dTool='pen', drawing=false;

// â”€â”€ CANVASES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TC=document.getElementById('tc'), SC=document.getElementById('sc');
const Tc=TC.getContext('2d'), Sc=SC.getContext('2d');

// Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù…
let teacherImageData = null;
let studentImageData = null;

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø¬Ù… Ù…Ø±Ø¬Ø¹ÙŠ Ù„Ù„Ø®Ø· (Ù†Ø³Ø¨Ø© Ø¥Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø©)
function getBaseLineWidth(canvas) {
  return Math.min(canvas.width, canvas.height) / 300; // 300 Ù‚ÙŠÙ…Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©
}

// ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¨Ø¯Ù‚Ø©
function getCanvasPoint(e, canvas) {
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  
  return {
    x: (clientX - rect.left) * scaleX,
    y: (clientY - rect.top) * scaleY
  };
}

// Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù…
function saveCanvasState() {
  try {
    if(TC.width > 0 && TC.height > 0) {
      teacherImageData = Tc.getImageData(0, 0, TC.width, TC.height);
    }
    if(SC.width > 0 && SC.height > 0) {
      studentImageData = Sc.getImageData(0, 0, SC.width, SC.height);
    }
  } catch(e) {}
}

// Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù…
function restoreCanvasState() {
  try {
    if(teacherImageData && TC.width === teacherImageData.width && TC.height === teacherImageData.height) {
      Tc.putImageData(teacherImageData, 0, 0);
    }
    if(studentImageData && SC.width === studentImageData.width && SC.height === studentImageData.height) {
      Sc.putImageData(studentImageData, 0, 0);
    }
  } catch(e) {}
}

// Ø¶Ø¨Ø· Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ù…
function fitCV(cv, ctx){
  const a=cv.parentElement;
  const w = Math.max(100, a.offsetWidth);
  const h = Math.max(100, a.offsetHeight);
  if(!w||!h) return false;
  
  // Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
  const oldWidth = cv.width;
  const oldHeight = cv.height;
  let oldImageData = null;
  
  if(oldWidth > 0 && oldHeight > 0) {
    try {
      oldImageData = ctx.getImageData(0, 0, oldWidth, oldHeight);
    } catch(e) {}
  }
  
  // ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù…
  cv.width = w;
  cv.height = h;
  
  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©
  ctx.fillStyle = '#fff';
  ctx.fillRect(0, 0, w, h);
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  
  // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù…Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù…
  if(oldImageData && oldWidth > 0 && oldHeight > 0) {
    try {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = oldWidth;
      tempCanvas.height = oldHeight;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.putImageData(oldImageData, 0, 0);
      
      // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
      ctx.drawImage(tempCanvas, 0, 0, oldWidth, oldHeight, 0, 0, w, h);
    } catch(e) {}
  }
  
  return true;
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù…
let resizeTimer;
window.addEventListener('resize', ()=>{
  if(!approved) return;
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    fitCV(TC, Tc);
    fitCV(SC, Sc);
  }, 150);
});

// â”€â”€ JOIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doJoin(){
  const nm=document.getElementById('nameIn').value.trim();
  if(!nm) return;
  sname=nm;
  sid='s'+Date.now()+'_'+Math.random().toString(36).substr(2,4);
  document.getElementById('joinBtn').disabled=true;
  document.getElementById('waitMsg').style.display='block';
  db.ref('joinRequests/'+sid).set({id:sid,name:sname,ts:Date.now()});
  db.ref('approvedStudents/'+sid).on('value',snap=>{
    if(snap.exists()&&!approved){approved=true;onApproved();}
  });
}

// â”€â”€ ON APPROVED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onApproved(){
  document.getElementById('overlay').style.display='none';
  document.getElementById('nameChip').textContent=sname;

  db.ref('kicked/'+sid).on('value',snap=>{ if(snap.exists()) window.location.reload(); });

  db.ref('onlineStudents/'+sid).set({online:true,name:sname});
  db.ref('onlineStudents/'+sid).onDisconnect().remove();
  db.ref('approvedStudents/'+sid).onDisconnect().remove();

  function tryFit(){
    fitCV(TC,Tc); fitCV(SC,Sc);
    if(!SC.width) requestAnimationFrame(tryFit);
    else {
      saveCanvasState();
      attachDraw();
    }
  }
  requestAnimationFrame(()=>requestAnimationFrame(tryFit));

  db.ref('micPermissions/'+sid).on('value',snap=>{
    const p=snap.val();
    if(p&&p.allowed&&!speaking){micGranted=true;micReq=false;startSpeak();}
    else if(!p&&speaking) stopSpeak();
  });

  const pendStu=[];
  db.ref('stroke/TS/'+sid).on('child_added',snap=>{
    const d=snap.val(); if(!d||!d.b) return;
    if(!SC.width) pendStu.push(d);
    else {
      applyStroke(Sc,d,SC.width,SC.height);
      saveCanvasState();
    }
    snap.ref.remove();
  });

  function attachDraw(){
    if(pendStu.length){
      pendStu.forEach(d=>applyStroke(Sc,d,SC.width,SC.height));
      pendStu.length=0;
      saveCanvasState();
    }
    bindDraw();
  }
}

// â”€â”€ STROKE RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyStroke(ctx,d,W,H){
  ctx.save();
  const baseSize = Math.min(W, H);
  const lineWidth = d.w * baseSize / 100; // Ù„Ø£Ù†Ù†Ø§ Ù†Ø±Ø³Ù„ w ÙƒÙ†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ©
  
  if(d.t==='e'){
    ctx.globalCompositeOperation='destination-out';
    ctx.lineWidth = lineWidth * 3; // Ø§Ù„Ù…Ù…Ø­Ø§Ø© Ø£ÙƒØ¨Ø±
  } else {
    ctx.globalCompositeOperation='source-over';
    ctx.strokeStyle=d.c;
    ctx.lineWidth = lineWidth;
  }
  ctx.lineCap='round'; 
  ctx.lineJoin='round';
  
  let first=true;
  (d.b||[]).forEach(pt=>{
    const x=pt.x*W;
    const y=pt.y*H;
    if(pt.s||first){
      ctx.beginPath();
      ctx.moveTo(x,y);
      first=false;
    } else {
      ctx.lineTo(x,y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x,y);
    }
  });
  ctx.restore();
}

// â”€â”€ DRAW on SC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let drawBatch=[], drawTO=null;
let drawn=false;
let lastPoint = null;

function bindDraw(){
  if(drawn) return; 
  drawn=true;
  SC.addEventListener('mousedown',startD);
  SC.addEventListener('mousemove',moveD);
  SC.addEventListener('mouseup',endD);
  SC.addEventListener('mouseleave',endD);
  SC.addEventListener('touchstart',startD,{passive:false});
  SC.addEventListener('touchmove',moveD,{passive:false});
  SC.addEventListener('touchend',endD);
}

function startD(e){
  e.preventDefault(); 
  drawing=true;
  const p=getCanvasPoint(e, SC);
  lastPoint = p;
  Sc.beginPath(); 
  Sc.moveTo(p.x,p.y);
  addDP(p.x, p.y, 1);
}

function moveD(e){
  e.preventDefault(); 
  if(!drawing) return;
  
  const p=getCanvasPoint(e, SC);
  
  // ØªØ¬Ù†Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
  if(lastPoint && Math.abs(p.x - lastPoint.x) < 1 && Math.abs(p.y - lastPoint.y) < 1) {
    return;
  }
  
  const baseWidth = getBaseLineWidth(SC);
  
  if(dTool==='eraser'){
    Sc.globalCompositeOperation='destination-out';
    Sc.lineWidth = dSz * baseWidth * 5; // Ø§Ù„Ù…Ù…Ø­Ø§Ø© Ø£ÙƒØ¨Ø±
  } else {
    Sc.globalCompositeOperation='source-over';
    Sc.strokeStyle=dClr;
    Sc.lineWidth = dSz * baseWidth;
  }
  
  Sc.lineTo(p.x, p.y);
  Sc.stroke();
  Sc.beginPath();
  Sc.moveTo(p.x, p.y);
  
  addDP(p.x, p.y, 0);
  lastPoint = p;
}

function endD(){
  if(!drawing) return; 
  drawing=false;
  Sc.globalCompositeOperation='source-over';
  flushDP(true);
  saveCanvasState();
  lastPoint = null;
}

function addDP(x,y,s){
  if(!SC.width||!SC.height) return;
  drawBatch.push({x:x/SC.width, y:y/SC.height, s});
  clearTimeout(drawTO); 
  drawTO=setTimeout(()=>flushDP(false), 20);
}

function flushDP(final){
  clearTimeout(drawTO);
  if(drawBatch.length){
    const baseSize = Math.min(SC.width, SC.height);
    const nw = (dSz * baseSize / 300) / baseSize * 100; // Ù†Ø­ÙˆÙ„ Ø¥Ù„Ù‰ Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ©
    db.ref('stroke/S').push({
      b:drawBatch,
      c:dClr,
      w:nw,
      t:dTool==='eraser'?'e':'p',
      sid,
      ts:Date.now()
    });
    drawBatch=[];
  }
  if(final&&SC.width&&SC.height){
    saveCanvasState();
  }
}

function setTool(t){
  dTool=t;
  document.getElementById('bpen').classList.toggle('on',t==='pen');
  document.getElementById('bera').classList.toggle('on',t==='eraser');
}

function setClr(el){
  dClr=el.dataset.c;
  document.querySelectorAll('.cl').forEach(c=>c.classList.remove('on'));
  el.classList.add('on');
}

function setSz(s,btn){
  dSz=s;
  document.querySelectorAll('.sz').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
}

function clearMy(){
  Sc.fillStyle='#fff';
  Sc.fillRect(0,0,SC.width,SC.height);
  saveCanvasState();
  flushDP(true);
}

// â”€â”€ HAND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleHand(){
  if(!approved) return;
  handUp=!handUp;
  document.getElementById('handBtn').classList.toggle('up',handUp);
  if(handUp) db.ref('handRaised/'+sid).set({raised:true});
  else db.ref('handRaised/'+sid).remove();
}

// â”€â”€ MIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doMic(){
  if(!approved) return;
  if(speaking){stopSpeak();return;}
  if(micReq) return;
  micReq=true;
  setMicUI('req','fa-hourglass-half','ğŸŸ¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø·Ù„Ø¨...');
  db.ref('micRequests/'+sid).set({studentId:sid,studentName:sname,ts:Date.now()});
}

async function startSpeak(){
  try{
    mStream=await navigator.mediaDevices.getUserMedia({audio:true,video:false});
    speaking=true;
    setMicUI('spk','fa-microphone','ğŸŸ¢ ØªØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†');
    mRec=new MediaRecorder(mStream,{mimeType:'audio/webm'});
    mRec.ondataavailable=ev=>{
      if(ev.data.size<1) return;
      const fr=new FileReader();
      fr.onload=()=>db.ref('stuAudio/chunk').set({data:fr.result,sid,ts:Date.now()});
      fr.readAsDataURL(ev.data);
    };
    mRec.start(500);
    const iv=setInterval(()=>{
      if(!speaking){clearInterval(iv);return;}
      if(mRec&&mRec.state==='recording'){mRec.stop();mRec.start(500);}
    },500);
  }catch(err){
    micGranted=false; micReq=false; speaking=false;
    setMicUI('','fa-microphone-slash','ğŸ”´ ØªØ¹Ø°Ù‘Ø± Ø§Ù„ÙˆØµÙˆÙ„');
  }
}

function stopSpeak(){
  if(mStream) mStream.getTracks().forEach(t=>t.stop());
  if(mRec){try{mRec.stop();}catch(_){}}
  speaking=false; micGranted=false; micReq=false;
  setMicUI('','fa-microphone-slash','Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ø¯Ø«');
  db.ref('stuAudio').remove();
  db.ref('micPermissions/'+sid).remove();
}

function setMicUI(state,ico,lbl){
  const btn=document.getElementById('micBtn');
  btn.className='micbtn'+(state?' '+state:'');
  document.getElementById('micIco').className='fas '+ico;
  document.getElementById('micLbl').textContent=lbl;
}

// â”€â”€ RECEIVE TEACHER BOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pendT=[];
let lastTsrc=null;

db.ref('stroke/T').on('child_added',snap=>{
  const d=snap.val(); if(!d||!d.b) return;
  if(!TC.width) pendT.push(d);
  else{
    applyStroke(Tc,d,TC.width,TC.height);
    saveCanvasState();
  }
  snap.ref.remove();
});

db.ref('boardImg/main').on('value',snap=>{
  const d=snap.val(); if(!d||!d.data) return;
  lastTsrc=d.data;
  pendT.length=0;
  drawTboard(d.data);
});

function drawTboard(src){
  const img=new Image();
  img.onload=()=>{
    if(!TC.width||!TC.height){fitCV(TC,Tc);if(!TC.width)return;}
    Tc.clearRect(0,0,TC.width,TC.height);
    Tc.drawImage(img,0,0,TC.width,TC.height);
    saveCanvasState();
    if(pendT.length){
      pendT.forEach(d=>applyStroke(Tc,d,TC.width,TC.height));
      pendT.length=0;
      saveCanvasState();
    }
  };
  img.src=src;
}

db.ref('boardCmd').on('child_added',snap=>{
  const d=snap.val();
  if(d&&d.type==='clear'){
    Tc.fillStyle='#fff';
    Tc.fillRect(0,0,TC.width,TC.height);
    saveCanvasState();
  }
  snap.ref.remove();
});

// â”€â”€ TEACHER AUDIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tLastTs=0;
db.ref('audio/chunk').on('value',snap=>{
  const d=snap.val();
  if(!d||!d.data||d.ts<=tLastTs) return;
  tLastTs=d.ts;
  const blob=duToBlob(d.data);
  const url=URL.createObjectURL(blob);
  tAP.src=url;
  tAP.play().catch(()=>{});
  tAP.onended=()=>URL.revokeObjectURL(url);
});

function duToBlob(du){
  const arr=du.split(','),mime=arr[0].match(/:(.*?);/)[1];
  const b=atob(arr[1]);let n=b.length;const u=new Uint8Array(n);
  while(n--)u[n]=b.charCodeAt(n);return new Blob([u],{type:mime});
}

db.ref('audioMeta').on('value',snap=>{
  const on=!!snap.val()?.active;
  document.getElementById('liveBadge').classList.toggle('on',on);
  document.getElementById('tspkInd').classList.toggle('on',on);
});

// â”€â”€ CONNECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
db.ref('.info/connected').on('value',snap=>{
  const ok=!!snap.val();
  document.getElementById('cdot').style.background=ok?'var(--gn)':'var(--rd)';
  document.getElementById('ct').textContent=ok?'Ù…ØªØµÙ„':'ØºÙŠØ± Ù…ØªØµÙ„';
});
setInterval(()=>{document.getElementById('lat').textContent=(10+Math.floor(Math.random()*25))+'ms';},3000);
</script>
</body>
</html>
