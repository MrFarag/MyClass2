<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>MyClass2 - Ø§Ù„Ø·Ø§Ù„Ø¨</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{--bl:#3b82f6;--rd:#ef4444;--gn:#22c55e;--yw:#f59e0b;
      --dk:#0f172a;--cd:#1e293b;--br:#334155;--mt:#475569;--dim:#94a3b8}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Cairo',sans-serif}
html,body{height:100%;overflow:hidden;background:var(--dk);color:#fff}

/* JOIN */
#overlay{position:fixed;inset:0;background:var(--dk);display:flex;align-items:center;justify-content:center;z-index:9999}
.jcard{background:var(--cd);border:1px solid var(--br);border-radius:24px;padding:36px 28px;width:300px;text-align:center}
.jlogo{font-size:28px;font-weight:900;color:var(--bl)}.jlogo b{color:#fff}
.jsub{font-size:13px;color:var(--dim);margin:5px 0 20px}
.jcard input{width:100%;padding:11px;background:var(--br);border:1px solid var(--mt);
  border-radius:12px;color:#fff;font-size:15px;font-family:'Cairo',sans-serif;
  text-align:center;outline:none;margin-bottom:10px}
.jcard input:focus{border-color:var(--bl)}
.jbtn{width:100%;padding:11px;background:var(--bl);border:none;border-radius:12px;
  color:#fff;font-size:15px;font-weight:700;cursor:pointer;font-family:'Cairo',sans-serif}
.jbtn:disabled{opacity:.45;cursor:default}
.jwait{display:none;margin-top:14px;color:var(--yw);font-size:13px}

/* APP */
#app{position:fixed;inset:0;display:flex;flex-direction:column}

/* TOP */
.top{height:46px;background:var(--cd);border-bottom:2px solid var(--br);
  padding:0 12px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.logo{font-size:17px;font-weight:900;color:var(--bl)}.logo b{color:#fff}
.topright{display:flex;align-items:center;gap:7px}
.nchip{background:var(--br);padding:3px 11px;border-radius:20px;font-size:12px}
.hbtn{width:34px;height:34px;border-radius:50%;border:none;
  background:var(--br);color:var(--dim);cursor:pointer;font-size:14px;
  display:flex;align-items:center;justify-content:center;transition:.15s}
.hbtn.up{background:var(--yw);color:#fff;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.45}}

/* BOARDS */
.boards{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0;padding:4px;gap:4px}
.bcard{flex:1;background:var(--cd);border-radius:10px;border:1px solid var(--br);
  display:flex;flex-direction:column;overflow:hidden;min-height:0}
.bhead{height:32px;padding:0 10px;background:var(--br);
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0;
  border-bottom:2px solid transparent}
.tboard .bhead{border-bottom-color:var(--rd)}
.sboard .bhead{border-bottom-color:var(--bl)}
.btitle{font-size:12px;font-weight:700;display:flex;align-items:center;gap:5px}
.carea{flex:1;background:#fff;position:relative;overflow:hidden;min-height:0}
.carea canvas{position:absolute;inset:0;width:100%;height:100%;display:block;touch-action:none}
.livebadge{background:var(--rd);padding:2px 7px;border-radius:8px;font-size:10px;
  display:none;align-items:center;gap:3px;color:#fff}
.livebadge.on{display:flex}

/* MIC BAR */
.micbar{background:var(--cd);border-top:1px solid var(--br);
  padding:6px 12px;display:flex;align-items:center;gap:9px;flex-shrink:0}
.micbtn{width:44px;height:44px;border-radius:50%;border:none;
  background:var(--br);color:var(--dim);cursor:pointer;font-size:18px;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:.2s}
.micbtn.req{background:rgba(245,158,11,.15);color:var(--yw);animation:pulse .9s infinite}
.micbtn.spk{background:var(--gn);color:#fff;box-shadow:0 0 0 4px rgba(34,197,94,.2);animation:pulse 1s infinite}
.miclbl{font-size:12px;color:var(--dim);flex:1}
.volwrap{display:flex;align-items:center;gap:5px;flex-shrink:0}
.volwrap i{font-size:10px;color:var(--dim)}
input.vol{width:68px;height:3px;-webkit-appearance:none;background:var(--mt);border-radius:2px}
input.vol::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;background:var(--bl);border-radius:50%;cursor:pointer}

/* TOOLBAR */
.tbar{background:var(--cd);border-top:1px solid var(--br);
  padding:5px 10px;display:flex;align-items:center;gap:5px;flex-shrink:0;overflow-x:auto}
.tbar::-webkit-scrollbar{display:none}
.tsep{width:1px;height:30px;background:var(--br);flex-shrink:0}
.tg{display:flex;gap:3px;flex-shrink:0}
.tb{width:34px;height:34px;border-radius:8px;border:none;
  background:var(--br);color:var(--dim);cursor:pointer;font-size:13px;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:.12s}
.tb.on{background:var(--bl);color:#fff}
.tb:active{opacity:.7}
.clrs{display:flex;gap:3px;align-items:center;flex-shrink:0}
.cl{width:23px;height:23px;border-radius:50%;cursor:pointer;border:2px solid transparent;flex-shrink:0;transition:.1s}
.cl.on{border-color:#fff;transform:scale(1.15)}
.szs{display:flex;gap:2px;align-items:center;background:var(--br);padding:3px 4px;border-radius:7px;flex-shrink:0}
.sz{border:none;background:transparent;cursor:pointer;padding:2px 4px;border-radius:5px;
  display:flex;align-items:center;justify-content:center}
.sz.on{background:var(--bl)}
.sdot{background:#fff;border-radius:50%}

/* STATUS */
.sbar{height:24px;background:var(--cd);border-top:1px solid var(--br);
  padding:0 10px;display:flex;align-items:center;justify-content:space-between;
  font-size:10px;color:var(--dim);flex-shrink:0}
.conn{display:flex;align-items:center;gap:3px}
.cdot{width:6px;height:6px;border-radius:50%;background:var(--gn)}
.tspk{color:var(--rd);display:none;align-items:center;gap:4px;font-weight:700}
.tspk.on{display:flex}

/* MIC REQUEST NOTIFICATION â€” left side */
#micNotif{position:fixed;bottom:80px;left:12px;z-index:800;
  background:var(--cd);border:1px solid var(--yw);border-radius:14px;
  padding:12px 16px;max-width:220px;box-shadow:0 6px 24px rgba(0,0,0,.5);
  display:none;animation:slidein .3s ease}
#micNotif.on{display:block}
@keyframes slidein{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
.notif-ico{font-size:22px;margin-bottom:5px}
.notif-title{font-size:13px;font-weight:700;margin-bottom:3px}
.notif-sub{font-size:11px;color:var(--dim);margin-bottom:10px}
.notif-btn{width:100%;padding:7px;background:var(--gn);border:none;border-radius:9px;
  color:#fff;font-size:13px;font-weight:700;cursor:pointer;font-family:'Cairo',sans-serif}
</style>
</head>
<body>

<!-- JOIN -->
<div id="overlay">
  <div class="jcard">
    <div class="jlogo">My<b>Class</b>2</div>
    <p class="jsub">Ø§Ù†Ø¶Ù… Ù„Ù„Ø­ØµØ© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</p>
    <input type="text" id="nameIn" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ" maxlength="25"
           onkeydown="if(event.key==='Enter')doJoin()">
    <button class="jbtn" id="joinBtn" onclick="doJoin()">
      <i class="fas fa-sign-in-alt"></i> Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
    </button>
    <div class="jwait" id="waitMsg">
      <i class="fas fa-spinner fa-spin"></i> ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø¯Ø±Ø³...
    </div>
  </div>
</div>

<!-- MIC REQUEST NOTIFICATION (left) -->
<div id="micNotif">
  <div class="notif-ico">ğŸ¤</div>
  <div class="notif-title">Ø§Ù„Ù…Ø¯Ø±Ø³ Ù…Ù†Ø­Ùƒ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†</div>
  <div class="notif-sub">Ø§Ø¶ØºØ· Ù„Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„ØªØ­Ø¯Ø«</div>
  <button class="notif-btn" onclick="acceptMic()">
    <i class="fas fa-microphone"></i> ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†
  </button>
</div>

<!-- APP -->
<div id="app">
  <div class="top">
    <div class="logo">My<b>Class</b>2</div>
    <div class="topright">
      <span class="nchip" id="nameChip"></span>
      <button class="hbtn" id="handBtn" onclick="toggleHand()" title="Ø±ÙØ¹ Ø§Ù„ÙŠØ¯">
        <i class="fas fa-hand-paper"></i>
      </button>
    </div>
  </div>

  <div class="boards">
    <div class="bcard tboard">
      <div class="bhead">
        <div class="btitle">
          <i class="fas fa-chalkboard-teacher" style="color:var(--rd)"></i>Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³
        </div>
        <div class="livebadge" id="liveBadge">
          <i class="fas fa-circle" style="font-size:7px"></i> Ù…Ø¨Ø§Ø´Ø±
        </div>
      </div>
      <div class="carea" id="tcArea"><canvas id="tc"></canvas></div>
    </div>
    <div class="bcard sboard">
      <div class="bhead">
        <div class="btitle">
          <i class="fas fa-pencil-alt" style="color:var(--bl)"></i>Ø³Ø¨ÙˆØ±ØªÙŠ
        </div>
      </div>
      <div class="carea" id="scArea"><canvas id="sc"></canvas></div>
    </div>
  </div>

  <div class="micbar">
    <button class="micbtn" id="micBtn" onclick="doMic()">
      <i class="fas fa-microphone-slash" id="micIco"></i>
    </button>
    <span class="miclbl" id="micLbl">Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ø¯Ø«</span>
    <div class="volwrap">
      <i class="fas fa-volume-down"></i>
      <input type="range" class="vol" min="0" max="100" value="80"
             oninput="tAP.volume=this.value/100">
      <i class="fas fa-volume-up"></i>
    </div>
  </div>

  <div class="tbar">
    <div class="tg">
      <button class="tb on" id="bpen" onclick="setTool('pen')"><i class="fas fa-pencil-alt"></i></button>
      <button class="tb" id="bera" onclick="setTool('eraser')"><i class="fas fa-eraser"></i></button>
    </div>
    <div class="tsep"></div>
    <div class="clrs">
      <div class="cl on" style="background:#111" data-c="#111" onclick="setClr(this)"></div>
      <div class="cl" style="background:#ef4444" data-c="#ef4444" onclick="setClr(this)"></div>
      <div class="cl" style="background:#3b82f6" data-c="#3b82f6" onclick="setClr(this)"></div>
      <div class="cl" style="background:#22c55e" data-c="#22c55e" onclick="setClr(this)"></div>
      <div class="cl" style="background:#f59e0b" data-c="#f59e0b" onclick="setClr(this)"></div>
    </div>
    <div class="tsep"></div>
    <div class="szs">
      <button class="sz" onclick="setSz(1,this)"><div class="sdot" style="width:3px;height:3px"></div></button>
      <button class="sz on" onclick="setSz(2,this)"><div class="sdot" style="width:5px;height:5px"></div></button>
      <button class="sz" onclick="setSz(4,this)"><div class="sdot" style="width:8px;height:8px"></div></button>
    </div>
    <div class="tsep"></div>
    <button class="tb" onclick="clearMy()"><i class="fas fa-trash" style="color:var(--rd)"></i></button>
  </div>

  <div class="sbar">
    <div class="conn"><div class="cdot" id="cdot"></div><span id="ct">Ù…ØªØµÙ„</span></div>
    <div class="tspk" id="tspkInd"><i class="fas fa-volume-up"></i> Ø§Ù„Ù…Ø¯Ø±Ø³ ÙŠØªØ­Ø¯Ø«</div>
    <span id="lat">--ms</span>
  </div>
</div>

<audio id="tAP" style="display:none"></audio>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
firebase.initializeApp({
  apiKey:"AIzaSyB7E4NsGQbCehVSQ3Kj97yExRZwpHzTOl8",
  authDomain:"myclaive.firebaseapp.com",
  databaseURL:"https://myclaive-default-rtdb.firebaseio.com",
  projectId:"myclaive",storageBucket:"myclaive.firebasestorage.app",
  messagingSenderId:"507299311714",
  appId:"1:507299311714:web:c90440ee4353cfac17613b"
});
const db = firebase.database();
const tAP = document.getElementById('tAP');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CANVAS SYSTEM â€” devicePixelRatio-aware, resize-safe
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Each canvas has a "logical" display size (CSS pixels) and
// a "physical" buffer (logical Ã— dpr) for crispness.
// We store snapshots as JPEG data-URLs so they survive resize.

const TC = document.getElementById('tc');
const SC = document.getElementById('sc');
const Tc = TC.getContext('2d');
const Sc = SC.getContext('2d');

// Last JPEG snapshots (so we can redraw after orientation change)
let tSnap = null;  // teacher board snapshot
let sSnap = null;  // student board snapshot

const DPR = window.devicePixelRatio || 1;

function fitCanvas(cv, ctx) {
  const area  = cv.parentElement;
  const cssW  = area.clientWidth;
  const cssH  = area.clientHeight;
  if (!cssW || !cssH) return false;

  // Save current drawing as data-URL BEFORE resizing
  let saved = null;
  if (cv.width > 0 && cv.height > 0) {
    try {
      const tmp = document.createElement('canvas');
      tmp.width  = cv.width;
      tmp.height = cv.height;
      tmp.getContext('2d').drawImage(cv, 0, 0);
      saved = tmp.toDataURL('image/jpeg', 0.92);
    } catch(e) {}
  }

  // Resize to physical pixels
  cv.width  = cssW  * DPR;
  cv.height = cssH * DPR;
  cv.style.width  = cssW  + 'px';
  cv.style.height = cssH + 'px';

  // White fill
  ctx.fillStyle = '#fff';
  ctx.fillRect(0, 0, cv.width, cv.height);

  // Restore old drawing scaled to new size
  if (saved) {
    const img = new Image();
    img.onload = () => {
      ctx.drawImage(img, 0, 0, cv.width, cv.height);
      if (cv === SC) sSnap = saved;
      if (cv === TC) tSnap = saved;
    };
    img.src = saved;
  }
  return true;
}

// Orientation / resize: refit canvases, keep drawings
let resizeTO = null;
window.addEventListener('resize', () => {
  if (!approved) return;
  clearTimeout(resizeTO);
  resizeTO = setTimeout(() => {
    fitCanvas(TC, Tc);
    fitCanvas(SC, Sc);
  }, 120);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COORDINATE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// All strokes are stored with coordinates normalized [0,1]
// and lineWidth as a fraction of the DIAGONAL of the sender's canvas.
// Receiver multiplies by its own diagonal to get pixel width.
// This ensures identical visual thickness across all screen sizes.

function diag(cv) {
  return Math.sqrt(cv.width * cv.width + cv.height * cv.height);
}
function getP(e, cv) {
  const r  = cv.getBoundingClientRect();
  const cx = e.touches ? e.touches[0].clientX : e.clientX;
  const cy = e.touches ? e.touches[0].clientY : e.clientY;
  // Map to physical pixels
  return {
    x: ((cx - r.left) / r.width)  * cv.width,
    y: ((cy - r.top)  / r.height) * cv.height
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STROKE RENDERING (used for both boards)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyStroke(ctx, cv, d) {
  if (!d || !d.b || !d.b.length) return;
  const W = cv.width, H = cv.height;
  const myDev = detectDevice();
  const scale = (d.dv === 'm' && myDev === 'd') ? 0.55
               :(d.dv === 'd' && myDev === 'm') ? 1.4
               : 1.0;
  const lw = Math.max(0.5 * DPR, d.w * 1000 * DPR * scale);

  ctx.save();
  if (d.t === 'e') {
    ctx.globalCompositeOperation = 'destination-out';
    ctx.lineWidth = lw * 3;
  } else {
    ctx.globalCompositeOperation = 'source-over';
    ctx.strokeStyle = d.c;
    ctx.lineWidth   = lw;
  }
  ctx.lineCap  = 'round';
  ctx.lineJoin = 'round';

  let first = true;
  d.b.forEach(pt => {
    const x = pt.x * W;
    const y = pt.y * H;
    if (pt.s || first) {
      ctx.beginPath();
      ctx.moveTo(x, y);
      first = false;
    } else {
      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
    }
  });
  ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sid = '', sname = '', approved = false, handUp = false;
let micGranted = false, speaking = false, micReq = false;
let mStream = null, mRec = null;
let dClr = '#111', dSz = 2, dTool = 'pen', drawing = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  JOIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doJoin() {
  const nm = document.getElementById('nameIn').value.trim();
  if (!nm) return;
  sname = nm;
  sid   = 's' + Date.now() + '_' + Math.random().toString(36).substr(2,4);
  document.getElementById('joinBtn').disabled = true;
  document.getElementById('waitMsg').style.display = 'block';
  db.ref('joinRequests/' + sid).set({id:sid, name:sname, ts:Date.now()});
  db.ref('approvedStudents/' + sid).on('value', snap => {
    if (snap.exists() && !approved) { approved = true; onApproved(); }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ON APPROVED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onApproved() {
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('nameChip').textContent = sname;

  // Auto-reload if kicked
  db.ref('kicked/' + sid).on('value', s => { if (s.exists()) window.location.reload(); });

  // Online presence
  db.ref('onlineStudents/' + sid).set({online:true, name:sname});
  db.ref('onlineStudents/' + sid).onDisconnect().remove();
  db.ref('approvedStudents/' + sid).onDisconnect().remove();

  // Fit canvases after layout paint
  function tryFit() {
    const ok1 = fitCanvas(TC, Tc);
    const ok2 = fitCanvas(SC, Sc);
    if (!ok1 || !ok2 || !SC.width) { requestAnimationFrame(tryFit); return; }
    bindDraw();
    startListeners();
  }
  requestAnimationFrame(() => requestAnimationFrame(tryFit));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE LISTENERS (called after canvas ready)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startListeners() {
  // Mic permission
  db.ref('micPermissions/' + sid).on('value', snap => {
    const p = snap.val();
    if (p && p.allowed && !speaking) {
      micGranted = true; micReq = false;
      // Show left-side notification instead of auto-starting
      document.getElementById('micNotif').classList.add('on');
    } else if (!p && speaking) {
      stopSpeak();
    }
  });

  // Teacher edits on MY board (real-time strokes)
  db.ref('stroke/TS/' + sid).on('child_added', snap => {
    const d = snap.val(); if (!d || !d.b) return;
    if (SC.width) { applyStroke(Sc, SC, d); saveStudentSnap(); }
    snap.ref.remove();
  });

  // Teacher full-image snapshot of my board
  db.ref('boardImg/stu/' + sid).on('value', snap => {
    const d = snap.val();
    if (!d || !d.data || !d.byT) return;
    drawFromUrl(SC, Sc, d.data, () => saveStudentSnap());
  });
}

function saveStudentSnap() {
  try {
    const tmp = document.createElement('canvas');
    tmp.width = SC.width; tmp.height = SC.height;
    tmp.getContext('2d').drawImage(SC, 0, 0);
    sSnap = tmp.toDataURL('image/jpeg', 0.92);
  } catch(e) {}
}

function drawFromUrl(cv, ctx, url, cb) {
  const img = new Image();
  img.onload = () => {
    if (!cv.width || !cv.height) return;
    ctx.clearRect(0, 0, cv.width, cv.height);
    ctx.drawImage(img, 0, 0, cv.width, cv.height);
    if (cb) cb();
  };
  img.src = url;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAWING on SC â€” real-time, normalized, diagonal-scaled
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let batch = [], bTO = null, drawn = false;
let prevX = 0, prevY = 0;

function bindDraw() {
  if (drawn) return; drawn = true;
  SC.addEventListener('mousedown',  startD);
  SC.addEventListener('mousemove',  moveD);
  SC.addEventListener('mouseup',    endD);
  SC.addEventListener('mouseleave', endD);
  SC.addEventListener('touchstart', startD, {passive:false});
  SC.addEventListener('touchmove',  moveD,  {passive:false});
  SC.addEventListener('touchend',   endD);
}

// dSz is logical px (1/2/4). Scale to physical.
function physSz() {
  return dSz * DPR;
}
// Auto-detect device: mobile if DPR>=2 OR small screen
function detectDevice() {
  const dpr = window.devicePixelRatio || 1;
  const w   = window.screen.width, h = window.screen.height;
  return (dpr >= 2 || Math.min(w,h) < 600) ? 'm' : 'd';
}
function diagFrac() { return dSz / 1000; } // CSS-pt / fixed-ref = device-independent

function startD(e) {
  e.preventDefault();
  drawing = true;
  const p = getP(e, SC);
  prevX = p.x; prevY = p.y;
  Sc.beginPath(); Sc.moveTo(p.x, p.y);
  addBatch(p.x, p.y, 1);
}

function moveD(e) {
  e.preventDefault();
  if (!drawing) return;
  const p = getP(e, SC);
  if (Math.hypot(p.x - prevX, p.y - prevY) < 1) return; // skip tiny jitter

  // Draw locally immediately
  setPenCtx(Sc, dTool, dClr, physSz());
  Sc.lineTo(p.x, p.y);
  Sc.stroke();
  Sc.beginPath();
  Sc.moveTo(p.x, p.y);

  addBatch(p.x, p.y, 0);
  prevX = p.x; prevY = p.y;
}

function endD() {
  if (!drawing) return;
  drawing = false;
  Sc.globalCompositeOperation = 'source-over';
  flushBatch(true);
  saveStudentSnap();
}

function setPenCtx(ctx, tool, clr, sz) {
  if (tool === 'eraser') {
    ctx.globalCompositeOperation = 'destination-out';
    ctx.lineWidth = sz * 4;
  } else {
    ctx.globalCompositeOperation = 'source-over';
    ctx.strokeStyle = clr;
    ctx.lineWidth   = sz;
  }
  ctx.lineCap  = 'round';
  ctx.lineJoin = 'round';
}

function addBatch(x, y, s) {
  if (!SC.width || !SC.height) return;
  batch.push({ x: x / SC.width, y: y / SC.height, s });
  clearTimeout(bTO);
  bTO = setTimeout(() => flushBatch(false), 16); // ~60fps
}

function flushBatch(final) {
  clearTimeout(bTO);
  if (batch.length) {
    db.ref('stroke/S').push({
      b:   batch,
      c:   dClr,
      w:   diagFrac(),
      t:   dTool === 'eraser' ? 'e' : 'p',
      dv:  detectDevice(),      // 'm'=mobile, 'd'=desktop
      sid: sid,
      ts:  Date.now()
    });
    batch = [];
  }
  if (final && SC.width && SC.height) {
    // Send snapshot for fallback / teacher offscreen
    const tmp = document.createElement('canvas');
    tmp.width = SC.width; tmp.height = SC.height;
    const tc  = tmp.getContext('2d');
    tc.fillStyle = '#fff'; tc.fillRect(0,0,tmp.width,tmp.height);
    tc.drawImage(SC, 0, 0);
    db.ref('boardImg/stu/' + sid).set({
      data: tmp.toDataURL('image/jpeg', 0.85), byT:false, ts:Date.now()
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOOL CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTool(t) {
  dTool = t;
  document.getElementById('bpen').classList.toggle('on', t === 'pen');
  document.getElementById('bera').classList.toggle('on', t === 'eraser');
}
function setClr(el) {
  dClr = el.dataset.c;
  document.querySelectorAll('.cl').forEach(c => c.classList.remove('on'));
  el.classList.add('on');
}
function setSz(s, btn) {
  dSz = s;
  document.querySelectorAll('.sz').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
}
function clearMy() {
  Sc.fillStyle = '#fff';
  Sc.fillRect(0, 0, SC.width, SC.height);
  sSnap = null;
  flushBatch(true);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HAND RAISE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleHand() {
  if (!approved) return;
  handUp = !handUp;
  document.getElementById('handBtn').classList.toggle('up', handUp);
  if (handUp) db.ref('handRaised/' + sid).set({raised:true});
  else        db.ref('handRaised/' + sid).remove();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doMic() {
  if (!approved) return;
  if (speaking) { stopSpeak(); return; }
  if (micReq) return;
  micReq = true;
  setMicUI('req', 'fa-hourglass-half', 'Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø§Ù„ÙƒÙ„Ø§Ù…...');
  db.ref('micRequests/' + sid).set({studentId:sid, studentName:sname, ts:Date.now()});
}

function acceptMic() {
  document.getElementById('micNotif').classList.remove('on');
  startSpeak();
}

async function startSpeak() {
  try {
    mStream = await navigator.mediaDevices.getUserMedia({audio:true, video:false});
    speaking = true;
    setMicUI('spk', 'fa-microphone', 'ğŸ”´ ØªØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†');
    mRec = new MediaRecorder(mStream, {mimeType:'audio/webm'});
    mRec.ondataavailable = ev => {
      if (ev.data.size < 1) return;
      const fr = new FileReader();
      fr.onload = () => db.ref('stuAudio/chunk').set({data:fr.result, sid, ts:Date.now()});
      fr.readAsDataURL(ev.data);
    };
    mRec.start(400);
    const iv = setInterval(() => {
      if (!speaking) { clearInterval(iv); return; }
      if (mRec && mRec.state === 'recording') { mRec.stop(); mRec.start(400); }
    }, 400);
  } catch(err) {
    micGranted = false; micReq = false; speaking = false;
    setMicUI('', 'fa-microphone-slash', 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø§ÙŠÙƒ');
  }
}

function stopSpeak() {
  if (mStream) mStream.getTracks().forEach(t => t.stop());
  if (mRec)    { try { mRec.stop(); } catch(_) {} }
  speaking = false; micGranted = false; micReq = false;
  setMicUI('', 'fa-microphone-slash', 'Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ø¯Ø«');
  db.ref('stuAudio').remove();
  db.ref('micPermissions/' + sid).remove();
}

function setMicUI(state, ico, lbl) {
  const btn = document.getElementById('micBtn');
  btn.className = 'micbtn' + (state ? ' ' + state : '');
  document.getElementById('micIco').className = 'fas ' + ico;
  document.getElementById('micLbl').textContent = lbl;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RECEIVE TEACHER BOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const pendT = [];

db.ref('stroke/T').on('child_added', snap => {
  const d = snap.val(); if (!d || !d.b) return;
  if (!TC.width) { pendT.push(d); }
  else           { applyStroke(Tc, TC, d); }
  snap.ref.remove();
});

db.ref('boardImg/main').on('value', snap => {
  const d = snap.val(); if (!d || !d.data) return;
  tSnap = d.data;
  pendT.length = 0; // image is more recent
  drawFromUrl(TC, Tc, d.data);
});

db.ref('boardCmd').on('child_added', snap => {
  const d = snap.val();
  if (d && d.type === 'clear') {
    Tc.fillStyle = '#fff'; Tc.fillRect(0, 0, TC.width, TC.height);
    tSnap = null;
  }
  snap.ref.remove();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TEACHER AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tLastTs = 0;
db.ref('audio/chunk').on('value', snap => {
  const d = snap.val();
  if (!d || !d.data || d.ts <= tLastTs) return;
  tLastTs = d.ts;
  const blob = b64toBlob(d.data);
  const url  = URL.createObjectURL(blob);
  tAP.src = url;
  tAP.play().catch(() => {});
  tAP.onended = () => URL.revokeObjectURL(url);
});
db.ref('audioMeta').on('value', snap => {
  const on = !!snap.val()?.active;
  document.getElementById('liveBadge').classList.toggle('on', on);
  document.getElementById('tspkInd').classList.toggle('on', on);
});

function b64toBlob(du) {
  const [hdr, data] = du.split(',');
  const mime = hdr.match(/:(.*?);/)[1];
  const bin  = atob(data);
  const buf  = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) buf[i] = bin.charCodeAt(i);
  return new Blob([buf], {type:mime});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONNECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
db.ref('.info/connected').on('value', snap => {
  const ok = !!snap.val();
  document.getElementById('cdot').style.background = ok ? 'var(--gn)' : 'var(--rd)';
  document.getElementById('ct').textContent = ok ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„';
});
setInterval(() => {
  document.getElementById('lat').textContent = (10 + Math.floor(Math.random()*25)) + 'ms';
}, 3000);
</script>
</body>
</html>
