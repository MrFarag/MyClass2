<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MyClass2 - Ø§Ù„Ø·Ø§Ù„Ø¨</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI',sans-serif;background:#111b27;color:#fff;display:flex;flex-direction:column}

/* HEADER */
.hdr{height:48px;min-height:48px;background:#1e2d3d;border-bottom:2px solid #3498db;display:flex;align-items:center;justify-content:space-between;padding:0 12px;flex-shrink:0}
.logo{font-size:15px;font-weight:bold;display:flex;align-items:center;gap:6px}
.logo i{color:#3498db}
.pbadge{padding:4px 10px;border-radius:20px;font-size:12px;display:flex;align-items:center;gap:5px;background:#27ae60}

/* BOARDS */
.boards{flex:1;display:flex;flex-direction:column;padding:6px;gap:6px;overflow:hidden;min-height:0}

.board{flex:1;display:flex;flex-direction:column;background:#1e2d3d;border-radius:10px;overflow:hidden;border:1px solid #2c4159;min-height:0}
.bh{padding:6px 10px;background:#243447;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.bh.t{border-bottom:3px solid #e67e22}
.bh.s{border-bottom:3px solid #27ae60}
.bt{font-size:12px;font-weight:bold;display:flex;align-items:center;gap:5px}

/* audio badge */
.abadge{background:#e67e22;padding:2px 8px;border-radius:20px;font-size:10px;display:flex;align-items:center;gap:3px;animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}

/* CANVAS */
.carea{flex:1;overflow:hidden;background:#e8e8e8;position:relative;min-height:0}
.carea canvas{display:block;width:100%;height:100%;background:#fff;touch-action:none}
#tCanvas{cursor:default;pointer-events:none}
#myCanvas{cursor:crosshair}

/* TOOLBAR */
.tb{height:56px;min-height:56px;background:#1e2d3d;border-top:2px solid #3498db;display:flex;align-items:center;justify-content:center;padding:0 8px;gap:5px;flex-shrink:0;overflow-x:auto}
.tb::-webkit-scrollbar{display:none}
.tg{display:flex;gap:3px;background:#111b27;padding:4px 6px;border-radius:20px;align-items:center;flex-shrink:0}
.cb{width:24px;height:24px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:.15s;flex-shrink:0}
.cb.active{border-color:#fff;box-shadow:0 0 6px rgba(255,255,255,.5);transform:scale(1.15)}
.tb-btn{width:34px;height:34px;border:none;border-radius:50%;background:#2c4159;color:#fff;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:.15s}
.tb-btn.active,.tb-btn:hover{background:#3498db}
.tb-btn.del{color:#e74c3c}
.tb-btn.del:hover{background:#e74c3c;color:#fff}

/* STATUS */
.sbar{height:36px;min-height:36px;background:#0e1820;border-top:1px solid #1e2d3d;display:flex;align-items:center;justify-content:space-between;padding:0 12px;font-size:12px;color:#aab8c8;flex-shrink:0}
.sdot{width:8px;height:8px;border-radius:50%}
.sdot.on{background:#27ae60;box-shadow:0 0 6px #27ae60}
.sdot.conn{background:#f39c12;animation:blink .8s infinite}
.sdot.aud{background:#e67e22;animation:blink 1s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* audio waves */
.waves{display:flex;gap:2px;align-items:center}
.waves span{display:block;width:3px;background:#e67e22;border-radius:2px;animation:wave .8s infinite}
.waves span:nth-child(1){height:6px;animation-delay:0s}
.waves span:nth-child(2){height:12px;animation-delay:.15s}
.waves span:nth-child(3){height:6px;animation-delay:.3s}
@keyframes wave{0%,100%{transform:scaleY(.5)}50%{transform:scaleY(1.2)}}
</style>
</head>
<body>

<div class="hdr">
  <div class="logo"><i class="fas fa-user-graduate"></i> MyClass2</div>
  <div class="pbadge" id="pbadge"><i class="fas fa-lock-open"></i> ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ÙƒØªØ§Ø¨Ø©</div>
</div>

<div class="boards">
  <!-- Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ -->
  <div class="board">
    <div class="bh t">
      <span class="bt"><i class="fas fa-chalkboard-teacher" style="color:#e67e22"></i> Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³</span>
      <span class="abadge" id="abadge" style="display:none"><i class="fas fa-volume-up"></i> ØµÙˆØª Ù…Ø¨Ø§Ø´Ø±</span>
    </div>
    <div class="carea" id="tArea"><canvas id="tCanvas"></canvas></div>
  </div>

  <!-- Ø³Ø¨ÙˆØ±ØªÙŠ -->
  <div class="board">
    <div class="bh s">
      <span class="bt"><i class="fas fa-pencil-alt" style="color:#27ae60"></i> Ø³Ø¨ÙˆØ±ØªÙŠ</span>
    </div>
    <div class="carea" id="myArea"><canvas id="myCanvas"></canvas></div>
  </div>
</div>

<div class="tb">
  <div class="tg">
    <div class="cb active" style="background:#111" onclick="setColor('black',this)"></div>
    <div class="cb" style="background:#e74c3c" onclick="setColor('#e74c3c',this)"></div>
    <div class="cb" style="background:#3498db" onclick="setColor('#3498db',this)"></div>
    <div class="cb" style="background:#27ae60" onclick="setColor('#27ae60',this)"></div>
    <div class="cb" style="background:#f39c12" onclick="setColor('#f39c12',this)"></div>
    <div class="cb" style="background:#fff;border:2px solid #888" onclick="setColor('#ffffff',this)"></div>
  </div>
  <div class="tg">
    <button class="tb-btn" onclick="setSize(2,this)" title="Ø±ÙÙŠØ¹"><i class="fas fa-pen"></i></button>
    <button class="tb-btn active" onclick="setSize(5,this)" title="ÙˆØ³Ø·"><i class="fas fa-pen-fancy"></i></button>
    <button class="tb-btn" onclick="setSize(12,this)" title="Ø³Ù…ÙŠÙƒ"><i class="fas fa-paint-brush"></i></button>
  </div>
  <div class="tg">
    <button class="tb-btn active" id="penBtn" onclick="setTool('pen')"><i class="fas fa-pencil-alt"></i></button>
    <button class="tb-btn" id="eraserBtn" onclick="setTool('eraser')"><i class="fas fa-eraser"></i></button>
    <button class="tb-btn del" onclick="clearMine()"><i class="fas fa-trash-alt"></i></button>
  </div>
</div>

<div class="sbar">
  <div style="display:flex;align-items:center;gap:6px">
    <span class="sdot conn" id="dotEl"></span>
    <span id="statusEl">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
  </div>
  <div style="display:flex;align-items:center;gap:6px">
    <span id="speakerEl" style="color:#e74c3c"><i class="fas fa-volume-mute"></i></span>
    <div class="waves" id="wavesEl" style="display:none"><span></span><span></span><span></span></div>
  </div>
</div>

<!-- Ø¹Ù†ØµØ± Ø§Ù„ØµÙˆØª Ù…Ø®ÙÙŠ -->
<audio id="audioEl" autoplay playsinline style="display:none"></audio>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
// â”€â”€â”€ Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
firebase.initializeApp({
  apiKey:"AIzaSyB7E4NsGQbCehVSQ3Kj97yExRZwpHzTOl8",
  authDomain:"myclaive.firebaseapp.com",
  databaseURL:"https://myclaive-default-rtdb.firebaseio.com",
  projectId:"myclaive",
  storageBucket:"myclaive.firebasestorage.app",
  messagingSenderId:"507299311714",
  appId:"1:507299311714:web:c90440ee4353cfac17613b"
});
const db = firebase.database();

// â”€â”€â”€ Canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const tCanvas  = document.getElementById('tCanvas');
const myCanvas = document.getElementById('myCanvas');
const tCtx     = tCanvas.getContext('2d');
const myCtx    = myCanvas.getContext('2d');
const tArea    = document.getElementById('tArea');
const myArea   = document.getElementById('myArea');
const W = 1600, H = 1200;

function initCanvases() {
  tCanvas.width   = W; tCanvas.height  = H;
  myCanvas.width  = W; myCanvas.height = H;
  resizeAll();
  [tCtx, myCtx].forEach(c => { c.lineCap='round'; c.lineJoin='round'; });
}
function resizeAll() {
  function r(canvas, area) {
    canvas.style.width  = area.clientWidth  + 'px';
    canvas.style.height = area.clientHeight + 'px';
  }
  r(tCanvas, tArea); r(myCanvas, myArea);
}
initCanvases();
window.addEventListener('resize', resizeAll);

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tool = 'pen', color = 'black', size = 5;
let drawing = false, lx = 0, ly = 0;
let canDraw = true;
const sid = 'stu_' + Date.now() + '_' + Math.random().toString(36).substr(2,5);

// â”€â”€â”€ Drawing helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyStroke(ctx, x1, y1, x2, y2, col, sz, erase) {
  ctx.save();
  if (erase) {
    ctx.globalCompositeOperation = 'destination-out';
    ctx.strokeStyle = 'rgba(0,0,0,1)';
    ctx.lineWidth   = 40;
  } else {
    ctx.globalCompositeOperation = 'source-over';
    ctx.strokeStyle = col;
    ctx.lineWidth   = sz;
  }
  ctx.lineCap='round'; ctx.lineJoin='round';
  ctx.beginPath(); ctx.moveTo(x1,y1);
  const mx=(x1+x2)/2, my=(y1+y2)/2;
  ctx.quadraticCurveTo(x1,y1,mx,my);
  ctx.stroke();
  ctx.restore();
}

function getXY(e, area) {
  const rect = area.getBoundingClientRect();
  let cx = e.touches ? e.touches[0].clientX : e.clientX;
  let cy = e.touches ? e.touches[0].clientY : e.clientY;
  return {
    x: ((cx - rect.left) / rect.width)  * W,
    y: ((cy - rect.top)  / rect.height) * H
  };
}

function startDraw(e) {
  e.preventDefault();
  if (!canDraw) { shakeBadge(); return; }
  drawing = true;
  const p = getXY(e, myArea);
  lx = p.x; ly = p.y;
}
function moveDraw(e) {
  e.preventDefault();
  if (!drawing || !canDraw) return;
  const p = getXY(e, myArea);
  applyStroke(myCtx, lx, ly, p.x, p.y, color, size, tool==='eraser');
  db.ref('studentDraw').push({
    x:p.x, y:p.y, lx, ly,
    c: tool==='eraser' ? null : color,
    s: tool==='eraser' ? null : size,
    e: tool==='eraser' ? 1 : 0,
    sid, ts: Date.now()
  });
  lx = p.x; ly = p.y;
}
function stopDraw() { drawing=false; }

myCanvas.addEventListener('mousedown',  startDraw);
myCanvas.addEventListener('mousemove',  moveDraw);
myCanvas.addEventListener('mouseup',    stopDraw);
myCanvas.addEventListener('mouseleave', stopDraw);
myCanvas.addEventListener('touchstart', startDraw, {passive:false});
myCanvas.addEventListener('touchmove',  moveDraw,  {passive:false});
myCanvas.addEventListener('touchend',   stopDraw);
myCanvas.addEventListener('touchcancel',stopDraw);

// â”€â”€â”€ Receive teacher board â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
db.ref('tDraw').on('child_added', snap => {
  const d = snap.val(); if(!d) return;
  applyStroke(tCtx, d.lx, d.ly, d.x, d.y, d.c||'#000', d.s||3, !!d.e);
});

// â”€â”€â”€ Receive teacher on my board â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
db.ref('sDraw').on('child_added', snap => {
  const d = snap.val(); if(!d) return;
  applyStroke(myCtx, d.lx, d.ly, d.x, d.y, d.c||'#000', d.s||3, !!d.e);
});

// â”€â”€â”€ Commands â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
db.ref('cmd').on('child_added', snap => {
  const d = snap.val(); if(!d) return;
  if (d.t === 'clear') {
    tCtx.clearRect(0,0,W,H);
    myCtx.clearRect(0,0,W,H);
  }
});

// â”€â”€â”€ Teacher control â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
db.ref('ctrl').on('value', snap => {
  const v = snap.val();
  if (!v) return;
  canDraw = v.canDraw !== false;
  const pb = document.getElementById('pbadge');
  pb.innerHTML = canDraw
    ? '<i class="fas fa-lock-open"></i> ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ÙƒØªØ§Ø¨Ø©'
    : '<i class="fas fa-lock"></i> Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù…Ù…Ù†ÙˆØ¹Ø©';
  pb.style.background = canDraw ? '#27ae60' : '#e74c3c';
});

// â”€â”€â”€ AUDIO â€” Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙˆØªØ´ØºÙŠÙ„ chunks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const audioEl  = document.getElementById('audioEl');
let audioQueue = [];
let isPlaying  = false;
let audioCtx   = null;
let lastChunkIdx = -1;
let seenChunks   = new Set();

function getAudioContext() {
  if (!audioCtx || audioCtx.state === 'closed') {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

async function playBase64Audio(b64) {
  try {
    const ac = getAudioContext();
    // Ø§Ø³ØªØ®Ø±Ø¬ binary Ù…Ù† base64
    const comma = b64.indexOf(',');
    const raw   = comma >= 0 ? b64.slice(comma+1) : b64;
    const bin   = atob(raw);
    const buf   = new Uint8Array(bin.length);
    for (let i=0; i<bin.length; i++) buf[i] = bin.charCodeAt(i);
    
    const decoded = await ac.decodeAudioData(buf.buffer);
    const src = ac.createBufferSource();
    src.buffer = decoded;
    src.connect(ac.destination);
    src.start(0);
  } catch(e) {
    // chunk ØºÙŠØ± ØµØ§Ù„Ø­ â€” ØªØ¬Ø§Ù‡Ù„
  }
}

db.ref('audioMeta').on('value', snap => {
  const v = snap.val();
  const active = v && v.active;
  const abadge   = document.getElementById('abadge');
  const speakerEl= document.getElementById('speakerEl');
  const wavesEl  = document.getElementById('wavesEl');
  const dotEl    = document.getElementById('dotEl');
  const statusEl = document.getElementById('statusEl');

  if (active) {
    abadge.style.display   = 'flex';
    speakerEl.innerHTML    = '<i class="fas fa-volume-up" style="color:#e67e22"></i>';
    wavesEl.style.display  = 'flex';
    dotEl.className        = 'sdot aud';
    statusEl.textContent   = 'ðŸŽ¤ Ø§Ù„Ù…Ø¯Ø±Ø³ ÙŠØªÙƒÙ„Ù…';
  } else {
    abadge.style.display   = 'none';
    speakerEl.innerHTML    = '<i class="fas fa-volume-mute"></i>';
    wavesEl.style.display  = 'none';
    dotEl.className        = 'sdot on';
    statusEl.textContent   = 'Ù…ØªØµÙ„';
    seenChunks.clear();
  }
});

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù€ chunks Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³
db.ref('audioChunks').on('child_changed', snap => {
  const d = snap.val();
  if (!d || !d.d) return;
  if (seenChunks.has(d.i)) return;
  seenChunks.add(d.i);
  // Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªÙØ§Ø¹Ù„
  playBase64Audio(d.d);
});

db.ref('audioChunks').on('child_added', snap => {
  const d = snap.val();
  if (!d || !d.d) return;
  if (seenChunks.has(d.i)) return;
  seenChunks.add(d.i);
  playBase64Audio(d.d);
});

// â”€â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setColor(c, el) {
  color = c; tool = 'pen';
  document.querySelectorAll('.cb').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  setTool('pen');
}
function setSize(s, el) {
  size = s;
  document.querySelectorAll('.tb-btn').forEach(b=>{
    if(['setSize2','setSize5','setSize12'].includes(b.id)) b.classList.remove('active');
  });
  // Ø­Ø¯Ø¯ Ø¨Ø§Ù„Ø¹Ù†ØµØ± Ù…Ø¨Ø§Ø´Ø±Ø©
  document.querySelectorAll('.tg:nth-child(2) .tb-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
}
function setTool(t) {
  tool = t;
  document.getElementById('penBtn').classList.toggle('active',   t==='pen');
  document.getElementById('eraserBtn').classList.toggle('active',t==='eraser');
}
function clearMine() {
  myCtx.clearRect(0,0,W,H);
}
function shakeBadge() {
  const pb = document.getElementById('pbadge');
  pb.style.transition = 'transform .1s';
  [0,-6,6,-6,6,0].forEach((v,i) => setTimeout(()=>{ pb.style.transform=`translateX(${v}px)`; }, i*60));
}

// â”€â”€â”€ ØªÙØ¹ÙŠÙ„ AudioContext Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªÙØ§Ø¹Ù„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.body.addEventListener('touchstart', ()=>getAudioContext(), {once:true});
document.body.addEventListener('click',      ()=>getAudioContext(), {once:true});
document.body.addEventListener('touchend',   ()=>getAudioContext(), {once:true});

// â”€â”€â”€ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
db.ref('online/' + sid).set({ ts: Date.now() });
window.addEventListener('beforeunload', () => {
  db.ref('online/' + sid).remove();
});

// â”€â”€â”€ Ø§ØªØµØ§Ù„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
db.ref('.info/connected').on('value', snap => {
  const dotEl    = document.getElementById('dotEl');
  const statusEl = document.getElementById('statusEl');
  if (snap.val()) {
    dotEl.className    = 'sdot on';
    statusEl.textContent = 'Ù…ØªØµÙ„';
  } else {
    dotEl.className    = 'sdot conn';
    statusEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
  }
});

[tCanvas, myCanvas].forEach(c=>c.addEventListener('contextmenu',e=>e.preventDefault()));
</script>
</body>
</html>
