<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyClass2 - الطالب</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { width: 100%; height: 100dvh; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #111b27; color: #fff; display: flex; flex-direction: column; }

        /* رأس الصفحة */
        .hdr { height: 50px; min-height: 50px; background: #1e2d3d; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 3px solid #3498db; flex-shrink: 0; }
        .logo { font-size: 16px; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .logo i { color: #3498db; }
        .permission-badge { background: #27ae60; padding: 5px 15px; border-radius: 30px; font-size: 12px; display: flex; align-items: center; gap: 6px; transition: 0.3s; }

        /* اللوحات */
        .boards { flex: 1; display: flex; flex-direction: column; padding: 8px; gap: 8px; overflow: hidden; min-height: 0; }
        .board { flex: 1; display: flex; flex-direction: column; background: #1e2d3d; border-radius: 12px; overflow: hidden; border: 1px solid #2c4159; min-height: 0; }
        .bhead { padding: 8px 12px; background: #243447; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; border-bottom: 3px solid; }
        .bhead.teacher { border-bottom-color: #e67e22; }
        .bhead.student { border-bottom-color: #27ae60; }
        .live-audio-badge { display: none; background: #e67e22; padding: 3px 10px; border-radius: 30px; font-size: 11px; align-items: center; gap: 5px; animation: blink 1s infinite; }
        @keyframes blink { 0%,100%{opacity:1;}50%{opacity:0.5;} }

        /* الكانفاس */
        .cbox { flex: 1; overflow: hidden; background: #fff; position: relative; min-height: 0; }
        .cbox canvas { position: absolute; top: 0; left: 0; background: #fff; transform-origin: top left; }
        #studentCanvas { touch-action: none; cursor: crosshair; }
        #teacherCanvas { touch-action: pan-x pan-y; cursor: default; pointer-events: none; }

        /* شريط الأدوات */
        .tb { height: 60px; min-height: 60px; background: #1e2d3d; border-top: 3px solid #3498db; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 0 8px; flex-shrink: 0; overflow-x: auto; }
        .tb::-webkit-scrollbar { display: none; }
        .tg { display: flex; gap: 5px; background: #111b27; padding: 5px 8px; border-radius: 30px; align-items: center; flex-shrink: 0; }
        .clr { width: 30px; height: 30px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; flex-shrink: 0; transition: 0.12s; }
        .clr.selected { border-color: #fff; transform: scale(1.15); }
        .tbtn { width: 40px; height: 40px; border: none; border-radius: 50%; background: #2c4159; color: #fff; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: 0.12s; }
        .tbtn.selected, .tbtn:hover { background: #3498db; }
        .tbtn.delete { color: #e74c3c; }
        .tbtn.delete:hover { background: #e74c3c; color: #fff; }

        /* شريط الحالة */
        .status { height: 38px; min-height: 38px; background: #0e1820; border-top: 1px solid #1e2d3d; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; font-size: 12px; color: #8a9bb0; flex-shrink: 0; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-left: 6px; }
        .status-dot.online { background: #27ae60; box-shadow: 0 0 5px #27ae60; }
        .status-dot.offline { background: #e74c3c; }
        .status-dot.listening { background: #e67e22; animation: blink 1s infinite; }
        .audio-wave { display: none; gap: 2px; align-items: center; }
        .audio-wave span { display: block; width: 3px; background: #e67e22; border-radius: 2px; animation: wave 0.8s infinite; }
        .audio-wave span:nth-child(1) { height: 6px; }
        .audio-wave span:nth-child(2) { height: 12px; animation-delay: 0.15s; }
        .audio-wave span:nth-child(3) { height: 6px; animation-delay: 0.3s; }
        @keyframes wave { 0%,100%{transform:scaleY(0.5);}50%{transform:scaleY(1.2);} }
    </style>
</head>
<body>
    <div class="hdr">
        <div class="logo"><i class="fas fa-user-graduate"></i> MyClass2</div>
        <div class="permission-badge" id="permissionBadge"><i class="fas fa-lock-open"></i> يمكنك الكتابة</div>
    </div>

    <div class="boards">
        <!-- لوحة المدرس -->
        <div class="board">
            <div class="bhead teacher">
                <span><i class="fas fa-chalkboard-teacher" style="color:#e67e22"></i> سبورة المدرس</span>
                <span class="live-audio-badge" id="liveAudioBadge"><i class="fas fa-volume-up"></i> بث مباشر</span>
            </div>
            <div class="cbox" id="teacherBoard"><canvas id="teacherCanvas"></canvas></div>
        </div>
        <!-- لوحة الطالب -->
        <div class="board">
            <div class="bhead student">
                <span><i class="fas fa-pencil-alt" style="color:#27ae60"></i> سبورتي</span>
            </div>
            <div class="cbox" id="studentBoard"><canvas id="studentCanvas"></canvas></div>
        </div>
    </div>

    <div class="tb">
        <!-- الألوان -->
        <div class="tg">
            <div class="clr selected" style="background:#000000" onclick="selectColor('#000000', this)"></div>
            <div class="clr" style="background:#e74c3c" onclick="selectColor('#e74c3c', this)"></div>
            <div class="clr" style="background:#3498db" onclick="selectColor('#3498db', this)"></div>
            <div class="clr" style="background:#27ae60" onclick="selectColor('#27ae60', this)"></div>
            <div class="clr" style="background:#f39c12" onclick="selectColor('#f39c12', this)"></div>
            <div class="clr" style="background:#ffffff; border:2px solid #666" onclick="selectColor('#ffffff', this)"></div>
        </div>
        <!-- أحجام القلم -->
        <div class="tg">
            <button class="tbtn" onclick="selectSize(3, this)"><i class="fas fa-pen" style="font-size:12px"></i></button>
            <button class="tbtn selected" onclick="selectSize(6, this)"><i class="fas fa-pen-fancy" style="font-size:14px"></i></button>
            <button class="tbtn" onclick="selectSize(14, this)"><i class="fas fa-paint-brush"></i></button>
        </div>
        <!-- الأدوات -->
        <div class="tg">
            <button class="tbtn selected" id="toolPen" onclick="selectTool('pen')"><i class="fas fa-pencil-alt"></i></button>
            <button class="tbtn" id="toolEraser" onclick="selectTool('eraser')"><i class="fas fa-eraser"></i></button>
            <button class="tbtn delete" onclick="clearMyBoard()"><i class="fas fa-trash-alt"></i></button>
        </div>
        <!-- ميكروفون الطالب (معطل، للعرض فقط) -->
        <div class="tg">
            <button class="tbtn" id="studentMicBtn" style="background:#555; cursor:not-allowed; opacity:0.6;" disabled>
                <i class="fas fa-microphone-slash" id="studentMicIcon"></i>
            </button>
        </div>
    </div>

    <div class="status">
        <div style="display:flex; align-items:center; gap:8px">
            <span class="status-dot offline" id="connectionStatus"></span>
            <span id="connectionMessage">جاري الاتصال...</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px">
            <i class="fas fa-volume-up" id="speakerIcon" style="color:#e74c3c; display:none;"></i>
            <div class="audio-wave" id="audioWave"><span></span><span></span><span></span></div>
        </div>
    </div>

    <audio id="audioPlayer" autoplay playsinline style="display:none"></audio>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
        // تهيئة Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyB7E4NsGQbCehVSQ3Kj97yExRZwpHzTOl8",
            authDomain: "myclaive.firebaseapp.com",
            databaseURL: "https://myclaive-default-rtdb.firebaseio.com",
            projectId: "myclaive",
            storageBucket: "myclaive.firebasestorage.app",
            messagingSenderId: "507299311714",
            appId: "1:507299311714:web:c90440ee4353cfac17613b"
        });
        const database = firebase.database();

        // إعدادات الكانفاس
        const CANVAS_WIDTH = 1600;
        const CANVAS_HEIGHT = 1200;

        const teacherCanvas = document.getElementById('teacherCanvas');
        const studentCanvas = document.getElementById('studentCanvas');
        const teacherCtx = teacherCanvas.getContext('2d');
        const studentCtx = studentCanvas.getContext('2d');
        const teacherBoard = document.getElementById('teacherBoard');
        const studentBoard = document.getElementById('studentBoard');

        teacherCanvas.width = CANVAS_WIDTH;
        teacherCanvas.height = CANVAS_HEIGHT;
        studentCanvas.width = CANVAS_WIDTH;
        studentCanvas.height = CANVAS_HEIGHT;

        [teacherCtx, studentCtx].forEach(ctx => {
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        });

        // متغيرات القياس
        let studentScale = { x: 1, y: 1 };

        // دالة ضبط أحجام الكانفاس
        function resizeCanvases() {
            // لوحة المدرس (للقراءة فقط)
            const fitTeacher = (canvas, box) => {
                if (!box.clientWidth || !box.clientHeight) return;
                const scaleX = box.clientWidth / CANVAS_WIDTH;
                const scaleY = box.clientHeight / CANVAS_HEIGHT;
                canvas.style.width = CANVAS_WIDTH + 'px';
                canvas.style.height = CANVAS_HEIGHT + 'px';
                canvas.style.transform = `scale(${scaleX}, ${scaleY})`;
            };
            fitTeacher(teacherCanvas, teacherBoard);

            // لوحة الطالب (للرسم)
            const fitStudent = (canvas, box) => {
                if (!box.clientWidth || !box.clientHeight) return;
                studentScale.x = box.clientWidth / CANVAS_WIDTH;
                studentScale.y = box.clientHeight / CANVAS_HEIGHT;
                canvas.style.width = CANVAS_WIDTH + 'px';
                canvas.style.height = CANVAS_HEIGHT + 'px';
                canvas.style.transform = `scale(${studentScale.x}, ${studentScale.y})`;
            };
            fitStudent(studentCanvas, studentBoard);
        }
        resizeCanvases();
        setTimeout(resizeCanvases, 100);
        window.addEventListener('resize', resizeCanvases);

        // متغيرات الرسم
        let currentColor = '#000000';
        let currentSize = 6;
        let currentTool = 'pen';
        let canDraw = true;
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let studentId = 'S_' + Date.now() + '_' + Math.random().toString(36).substring(2, 6);
        let strokeCounter = 0;
        let pointsBuffer = [];
        let flushTimeout = null;
        let currentStrokeKey = '';

        // دوال المساعدة للإحداثيات
        function getCanvasCoordinates(event) {
            const rect = studentBoard.getBoundingClientRect();
            const clientX = event.touches ? event.touches[0].clientX : event.clientX;
            const clientY = event.touches ? event.touches[0].clientY : event.clientY;
            return {
                x: (clientX - rect.left) / studentScale.x,
                y: (clientY - rect.top) / studentScale.y
            };
        }

        // دالة الرسم المحلي
        function drawLocal(ctx, fromX, fromY, toX, toY, color, size, isEraser) {
            ctx.save();
            ctx.globalCompositeOperation = isEraser ? 'destination-out' : 'source-over';
            ctx.strokeStyle = isEraser ? 'rgba(0,0,0,1)' : color;
            ctx.lineWidth = isEraser ? size * 5 : size;
            ctx.beginPath();
            ctx.moveTo(fromX, fromY);
            ctx.lineTo(toX, toY);
            ctx.stroke();
            ctx.restore();
        }

        // إرسال النقاط إلى Firebase
        function flushPoints() {
            if (pointsBuffer.length === 0) return;
            database.ref('studentsDraw').push({
                key: currentStrokeKey,
                color: currentTool === 'eraser' ? null : currentColor,
                size: currentTool === 'eraser' ? -1 : currentSize,
                points: pointsBuffer.splice(0),
                timestamp: Date.now()
            });
        }

        // أحداث الرسم
        function onDrawStart(event) {
            event.preventDefault();
            if (!canDraw) {
                showPermissionWarning();
                return;
            }
            isDrawing = true;
            strokeCounter++;
            currentStrokeKey = studentId + '_' + strokeCounter;

            const coords = getCanvasCoordinates(event);
            lastX = coords.x;
            lastY = coords.y;
            pointsBuffer = [{ x: coords.x, y: coords.y }];

            // رسم النقطة الأولى
            studentCtx.save();
            studentCtx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';
            studentCtx.fillStyle = currentTool === 'eraser' ? 'rgba(0,0,0,1)' : currentColor;
            studentCtx.beginPath();
            studentCtx.arc(coords.x, coords.y, (currentTool === 'eraser' ? currentSize * 5 : currentSize) / 2, 0, Math.PI * 2);
            studentCtx.fill();
            studentCtx.restore();
        }

        function onDrawMove(event) {
            event.preventDefault();
            if (!isDrawing || !canDraw) return;

            const coords = getCanvasCoordinates(event);
            drawLocal(studentCtx, lastX, lastY, coords.x, coords.y, currentColor, currentSize, currentTool === 'eraser');
            pointsBuffer.push({ x: coords.x, y: coords.y });

            if (!flushTimeout) {
                flushTimeout = setTimeout(() => {
                    flushPoints();
                    flushTimeout = null;
                }, 25);
            }

            lastX = coords.x;
            lastY = coords.y;
        }

        function onDrawEnd() {
            if (!isDrawing) return;
            isDrawing = false;
            clearTimeout(flushTimeout);
            flushTimeout = null;
            flushPoints();
        }

        // ربط أحداث الرسم
        studentCanvas.addEventListener('mousedown', onDrawStart);
        studentCanvas.addEventListener('mousemove', onDrawMove);
        studentCanvas.addEventListener('mouseup', onDrawEnd);
        studentCanvas.addEventListener('mouseleave', onDrawEnd);
        studentCanvas.addEventListener('touchstart', onDrawStart, { passive: false });
        studentCanvas.addEventListener('touchmove', onDrawMove, { passive: false });
        studentCanvas.addEventListener('touchend', onDrawEnd);
        studentCanvas.addEventListener('touchcancel', onDrawEnd);

        // استقبال رسم المدرس
        const remoteTeacherStrokes = {};
        function applyRemoteTeacherDraw(data) {
            if (!data || !data.points || data.points.length === 0) return;
            const strokeId = data.key || String(data.timestamp);
            const isEraser = data.size === -1;
            const lineWidth = isEraser ? 50 : (data.size || 3);

            if (!remoteTeacherStrokes[strokeId]) {
                const firstPoint = data.points[0];
                remoteTeacherStrokes[strokeId] = { x: firstPoint.x, y: firstPoint.y };
                teacherCtx.save();
                teacherCtx.globalCompositeOperation = isEraser ? 'destination-out' : 'source-over';
                teacherCtx.fillStyle = isEraser ? 'rgba(0,0,0,1)' : (data.color || '#000000');
                teacherCtx.beginPath();
                teacherCtx.arc(firstPoint.x, firstPoint.y, lineWidth / 2, 0, Math.PI * 2);
                teacherCtx.fill();
                teacherCtx.restore();
            }

            const lastPoint = remoteTeacherStrokes[strokeId];
            teacherCtx.save();
            teacherCtx.globalCompositeOperation = isEraser ? 'destination-out' : 'source-over';
            teacherCtx.strokeStyle = isEraser ? 'rgba(0,0,0,1)' : (data.color || '#000000');
            teacherCtx.lineWidth = lineWidth;
            teacherCtx.beginPath();
            teacherCtx.moveTo(lastPoint.x, lastPoint.y);

            for (const point of data.points) {
                teacherCtx.lineTo(point.x, point.y);
                lastPoint.x = point.x;
                lastPoint.y = point.y;
            }
            teacherCtx.stroke();
            teacherCtx.restore();
        }

        database.ref('teacherDraw').on('child_added', (snap) => applyRemoteTeacherDraw(snap.val()));

        // استقبال رسم الطلاب الآخرين (للمزامنة)
        const remoteStudentStrokes = {};
        function applyRemoteStudentDraw(data) {
            if (!data || !data.points || data.points.length === 0) return;
            const strokeId = data.key || String(data.timestamp);
            if (strokeId.startsWith(studentId)) return; // تجاهل رسم الطالب نفسه

            const isEraser = data.size === -1;
            const lineWidth = isEraser ? 50 : (data.size || 3);

            if (!remoteStudentStrokes[strokeId]) {
                const firstPoint = data.points[0];
                remoteStudentStrokes[strokeId] = { x: firstPoint.x, y: firstPoint.y };
                studentCtx.save();
                studentCtx.globalCompositeOperation = isEraser ? 'destination-out' : 'source-over';
                studentCtx.fillStyle = isEraser ? 'rgba(0,0,0,1)' : (data.color || '#000000');
                studentCtx.beginPath();
                studentCtx.arc(firstPoint.x, firstPoint.y, lineWidth / 2, 0, Math.PI * 2);
                studentCtx.fill();
                studentCtx.restore();
            }

            const lastPoint = remoteStudentStrokes[strokeId];
            studentCtx.save();
            studentCtx.globalCompositeOperation = isEraser ? 'destination-out' : 'source-over';
            studentCtx.strokeStyle = isEraser ? 'rgba(0,0,0,1)' : (data.color || '#000000');
            studentCtx.lineWidth = lineWidth;
            studentCtx.beginPath();
            studentCtx.moveTo(lastPoint.x, lastPoint.y);

            for (const point of data.points) {
                studentCtx.lineTo(point.x, point.y);
                lastPoint.x = point.x;
                lastPoint.y = point.y;
            }
            studentCtx.stroke();
            studentCtx.restore();
        }

        database.ref('studentsDraw').on('child_added', (snap) => applyRemoteStudentDraw(snap.val()));

        // استقبال أوامر المسح
        database.ref('commands').on('child_added', (snap) => {
            const cmd = snap.val();
            if (!cmd) return;
            if (cmd.type === 'clearTeacher' || cmd.type === 'clearAll') teacherCtx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            if (cmd.type === 'clearStudents' || cmd.type === 'clearAll') studentCtx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
        });

        // ---- أدوات الرسم ----
        window.selectColor = (color, element) => {
            currentColor = color;
            document.querySelectorAll('.clr').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectTool('pen');
        };

        window.selectSize = (size, element) => {
            currentSize = size;
            document.querySelectorAll('.tb .tg:nth-child(2) .tbtn').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
        };

        window.selectTool = (tool) => {
            currentTool = tool;
            document.getElementById('toolPen').classList.toggle('selected', tool === 'pen');
            document.getElementById('toolEraser').classList.toggle('selected', tool === 'eraser');
        };

        window.clearMyBoard = () => {
            studentCtx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
        };

        function showPermissionWarning() {
            const badge = document.getElementById('permissionBadge');
            badge.style.background = '#e74c3c';
            badge.innerHTML = '<i class="fas fa-lock"></i> الكتابة ممنوعة';
            setTimeout(() => {
                if (canDraw) {
                    badge.style.background = '#27ae60';
                    badge.innerHTML = '<i class="fas fa-lock-open"></i> يمكنك الكتابة';
                }
            }, 1500);
        }

        // ---- التحكم في الصلاحيات من المدرس ----
        database.ref('control/studentsCanDraw').on('value', (snap) => {
            canDraw = snap.val() !== false;
            const badge = document.getElementById('permissionBadge');
            badge.style.background = canDraw ? '#27ae60' : '#e74c3c';
            badge.innerHTML = canDraw ? '<i class="fas fa-lock-open"></i> يمكنك الكتابة' : '<i class="fas fa-lock"></i> الكتابة ممنوعة';
        });

        // ---- نظام الصوت (استقبال فقط) ----
        const audioPlayer = document.getElementById('audioPlayer');
        const audioQueue = [];
        let isAudioPlaying = false;
        const heardAudioTimestamps = new Set();

        database.ref('audio/status').on('value', (snap) => {
            const status = snap.val();
            const isActive = status && status.active === true;
            const badge = document.getElementById('liveAudioBadge');
            const speakerIcon = document.getElementById('speakerIcon');
            const audioWave = document.getElementById('audioWave');
            const connectionStatus = document.getElementById('connectionStatus');

            if (isActive) {
                badge.style.display = 'flex';
                speakerIcon.style.display = 'inline';
                speakerIcon.style.color = '#e67e22';
                audioWave.style.display = 'flex';
                connectionStatus.className = 'status-dot listening';
                document.getElementById('connectionMessage').textContent = 'المدرس يتحدث...';
            } else {
                badge.style.display = 'none';
                speakerIcon.style.display = 'none';
                audioWave.style.display = 'none';
                connectionStatus.className = 'status-dot online';
                document.getElementById('connectionMessage').textContent = 'متصل';
                // تنظيف قائمة الانتظار
                audioQueue.length = 0;
                isAudioPlaying = false;
                audioPlayer.src = '';
                heardAudioTimestamps.clear();
            }
        });

        function playNextAudio() {
            if (isAudioPlaying || audioQueue.length === 0) return;
            isAudioPlaying = true;
            audioPlayer.src = audioQueue.shift();
            audioPlayer.onended = () => {
                isAudioPlaying = false;
                playNextAudio();
            };
            audioPlayer.onerror = () => {
                isAudioPlaying = false;
                playNextAudio();
            };
            audioPlayer.play().catch(() => {
                isAudioPlaying = false;
                playNextAudio();
            });
        }

        function handleAudioChunk(snap) {
            const data = snap.val();
            if (!data || !data.data || heardAudioTimestamps.has(data.timestamp)) return;
            heardAudioTimestamps.add(data.timestamp);
            audioQueue.push(data.data);
            playNextAudio();
        }

        database.ref('audio/chunk0').on('value', handleAudioChunk);
        database.ref('audio/chunk1').on('value', handleAudioChunk);

        // فتح الصوت عند أول تفاعل
        function unlockAudio() {
            try { audioPlayer.play().catch(() => {}); } catch (e) {}
        }
        document.body.addEventListener('touchstart', unlockAudio, { once: true });
        document.body.addEventListener('click', unlockAudio, { once: true });

        // ---- حالة الاتصال ----
        database.ref('.info/connected').on('value', (snap) => {
            const isConnected = snap.val();
            const statusDot = document.getElementById('connectionStatus');
            const message = document.getElementById('connectionMessage');
            if (isConnected) {
                statusDot.className = 'status-dot online';
                message.textContent = 'متصل';
            } else {
                statusDot.className = 'status-dot offline';
                message.textContent = 'غير متصل';
            }
        });

        // تسجيل وجود الطالب
        const sessionId = studentId;
        database.ref('onlineStudents/' + sessionId).set({ online: true, timestamp: Date.now() });

        // تنظيف عند الخروج
        window.addEventListener('beforeunload', () => {
            database.ref('onlineStudents/' + sessionId).remove();
        });

        // منع القائمة اليمنى
        [teacherCanvas, studentCanvas].forEach(c => c.addEventListener('contextmenu', e => e.preventDefault()));
    </script>
</body>
</html>
