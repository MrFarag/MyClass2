<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyClass2 - Ø§Ù„Ø·Ø§Ù„Ø¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            --header-h: 50px;
            --toolbar-h: 62px;
            --status-h: 42px;
        }

        html, body { width: 100%; height: 100%; overflow: hidden; touch-action: none; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #111b27;
            display: flex;
            flex-direction: column;
            color: white;
        }

        .header {
            height: var(--header-h);
            min-height: var(--header-h);
            background: #1e2d3d;
            padding: 0 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #3498db;
            flex-shrink: 0;
        }

        .logo { font-size: 16px; font-weight: bold; display: flex; align-items: center; gap: 6px; }
        .logo i { color: #3498db; }

        .permission-badge {
            background: #27ae60;
            padding: 4px 10px; border-radius: 20px;
            font-size: 12px; display: flex; align-items: center; gap: 5px;
        }

        .audio-badge {
            background: #e67e22;
            padding: 3px 8px; border-radius: 20px;
            font-size: 11px; display: flex; align-items: center; gap: 4px;
            animation: pulseBadge 1s infinite;
        }
        @keyframes pulseBadge { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        .boards-vertical {
            flex: 1;
            display: flex; flex-direction: column;
            padding: 8px; gap: 8px;
            overflow: hidden; min-height: 0;
        }

        .board-container {
            flex: 1; display: flex; flex-direction: column;
            background: #1e2d3d; border-radius: 12px;
            overflow: hidden; border: 1px solid #2c4159;
            min-height: 0;
        }

        .board-header {
            padding: 7px 12px; background: #243447;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }
        .board-header.teacher { border-bottom: 3px solid #e67e22; }
        .board-header.student { border-bottom: 3px solid #27ae60; }

        .board-title { font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 6px; }

        .canvas-wrapper {
            flex: 1; overflow: auto;
            background: #f5f5f5;
            -webkit-overflow-scrolling: touch;
            min-height: 0; position: relative;
        }

        .board-canvas {
            width: 2000px; height: 2000px;
            display: block; background: white;
        }

        #myCanvas    { cursor: crosshair; touch-action: none; }
        #teacherCanvas { cursor: default; touch-action: pan-x pan-y; }

        .toolbar {
            height: var(--toolbar-h);
            min-height: var(--toolbar-h);
            background: #1e2d3d;
            border-top: 2px solid #3498db;
            display: flex; align-items: center;
            justify-content: center; gap: 8px;
            padding: 0 10px; flex-shrink: 0;
            flex-wrap: nowrap; overflow-x: auto;
        }
        .toolbar::-webkit-scrollbar { display: none; }

        .color-palette {
            display: flex; gap: 5px;
            background: #111b27; padding: 5px 8px;
            border-radius: 25px; align-items: center;
        }

        .color-btn {
            width: 28px; height: 28px; border-radius: 50%;
            border: 2px solid transparent; cursor: pointer;
            transition: transform 0.15s, border-color 0.15s; flex-shrink: 0;
        }
        .color-btn.active { border-color: white; box-shadow: 0 0 8px rgba(255,255,255,0.5); transform: scale(1.15); }

        .tool-group {
            display: flex; gap: 4px;
            background: #111b27; padding: 5px 8px;
            border-radius: 25px; align-items: center;
        }

        .tool-btn {
            width: 36px; height: 36px;
            border: none; border-radius: 50%;
            background: #2c4159; color: white;
            font-size: 14px; cursor: pointer;
            transition: background 0.15s, transform 0.15s;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .tool-btn:active { transform: scale(0.9); }
        .tool-btn.active { background: #3498db; }
        .tool-btn:hover  { background: #3498db; }
        .tool-btn.mic-on { background: #e74c3c !important; animation: micPulse 1.5s infinite; }
        @keyframes micPulse {
            0%,100%{box-shadow:0 0 0 0 rgba(231,76,60,.6)}
            50%{box-shadow:0 0 0 8px rgba(231,76,60,0)}
        }

        .status-bar {
            height: var(--status-h); min-height: var(--status-h);
            background: #0e1820; padding: 0 12px;
            font-size: 12px; color: #aab8c8;
            display: flex; align-items: center; justify-content: space-between;
            border-top: 1px solid #243447; flex-shrink: 0;
        }

        .status-left { display: flex; align-items: center; gap: 7px; }

        .status-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
        .status-dot.online     { background: #27ae60; box-shadow: 0 0 8px #27ae60; }
        .status-dot.connecting { background: #f39c12; animation: blink 0.8s infinite; }
        .status-dot.audio      { background: #e67e22; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        .audio-controls { display: flex; align-items: center; gap: 8px; }

        .audio-icon { font-size: 16px; display: flex; align-items: center; gap: 5px; }
        .audio-icon.muted  { color: #e74c3c; }
        .audio-icon.active { color: #e67e22; }
        .audio-icon.mic-on { color: #27ae60; }

        .volume-btn {
            background: none; border: none; color: inherit;
            cursor: pointer; font-size: 16px; padding: 4px;
            border-radius: 50%; display: flex; align-items: center;
        }

        .audio-waves { display: flex; gap: 2px; align-items: center; }
        .audio-waves span {
            display: block; width: 3px; background: #e67e22;
            border-radius: 2px; animation: wave 0.8s infinite ease-in-out;
        }
        .audio-waves span:nth-child(1) { height: 8px;  animation-delay: 0s; }
        .audio-waves span:nth-child(2) { height: 14px; animation-delay: 0.15s; }
        .audio-waves span:nth-child(3) { height: 8px;  animation-delay: 0.3s; }
        @keyframes wave { 0%, 100% { transform: scaleY(0.5); } 50% { transform: scaleY(1.2); } }
    </style>
</head>
<body>

<div class="header">
    <div class="logo"><i class="fas fa-user-graduate"></i> MyClass2</div>
    <div class="permission-badge" id="permissionBadge">
        <i class="fas fa-lock-open"></i> ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ÙƒØªØ§Ø¨Ø©
    </div>
</div>

<div class="boards-vertical">
    <!-- Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ -->
    <div class="board-container">
        <div class="board-header teacher">
            <span class="board-title">
                <i class="fas fa-chalkboard-teacher" style="color:#e67e22"></i> Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³
            </span>
            <span id="teacherAudioBadge" style="display:none;" class="audio-badge">
                <i class="fas fa-volume-up"></i> ØµÙˆØª Ù…Ø¨Ø§Ø´Ø±
            </span>
        </div>
        <div class="canvas-wrapper" id="teacherWrapper">
            <canvas class="board-canvas" id="teacherCanvas"></canvas>
        </div>
    </div>

    <!-- Ø³Ø¨ÙˆØ±ØªÙŠ -->
    <div class="board-container">
        <div class="board-header student">
            <span class="board-title">
                <i class="fas fa-pencil-alt" style="color:#27ae60"></i> Ø³Ø¨ÙˆØ±ØªÙŠ
            </span>
        </div>
        <div class="canvas-wrapper" id="myWrapper">
            <canvas class="board-canvas" id="myCanvas"></canvas>
        </div>
    </div>
</div>

<div class="toolbar">
    <div class="color-palette">
        <div class="color-btn active" style="background:#111111" onclick="changeColor('black',this)"></div>
        <div class="color-btn" style="background:#e74c3c" onclick="changeColor('#e74c3c',this)"></div>
        <div class="color-btn" style="background:#3498db" onclick="changeColor('#3498db',this)"></div>
        <div class="color-btn" style="background:#27ae60" onclick="changeColor('#27ae60',this)"></div>
        <div class="color-btn" style="background:#f39c12" onclick="changeColor('#f39c12',this)"></div>
    </div>

    <div class="tool-group">
        <button class="tool-btn" onclick="changeSize(2,this)"><i class="fas fa-pen"></i></button>
        <button class="tool-btn active" onclick="changeSize(5,this)"><i class="fas fa-pen-fancy"></i></button>
        <button class="tool-btn" onclick="changeSize(10,this)"><i class="fas fa-paint-brush"></i></button>
    </div>

    <div class="tool-group">
        <button class="tool-btn active" id="penBtn" onclick="setPen()"><i class="fas fa-pencil-alt"></i></button>
        <button class="tool-btn" id="eraserBtn" onclick="setEraser()"><i class="fas fa-eraser"></i></button>
        <button class="tool-btn" onclick="clearMyBoard()" style="color:#e74c3c"><i class="fas fa-trash-alt"></i></button>
    </div>

    <!-- Ø²Ø± Ù…Ø§ÙŠÙƒ Ø§Ù„Ø·Ø§Ù„Ø¨ -->
    <div class="tool-group">
        <button class="tool-btn" id="myMicBtn" onclick="toggleMyMic()" title="Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†ÙŠ">
            <i class="fas fa-microphone-slash audio-icon muted" id="myMicIcon"></i>
        </button>
    </div>
</div>

<div class="status-bar">
    <div class="status-left">
        <span class="status-dot connecting" id="statusDot"></span>
        <span id="statusText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
    </div>
    <div class="audio-controls">
        <div id="audioStatus" class="audio-icon muted">
            <i class="fas fa-volume-mute" id="speakerIcon"></i>
        </div>
        <div class="audio-waves" id="audioWaves" style="display:none;">
            <span></span><span></span><span></span>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
    firebase.initializeApp({
        apiKey: "AIzaSyB7E4NsGQbCehVSQ3Kj97yExRZwpHzTOl8",
        authDomain: "myclaive.firebaseapp.com",
        databaseURL: "https://myclaive-default-rtdb.firebaseio.com",
        projectId: "myclaive",
        storageBucket: "myclaive.firebasestorage.app",
        messagingSenderId: "507299311714",
        appId: "1:507299311714:web:c90440ee4353cfac17613b"
    });
    const db = firebase.database();

    const teacherCanvas = document.getElementById('teacherCanvas');
    const myCanvas      = document.getElementById('myCanvas');
    const teacherCtx    = teacherCanvas.getContext('2d');
    const myCtx         = myCanvas.getContext('2d');

    let drawing      = false;
    let currentTool  = 'pen';
    let currentColor = 'black';
    let currentSize  = 5;
    let lastX = 0, lastY = 0;
    let canDraw = true;
    let myMicOn = false, myMicStream = null, myMediaRec = null, myChunkIdx = 0;
    const studentId = 'student_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);

    // â”€â”€ batch Ø¥Ø±Ø³Ø§Ù„ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙ‚Ø·Ø¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let pendingPoints = [];
    let batchTimer = null;

    function flushMyPoints() {
        if (!pendingPoints.length) return;
        db.ref('studentDrawings').push({
            pts: pendingPoints.slice(),
            c: currentTool === 'eraser' ? null : currentColor,
            s: currentTool === 'eraser' ? 30 : currentSize,
            e: currentTool === 'eraser' ? 1 : 0,
            sid: studentId,
            ts: Date.now()
        });
        pendingPoints = [];
    }

    function initCanvases() {
        teacherCanvas.width  = 2000; teacherCanvas.height = 2000;
        myCanvas.width       = 2000; myCanvas.height      = 2000;
        [teacherCtx, myCtx].forEach(ctx => {
            ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        });
    }
    initCanvases();

    function getPos(e, canvas, wrapperId) {
        const wrapper = document.getElementById(wrapperId);
        const wRect   = wrapper.getBoundingClientRect();
        const scaleX  = canvas.width  / wrapper.clientWidth;
        const scaleY  = canvas.height / wrapper.clientHeight;
        let cx, cy;
        if (e.touches && e.touches.length > 0) { cx = e.touches[0].clientX; cy = e.touches[0].clientY; }
        else { cx = e.clientX; cy = e.clientY; }
        return {
            x: (cx - wRect.left + wrapper.scrollLeft) * scaleX,
            y: (cy - wRect.top  + wrapper.scrollTop)  * scaleY
        };
    }

    function startDrawing(e) {
        e.preventDefault();
        if (!canDraw) { showNoPermission(); return; }
        drawing = true;
        const pos = getPos(e, myCanvas, 'myWrapper');
        lastX = pos.x; lastY = pos.y;
        pendingPoints = [pos];
        myCtx.beginPath(); myCtx.moveTo(pos.x, pos.y);
    }

    function draw(e) {
        e.preventDefault();
        if (!drawing || !canDraw) return;
        const pos = getPos(e, myCanvas, 'myWrapper');

        // Ø±Ø³Ù… Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ
        myCtx.save();
        if (currentTool === 'eraser') {
            myCtx.globalCompositeOperation = 'destination-out';
            myCtx.strokeStyle = 'rgba(0,0,0,1)';
            myCtx.lineWidth   = 30;
        } else {
            myCtx.globalCompositeOperation = 'source-over';
            myCtx.strokeStyle = currentColor;
            myCtx.lineWidth   = currentSize;
        }
        myCtx.lineCap = 'round'; myCtx.lineJoin = 'round';
        const mx = (lastX + pos.x) / 2;
        const my = (lastY + pos.y) / 2;
        myCtx.beginPath(); myCtx.moveTo(lastX, lastY);
        myCtx.quadraticCurveTo(lastX, lastY, mx, my);
        myCtx.stroke();
        myCtx.restore();

        pendingPoints.push(pos);
        if (!batchTimer) {
            batchTimer = setTimeout(() => { flushMyPoints(); batchTimer = null; }, 40);
        }
        lastX = pos.x; lastY = pos.y;
    }

    function stopDrawing() {
        if (!drawing) return; drawing = false;
        if (batchTimer) { clearTimeout(batchTimer); batchTimer = null; }
        flushMyPoints();
        myCtx.beginPath();
        myCtx.globalCompositeOperation = 'source-over';
    }

    // â”€â”€ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function drawBatch(ctx, d) {
        if (!d || !d.pts || !d.pts.length) return;
        ctx.save();
        if (d.e) {
            ctx.globalCompositeOperation = 'destination-out';
            ctx.strokeStyle = 'rgba(0,0,0,1)';
            ctx.lineWidth = 30;
        } else {
            ctx.globalCompositeOperation = 'source-over';
            ctx.strokeStyle = d.c || '#000';
            ctx.lineWidth   = d.s || 3;
        }
        ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        ctx.beginPath();
        const pts = d.pts;
        ctx.moveTo(pts[0].x, pts[0].y);
        for (let i = 1; i < pts.length - 1; i++) {
            const mx = (pts[i].x + pts[i+1].x) / 2;
            const my = (pts[i].y + pts[i+1].y) / 2;
            ctx.quadraticCurveTo(pts[i].x, pts[i].y, mx, my);
        }
        ctx.lineTo(pts[pts.length-1].x, pts[pts.length-1].y);
        ctx.stroke();
        ctx.restore();
    }

    db.ref('teacherDrawings').on('child_added',          snap => drawBatch(teacherCtx, snap.val()));
    db.ref('teacherDrawingsOnStudent').on('child_added', snap => drawBatch(myCtx,      snap.val()));

    db.ref('teacherCommands').on('child_added', snap => {
        const d = snap.val();
        if (d && d.type === 'clear') {
            teacherCtx.clearRect(0, 0, teacherCanvas.width, teacherCanvas.height);
            myCtx.clearRect(0, 0, myCanvas.width, myCanvas.height);
        }
    });

    db.ref('teacherControls').on('value', snap => {
        const d = snap.val(); if (!d) return;
        canDraw = d.studentsCanDraw;
        const pb = document.getElementById('permissionBadge');
        pb.innerHTML = canDraw ? '<i class="fas fa-lock-open"></i> ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ÙƒØªØ§Ø¨Ø©' : '<i class="fas fa-lock"></i> Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù…Ù…Ù†ÙˆØ¹Ø©';
        pb.style.background = canDraw ? '#27ae60' : '#e74c3c';
    });

    // â”€â”€ AUDIO: Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØµÙˆØª Ø§Ù„Ù…Ø¯Ø±Ø³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let audioCtx = null;
    const seenChunks = new Set();
    let nextPlayTime = 0;

    function getAC() {
        if (!audioCtx || audioCtx.state === 'closed')
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        return audioCtx;
    }

    async function playChunk(d) {
        if (!d || !d.d) return;
        if (seenChunks.has(d.i)) return;
        seenChunks.add(d.i);
        try {
            const ac = getAC();
            const b64 = d.d;
            const comma = b64.indexOf(',');
            const raw = comma >= 0 ? b64.slice(comma + 1) : b64;
            const bin = atob(raw);
            const buf = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) buf[i] = bin.charCodeAt(i);
            const decoded = await ac.decodeAudioData(buf.buffer.slice(0));
            const src = ac.createBufferSource();
            src.buffer = decoded;
            src.connect(ac.destination);
            const now = ac.currentTime;
            if (nextPlayTime < now) nextPlayTime = now + 0.05;
            src.start(nextPlayTime);
            nextPlayTime += decoded.duration;
        } catch (e) { /* chunk ØºÙŠØ± ØµØ§Ù„Ø­ */ }
    }

    db.ref('audioChunks').on('child_changed', snap => playChunk(snap.val()));
    db.ref('audioChunks').on('child_added',   snap => playChunk(snap.val()));

    db.ref('audioMeta').on('value', snap => {
        const v = snap.val();
        const active = v && v.active;
        const badge   = document.getElementById('teacherAudioBadge');
        const speaker = document.getElementById('speakerIcon');
        const waves   = document.getElementById('audioWaves');
        const dot     = document.getElementById('statusDot');
        const st      = document.getElementById('statusText');
        const aStatus = document.getElementById('audioStatus');
        if (active) {
            badge.style.display   = 'flex';
            speaker.className     = 'fas fa-volume-up';
            aStatus.className     = 'audio-icon active';
            waves.style.display   = 'flex';
            dot.className         = 'status-dot audio';
            st.textContent        = 'ðŸŽ¤ Ø§Ù„Ù…Ø¯Ø±Ø³ ÙŠØªÙƒÙ„Ù…';
        } else {
            badge.style.display   = 'none';
            speaker.className     = 'fas fa-volume-mute';
            aStatus.className     = 'audio-icon muted';
            waves.style.display   = 'none';
            dot.className         = 'status-dot online';
            st.textContent        = 'Ù…ØªØµÙ„';
            seenChunks.clear();
            nextPlayTime = 0;
        }
    });

    // â”€â”€ Ù…Ø§ÙŠÙƒ Ø§Ù„Ø·Ø§Ù„Ø¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getSupportedMimeType() {
        const types = ['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/mp4'];
        for (const t of types) if (MediaRecorder.isTypeSupported(t)) return t;
        return '';
    }
    function blobToBase64(blob) {
        return new Promise(res => {
            const r = new FileReader();
            r.onloadend = () => res(r.result);
            r.readAsDataURL(blob);
        });
    }

    async function toggleMyMic() {
        const btn  = document.getElementById('myMicBtn');
        const icon = document.getElementById('myMicIcon');
        if (!myMicOn) {
            icon.className = 'fas fa-spinner fa-spin';
            try {
                myMicStream = await navigator.mediaDevices.getUserMedia({
                    audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
                });
                myMicOn = true; myChunkIdx = 0;
                db.ref('studentAudio/' + studentId).remove();
                const mime = getSupportedMimeType();
                myMediaRec = new MediaRecorder(myMicStream, mime ? { mimeType: mime } : {});
                myMediaRec.ondataavailable = async ev => {
                    if (!ev.data || ev.data.size < 50) return;
                    const b64  = await blobToBase64(ev.data);
                    const slot = myChunkIdx % 20;
                    db.ref('studentAudio/' + studentId + '/' + slot).set({ d: b64, i: myChunkIdx, ts: Date.now() });
                    myChunkIdx++;
                };
                myMediaRec.start(300);
                btn.classList.add('mic-on');
                icon.className = 'fas fa-microphone audio-icon mic-on';
            } catch (err) {
                icon.className = 'fas fa-microphone-slash audio-icon muted';
                alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†:\n' + err.message);
            }
        } else {
            if (myMediaRec && myMediaRec.state !== 'inactive') myMediaRec.stop();
            if (myMicStream) myMicStream.getTracks().forEach(t => t.stop());
            myMediaRec = null; myMicStream = null; myMicOn = false;
            db.ref('studentAudio/' + studentId).remove();
            btn.classList.remove('mic-on');
            icon.className = 'fas fa-microphone-slash audio-icon muted';
        }
    }

    // â”€â”€ Ø£Ø¯ÙˆØ§Øª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function changeColor(color, el) {
        if (!canDraw) return;
        currentColor = color; currentTool = 'pen';
        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('penBtn').classList.add('active');
        document.getElementById('eraserBtn').classList.remove('active');
    }
    function changeSize(size, el) {
        currentSize = size;
        document.querySelectorAll('.tool-group:nth-child(2) .tool-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }
    function setPen()    { currentTool = 'pen';    document.getElementById('penBtn').classList.add('active');    document.getElementById('eraserBtn').classList.remove('active'); }
    function setEraser() { currentTool = 'eraser'; document.getElementById('eraserBtn').classList.add('active'); document.getElementById('penBtn').classList.remove('active'); }
    function clearMyBoard() { if (!canDraw) return; myCtx.clearRect(0, 0, myCanvas.width, myCanvas.height); }
    function showNoPermission() {
        const pb = document.getElementById('permissionBadge');
        [0,-5,5,-5,0].forEach((v,i) => setTimeout(() => pb.style.transform = `translateX(${v}px)`, i * 50));
    }

    myCanvas.addEventListener('mousedown',   startDrawing);
    myCanvas.addEventListener('mousemove',   draw);
    myCanvas.addEventListener('mouseup',     stopDrawing);
    myCanvas.addEventListener('mouseleave',  stopDrawing);
    myCanvas.addEventListener('touchstart',  startDrawing,  {passive:false});
    myCanvas.addEventListener('touchmove',   draw,          {passive:false});
    myCanvas.addEventListener('touchend',    stopDrawing);
    myCanvas.addEventListener('touchcancel', stopDrawing);
    [teacherCanvas, myCanvas].forEach(c => c.addEventListener('contextmenu', e => e.preventDefault()));

    // ØªÙØ¹ÙŠÙ„ AudioContext Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªÙØ§Ø¹Ù„ (Ù…Ù‡Ù… Ù„Ù€ iOS)
    ['touchstart','touchend','click'].forEach(ev => {
        document.body.addEventListener(ev, () => { try { getAC(); } catch(e){} }, { once: true });
    });

    db.ref('.info/connected').on('value', snap => {
        document.getElementById('statusDot').className = 'status-dot ' + (snap.val() ? 'online' : 'connecting');
        document.getElementById('statusText').textContent = snap.val() ? 'Ù…ØªØµÙ„' : 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
    });

    db.ref('onlineStudents/' + studentId).set({ online: true, canDraw: true, ts: Date.now() });
    window.addEventListener('beforeunload', () => {
        db.ref('onlineStudents/' + studentId).remove();
        db.ref('studentAudio/'   + studentId).remove();
        if (myMicStream) myMicStream.getTracks().forEach(t => t.stop());
    });

    setPen();
</script>
</body>
</html>
