<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyClass2 - Ø§Ù„Ù…Ø¯Ø±Ø³</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a2634;
            display: flex;
            flex-direction: column;
            height: 100dvh;
            overflow: hidden;
            color: white;
        }

        .header {
            background: #2c3e50;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #e67e22;
            flex-shrink: 0;
            gap: 10px;
        }

        .logo { font-size: 16px; font-weight: bold; white-space: nowrap; }
        .logo i { color: #e67e22; margin-right: 6px; }

        .header-right { display: flex; align-items: center; gap: 8px; }

        .online-count {
            background: #27ae60;
            padding: 5px 12px;
            border-radius: 30px;
            font-size: 13px;
            white-space: nowrap;
        }

        .mic-indicator {
            display: none;
            align-items: center;
            gap: 6px;
            background: #e74c3c;
            padding: 5px 12px;
            border-radius: 30px;
            font-size: 13px;
            animation: pulseRed 1s infinite;
        }
        .mic-indicator.active { display: flex; }
        @keyframes pulseRed { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        .boards-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding: 6px;
            gap: 6px;
        }

        @media (min-width: 769px) { .boards-wrapper { flex-direction: row; } }
        @media (max-width: 768px) { .boards-wrapper { flex-direction: column; } }

        .board-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #2c3e50;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            min-height: 0;
        }

        .board-header {
            padding: 8px 12px;
            background: #34495e;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e67e22;
            flex-shrink: 0;
        }
        .board-header.right { border-bottom-color: #3498db; }
        .board-title { font-size: 14px; font-weight: bold; }
        .board-controls { display: flex; gap: 6px; }
        .board-controls button {
            background: rgba(255,255,255,0.1);
            border: none; color: white;
            width: 30px; height: 30px;
            border-radius: 6px; cursor: pointer;
            transition: all 0.2s; font-size: 13px;
        }
        .board-controls button:hover { background: #e67e22; }

        .canvas-scroll {
            flex: 1;
            overflow: auto;
            position: relative;
            background: #ecf0f1;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
        }

        .board-canvas {
            width: 2000px;
            height: 1500px;
            display: block;
            background: white;
            touch-action: none;
            cursor: crosshair;
        }

        .toolbar {
            background: #34495e;
            padding: 8px 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            border-top: 2px solid #e67e22;
            flex-shrink: 0;
        }

        .tool-group {
            display: flex; gap: 4px;
            background: #2c3e50;
            padding: 4px; border-radius: 8px;
        }

        .tool-btn {
            width: 38px; height: 38px;
            border: none; border-radius: 6px;
            background: #3d566e; color: white;
            font-size: 16px; cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .tool-btn:hover { background: #e67e22; transform: scale(1.05); }
        .tool-btn.active { background: #e67e22; box-shadow: 0 0 8px rgba(230,126,34,0.6); }

        #audioBtn.mic-on {
            background: #e74c3c !important;
            animation: pulseMic 1.5s infinite;
        }
        @keyframes pulseMic {
            0%, 100% { box-shadow: 0 0 0 0 rgba(231,76,60,0.6); }
            50% { box-shadow: 0 0 0 8px rgba(231,76,60,0); }
        }

        .color-btn {
            width: 32px; height: 32px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer; transition: all 0.2s;
        }
        .color-btn:hover { transform: scale(1.15); border-color: rgba(255,255,255,0.5); }
        .color-btn.active { border-color: white; box-shadow: 0 0 8px white; }

        .size-btn {
            width: 38px; height: 38px;
            border: none; border-radius: 6px;
            background: #3d566e; color: white;
            cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .size-btn:hover { background: #e67e22; }
        .size-btn.active { background: #e67e22; }
        .size-dot { background: white; border-radius: 50%; }

        .students-panel {
            background: #2c3e50;
            padding: 6px 15px;
            border-top: 1px solid #34495e;
            max-height: 70px; overflow-y: auto;
            flex-shrink: 0;
        }
        .students-title { font-size: 12px; margin-bottom: 5px; color: #bdc3c7; }
        .students-list { display: flex; flex-wrap: wrap; gap: 6px; }
        .student-chip {
            background: #34495e;
            padding: 4px 10px; border-radius: 30px;
            font-size: 12px; display: flex; align-items: center; gap: 6px;
            border-left: 3px solid #27ae60;
        }

        .connection-status {
            padding: 4px 15px;
            background: #1a2634;
            font-size: 12px; color: #ecf0f1;
            text-align: center;
            border-top: 1px solid #34495e;
            flex-shrink: 0;
        }
        .status-badge {
            display: inline-block; width: 8px; height: 8px;
            border-radius: 50%; margin-right: 4px;
        }
        .status-badge.online { background: #27ae60; box-shadow: 0 0 6px #27ae60; }
        .status-badge.offline { background: #e74c3c; }

        @media (max-width: 768px) {
            .toolbar { padding: 6px 8px; gap: 4px; overflow-x: auto; flex-wrap: nowrap; }
            .tool-btn, .size-btn { width: 34px; height: 34px; font-size: 14px; }
            .color-btn { width: 28px; height: 28px; }
        }
        .toolbar::-webkit-scrollbar { height: 3px; }
        .toolbar::-webkit-scrollbar-thumb { background: #e67e22; border-radius: 2px; }
    </style>
</head>
<body>

<div class="header">
    <div class="logo"><i class="fas fa-chalkboard-teacher"></i> MyClass2 - Ø§Ù„Ù…Ø¯Ø±Ø³</div>
    <div class="header-right">
        <div class="mic-indicator" id="micIndicator">
            <i class="fas fa-microphone"></i> Ø§Ù„Ù…ÙŠÙƒ Ø´ØºØ§Ù„
        </div>
        <div class="online-count">
            <i class="fas fa-users"></i> <span id="onlineCount">0</span> Ø·Ø§Ù„Ø¨
        </div>
    </div>
</div>

<div class="boards-wrapper">
    <div class="board-container">
        <div class="board-header left">
            <span class="board-title"><i class="fas fa-pen-fancy"></i> Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³</span>
            <div class="board-controls">
                <button onclick="clearTeacherBoard()" title="Ù…Ø³Ø­"><i class="fas fa-eraser"></i></button>
            </div>
        </div>
        <div class="canvas-scroll" id="teacherScroll">
            <canvas class="board-canvas" id="teacherCanvas"></canvas>
        </div>
    </div>

    <div class="board-container">
        <div class="board-header right">
            <span class="board-title"><i class="fas fa-users"></i> Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</span>
            <div class="board-controls">
                <button onclick="clearStudentBoard()" title="Ù…Ø³Ø­"><i class="fas fa-eraser"></i></button>
            </div>
        </div>
        <div class="canvas-scroll" id="studentScroll">
            <canvas class="board-canvas" id="studentCanvas"></canvas>
        </div>
    </div>
</div>

<div class="toolbar">
    <div class="tool-group">
        <div class="color-btn active" style="background:#1a1a1a" onclick="changeColor('#1a1a1a', this)"></div>
        <div class="color-btn" style="background:#e74c3c" onclick="changeColor('#e74c3c', this)"></div>
        <div class="color-btn" style="background:#2980b9" onclick="changeColor('#2980b9', this)"></div>
        <div class="color-btn" style="background:#27ae60" onclick="changeColor('#27ae60', this)"></div>
        <div class="color-btn" style="background:#8e44ad" onclick="changeColor('#8e44ad', this)"></div>
        <div class="color-btn" style="background:#e67e22" onclick="changeColor('#e67e22', this)"></div>
    </div>

    <div class="tool-group">
        <button class="size-btn active" id="size1" onclick="changeSize(2, 'size1')">
            <div class="size-dot" style="width:4px;height:4px"></div>
        </button>
        <button class="size-btn" id="size2" onclick="changeSize(5, 'size2')">
            <div class="size-dot" style="width:8px;height:8px"></div>
        </button>
        <button class="size-btn" id="size3" onclick="changeSize(10, 'size3')">
            <div class="size-dot" style="width:14px;height:14px"></div>
        </button>
    </div>

    <div class="tool-group">
        <button class="tool-btn active" id="penBtn" onclick="setPen()"><i class="fas fa-pencil-alt"></i></button>
        <button class="tool-btn" id="eraserBtn" onclick="setEraser()"><i class="fas fa-eraser"></i></button>
        <button class="tool-btn" onclick="clearAllBoards()" style="background:#c0392b"><i class="fas fa-trash-alt"></i></button>
    </div>

    <div class="tool-group">
        <button class="tool-btn" id="audioBtn" onclick="toggleAudio()">
            <i class="fas fa-microphone" id="audioIcon"></i>
        </button>
        <button class="tool-btn" id="studentControlBtn" onclick="toggleStudentDraw()" style="background:#27ae60">
            <i class="fas fa-lock-open" id="lockIcon"></i>
        </button>
    </div>
</div>

<div class="students-panel">
    <div class="students-title"><i class="fas fa-user-graduate"></i> Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†</div>
    <div class="students-list" id="studentsList"></div>
</div>

<div class="connection-status">
    <span class="status-badge online" id="statusBadge"></span>
    <span id="statusText">Ù…ØªØµÙ„</span>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
    firebase.initializeApp({
        apiKey: "AIzaSyB7E4NsGQbCehVSQ3Kj97yExRZwpHzTOl8",
        authDomain: "myclaive.firebaseapp.com",
        databaseURL: "https://myclaive-default-rtdb.firebaseio.com",
        projectId: "myclaive",
        storageBucket: "myclaive.firebasestorage.app",
        messagingSenderId: "507299311714",
        appId: "1:507299311714:web:c90440ee4353cfac17613b"
    });
    const db = firebase.database();

    const teacherCanvas = document.getElementById('teacherCanvas');
    const studentCanvas = document.getElementById('studentCanvas');
    const teacherCtx = teacherCanvas.getContext('2d');
    const studentCtx = studentCanvas.getContext('2d');
    const teacherScroll = document.getElementById('teacherScroll');
    const studentScroll = document.getElementById('studentScroll');

    let drawing = false;
    let currentTool = 'pen';
    let currentColor = '#1a1a1a';
    let currentSize = 2;
    let lastX = 0, lastY = 0;
    let studentsCanDraw = true;
    let audioStream = null;
    let audioActive = false;
    let mediaRecorder = null;
    let chunkIndex = 0;

    // â”€â”€ Ø¨Ø¯Ù„ batch Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙ‚Ø·Ø¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let pendingPoints = [];
    let batchTimer = null;
    let activeRef = null;

    function flushPoints() {
        if (!pendingPoints.length || !activeRef) return;
        activeRef.push({
            pts: pendingPoints.slice(),
            c: currentTool === 'eraser' ? null : currentColor,
            s: currentTool === 'eraser' ? 30 : currentSize,
            e: currentTool === 'eraser' ? 1 : 0,
            ts: Date.now()
        });
        pendingPoints = [];
    }

    function initCanvas() {
        teacherCanvas.width = 2000; teacherCanvas.height = 1500;
        studentCanvas.width = 2000; studentCanvas.height = 1500;
        [teacherCtx, studentCtx].forEach(ctx => {
            ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        });
    }
    initCanvas();

    function getPos(e, canvas, scroll) {
        let clientX, clientY;
        if (e.touches) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; }
        else { clientX = e.clientX; clientY = e.clientY; }
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
            x: (clientX - rect.left) * scaleX + scroll.scrollLeft * scaleX,
            y: (clientY - rect.top) * scaleY + scroll.scrollTop * scaleY
        };
    }

    // Ø±Ø³Ù… Ù…Ø­Ù„ÙŠ Ù†Ø§Ø¹Ù…
    function drawLocalSmooth(ctx, pts, col, sz, erase) {
        if (pts.length < 2) return;
        ctx.save();
        if (erase) {
            ctx.globalCompositeOperation = 'destination-out';
            ctx.strokeStyle = 'rgba(0,0,0,1)';
            ctx.lineWidth = 30;
        } else {
            ctx.globalCompositeOperation = 'source-over';
            ctx.strokeStyle = col;
            ctx.lineWidth = sz;
        }
        ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        ctx.beginPath();
        ctx.moveTo(pts[0].x, pts[0].y);
        for (let i = 1; i < pts.length - 1; i++) {
            const mx = (pts[i].x + pts[i+1].x) / 2;
            const my = (pts[i].y + pts[i+1].y) / 2;
            ctx.quadraticCurveTo(pts[i].x, pts[i].y, mx, my);
        }
        ctx.lineTo(pts[pts.length-1].x, pts[pts.length-1].y);
        ctx.stroke();
        ctx.restore();
    }

    // Ø±Ø³Ù… batch Ù‚Ø§Ø¯Ù… Ù…Ù† Firebase
    function drawBatch(ctx, d) {
        if (!d || !d.pts || !d.pts.length) return;
        ctx.save();
        if (d.e) {
            ctx.globalCompositeOperation = 'destination-out';
            ctx.strokeStyle = 'rgba(0,0,0,1)';
            ctx.lineWidth = 30;
        } else {
            ctx.globalCompositeOperation = 'source-over';
            ctx.strokeStyle = d.c || '#000';
            ctx.lineWidth = d.s || 3;
        }
        ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        ctx.beginPath();
        const pts = d.pts;
        ctx.moveTo(pts[0].x, pts[0].y);
        for (let i = 1; i < pts.length - 1; i++) {
            const mx = (pts[i].x + pts[i+1].x) / 2;
            const my = (pts[i].y + pts[i+1].y) / 2;
            ctx.quadraticCurveTo(pts[i].x, pts[i].y, mx, my);
        }
        ctx.lineTo(pts[pts.length-1].x, pts[pts.length-1].y);
        ctx.stroke();
        ctx.restore();
    }

    // â”€ Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let localPtsT = [];
    function startDrawTeacher(e) {
        e.preventDefault(); drawing = true;
        const pos = getPos(e, teacherCanvas, teacherScroll);
        lastX = pos.x; lastY = pos.y;
        localPtsT = [pos];
        pendingPoints = [pos];
        activeRef = db.ref('teacherDrawings');
    }
    function drawTeacher(e) {
        e.preventDefault();
        if (!drawing) return;
        const pos = getPos(e, teacherCanvas, teacherScroll);
        localPtsT.push(pos);
        pendingPoints.push(pos);
        // Ø±Ø³Ù… Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ (Ø¨Ø¯ÙˆÙ† Firebase)
        applyToolLocal(teacherCtx, pos.x, pos.y);
        // Ø¥Ø±Ø³Ø§Ù„ batch ÙƒÙ„ 40ms
        if (!batchTimer) {
            batchTimer = setTimeout(() => { flushPoints(); batchTimer = null; }, 40);
        }
        lastX = pos.x; lastY = pos.y;
    }
    function stopDrawTeacher() {
        if (!drawing) return; drawing = false;
        if (batchTimer) { clearTimeout(batchTimer); batchTimer = null; }
        flushPoints();
        localPtsT = []; pendingPoints = [];
    }

    // â”€ Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startDrawStudent(e) {
        e.preventDefault(); drawing = true;
        const pos = getPos(e, studentCanvas, studentScroll);
        lastX = pos.x; lastY = pos.y;
        pendingPoints = [pos];
        activeRef = db.ref('teacherDrawingsOnStudent');
    }
    function drawStudent(e) {
        e.preventDefault();
        if (!drawing) return;
        const pos = getPos(e, studentCanvas, studentScroll);
        pendingPoints.push(pos);
        applyToolLocalOnCtx(studentCtx, pos.x, pos.y);
        if (!batchTimer) {
            batchTimer = setTimeout(() => { flushPoints(); batchTimer = null; }, 40);
        }
        lastX = pos.x; lastY = pos.y;
    }
    function stopDrawStudent() {
        if (!drawing) return; drawing = false;
        if (batchTimer) { clearTimeout(batchTimer); batchTimer = null; }
        flushPoints();
        pendingPoints = [];
    }

    function applyToolLocal(ctx, x, y) {
        ctx.save();
        if (currentTool === 'eraser') {
            ctx.globalCompositeOperation = 'destination-out';
            ctx.strokeStyle = 'rgba(0,0,0,1)';
            ctx.lineWidth = 30;
        } else {
            ctx.globalCompositeOperation = 'source-over';
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentSize;
        }
        ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        const mx = (lastX + x) / 2;
        const my = (lastY + y) / 2;
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.quadraticCurveTo(lastX, lastY, mx, my);
        ctx.stroke();
        ctx.restore();
    }
    function applyToolLocalOnCtx(ctx, x, y) { applyToolLocal(ctx, x, y); }

    teacherCanvas.addEventListener('mousedown', startDrawTeacher);
    teacherCanvas.addEventListener('mousemove', drawTeacher);
    teacherCanvas.addEventListener('mouseup', stopDrawTeacher);
    teacherCanvas.addEventListener('mouseleave', stopDrawTeacher);
    teacherCanvas.addEventListener('touchstart', startDrawTeacher, {passive:false});
    teacherCanvas.addEventListener('touchmove', drawTeacher, {passive:false});
    teacherCanvas.addEventListener('touchend', stopDrawTeacher);

    studentCanvas.addEventListener('mousedown', startDrawStudent);
    studentCanvas.addEventListener('mousemove', drawStudent);
    studentCanvas.addEventListener('mouseup', stopDrawStudent);
    studentCanvas.addEventListener('mouseleave', stopDrawStudent);
    studentCanvas.addEventListener('touchstart', startDrawStudent, {passive:false});
    studentCanvas.addEventListener('touchmove', drawStudent, {passive:false});
    studentCanvas.addEventListener('touchend', stopDrawStudent);

    // â”€ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ù… Ø§Ù„Ø·Ù„Ø§Ø¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    db.ref('studentDrawings').on('child_added', snap => {
        const d = snap.val(); if (!d) return;
        drawBatch(studentCtx, d);
    });

    // â”€ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø³Ø­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    db.ref('teacherCommands').on('child_added', snap => {
        const d = snap.val();
        if (d && d.type === 'clear') {
            teacherCtx.clearRect(0, 0, teacherCanvas.width, teacherCanvas.height);
            studentCtx.clearRect(0, 0, studentCanvas.width, studentCanvas.height);
        }
    });

    // â”€ Ø£Ø¯ÙˆØ§Øª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function changeColor(color, el) {
        currentColor = color; currentTool = 'pen';
        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('penBtn').classList.add('active');
        document.getElementById('eraserBtn').classList.remove('active');
    }
    function changeSize(size, btnId) {
        currentSize = size;
        document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(btnId).classList.add('active');
    }
    function setPen() {
        currentTool = 'pen';
        document.getElementById('penBtn').classList.add('active');
        document.getElementById('eraserBtn').classList.remove('active');
    }
    function setEraser() {
        currentTool = 'eraser';
        document.getElementById('eraserBtn').classList.add('active');
        document.getElementById('penBtn').classList.remove('active');
    }
    function clearTeacherBoard() {
        teacherCtx.clearRect(0, 0, teacherCanvas.width, teacherCanvas.height);
    }
    function clearStudentBoard() {
        studentCtx.clearRect(0, 0, studentCanvas.width, studentCanvas.height);
    }
    function clearAllBoards() {
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø³Ø¨ÙˆØ±Ø§ØªØŸ')) return;
        teacherCtx.clearRect(0, 0, teacherCanvas.width, teacherCanvas.height);
        studentCtx.clearRect(0, 0, studentCanvas.width, studentCanvas.height);
        db.ref('teacherCommands').push({ type: 'clear', ts: Date.now() });
    }
    function toggleStudentDraw() {
        studentsCanDraw = !studentsCanDraw;
        const btn = document.getElementById('studentControlBtn');
        btn.innerHTML = studentsCanDraw ? '<i class="fas fa-lock-open"></i>' : '<i class="fas fa-lock"></i>';
        btn.style.background = studentsCanDraw ? '#27ae60' : '#e74c3c';
        db.ref('teacherControls').set({ studentsCanDraw });
    }

    // â”€ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† (ØµÙˆØª Ø§Ù„Ù…Ø¯Ø±Ø³ Ù„Ù„Ø·Ù„Ø§Ø¨) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getSupportedMimeType() {
        const types = ['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/mp4'];
        for (const t of types) if (MediaRecorder.isTypeSupported(t)) return t;
        return '';
    }
    function blobToBase64(blob) {
        return new Promise(res => {
            const r = new FileReader();
            r.onloadend = () => res(r.result);
            r.readAsDataURL(blob);
        });
    }

    async function toggleAudio() {
        const btn  = document.getElementById('audioBtn');
        const icon = document.getElementById('audioIcon');
        const ind  = document.getElementById('micIndicator');

        if (!audioActive) {
            icon.className = 'fas fa-spinner fa-spin';
            btn.disabled = true;
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
                });
                audioActive = true; chunkIndex = 0;
                btn.disabled = false;
                btn.classList.add('mic-on');
                icon.className = 'fas fa-microphone-slash';
                ind.classList.add('active');
                document.getElementById('statusText').textContent = 'ðŸŽ¤ Ù…Ø§ÙŠÙƒ Ø´ØºÙ‘Ø§Ù„';

                db.ref('audioMeta').set({ active: true, ts: Date.now() });
                db.ref('audioChunks').remove();

                const mime = getSupportedMimeType();
                mediaRecorder = new MediaRecorder(audioStream, mime ? { mimeType: mime } : {});
                mediaRecorder.ondataavailable = async ev => {
                    if (!ev.data || ev.data.size < 50) return;
                    const b64 = await blobToBase64(ev.data);
                    const slot = chunkIndex % 20;
                    db.ref('audioChunks/' + slot).set({ d: b64, i: chunkIndex, ts: Date.now() });
                    chunkIndex++;
                };
                mediaRecorder.start(300);

            } catch (err) {
                btn.disabled = false;
                icon.className = 'fas fa-microphone';
                alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†:\n' + err.message);
            }
        } else {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            if (audioStream) audioStream.getTracks().forEach(t => t.stop());
            mediaRecorder = null; audioStream = null; audioActive = false;
            btn.classList.remove('mic-on');
            icon.className = 'fas fa-microphone';
            ind.classList.remove('active');
            document.getElementById('statusText').textContent = 'Ù…ØªØµÙ„';
            db.ref('audioMeta').set({ active: false });
            db.ref('audioChunks').remove();
        }
    }

    // â”€ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØµÙˆØª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let teacherAC = null;
    const seenStudentChunks = new Set();
    let tNextTime = 0;

    function getTeacherAC() {
        if (!teacherAC || teacherAC.state === 'closed')
            teacherAC = new (window.AudioContext || window.webkitAudioContext)();
        if (teacherAC.state === 'suspended') teacherAC.resume();
        return teacherAC;
    }

    async function playStudentAudio(d) {
        if (!d || !d.d) return;
        if (seenStudentChunks.has(d.i)) return;
        seenStudentChunks.add(d.i);
        try {
            const ac  = getTeacherAC();
            const b64 = d.d;
            const comma = b64.indexOf(',');
            const raw = comma >= 0 ? b64.slice(comma + 1) : b64;
            const bin = atob(raw);
            const buf = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) buf[i] = bin.charCodeAt(i);
            const decoded = await ac.decodeAudioData(buf.buffer.slice(0));
            const src = ac.createBufferSource();
            src.buffer = decoded;
            src.connect(ac.destination);
            const now = ac.currentTime;
            if (tNextTime < now) tNextTime = now + 0.05;
            src.start(tNextTime);
            tNextTime += decoded.duration;
        } catch(e) {}
    }

    db.ref('studentAudio').on('child_changed', snap => {
        const v = snap.val(); if (!v) return;
        Object.values(v).forEach(chunk => playStudentAudio(chunk));
    });
    db.ref('studentAudio').on('child_added', snap => {
        const v = snap.val(); if (!v) return;
        Object.values(v).forEach(chunk => playStudentAudio(chunk));
    });

    // â”€ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    db.ref('onlineStudents').on('value', snap => {
        const students = snap.val() || {};
        const list  = document.getElementById('studentsList');
        const count = document.getElementById('onlineCount');
        list.innerHTML = '';
        const keys = Object.keys(students);
        count.textContent = keys.length;
        keys.forEach(k => {
            const chip = document.createElement('div');
            chip.className = 'student-chip';
            chip.innerHTML = `<i class="fas fa-user-graduate"></i> Ø·Ø§Ù„Ø¨`;
            list.appendChild(chip);
        });
    });

    db.ref('.info/connected').on('value', snap => {
        document.getElementById('statusBadge').className = 'status-badge ' + (snap.val() ? 'online' : 'offline');
        document.getElementById('statusText').textContent = snap.val() ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„';
    });

    db.ref('teacher/online').set({ online: true, ts: Date.now() });
    db.ref('teacherControls').set({ studentsCanDraw: true });
    document.body.addEventListener('click', () => { try { getTeacherAC(); } catch(e){} }, { once: true });
    [teacherCanvas, studentCanvas].forEach(c => c.addEventListener('contextmenu', e => e.preventDefault()));
    setPen();
</script>
</body>
</html>
