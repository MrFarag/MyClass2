<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>MyClass2 - النظام المتكامل</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{
    --bl:#3b82f6;--rd:#ef4444;--gn:#22c55e;--yw:#f59e0b;--dk:#0f172a;--cd:#1e293b;--br:#334155;--mt:#475569;--dm:#94a3b8;
    --board-bg: #fdfbf7; 
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Cairo',sans-serif}
html,body{height:100%;overflow:hidden;background:var(--dk);color:#fff}

.hdr{background:var(--cd);height:50px;padding:0 14px;display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid var(--br);z-index:100}
.logo{font-size:19px;font-weight:900;color:var(--bl)}.logo span{color:#fff}
.hstats{display:flex;gap:8px}
.chip{background:var(--br);padding:4px 12px;border-radius:20px;font-size:12px;display:flex;align-items:center;gap:6px}

#shell{display:flex;flex-direction:column;height:calc(100vh - 50px)}
.main{display:flex;flex:1;overflow:hidden;min-height:0}

.content{flex:1;display:flex;flex-direction:column;padding:12px;background: #111827;}
.bwrap{
    flex:1; background:var(--board-bg); position:relative; overflow:hidden; border-radius:12px;
    border: 10px solid #475569; box-shadow: inset 0 0 20px rgba(0,0,0,0.1), 0 15px 35px rgba(0,0,0,0.4);
}
#mc{display:block;position:absolute;top:0;left:0;width:100%;height:100%;touch-action:none;cursor:crosshair}

.sidebar{width:230px;background:var(--cd);border-left:1px solid var(--br);display:flex;flex-direction:column}
.sdt{padding:12px;font-size:11px;color:var(--bl);border-bottom:1px solid var(--br);font-weight:900;text-align:center}
.slist{flex:1;overflow-y:auto;padding:8px}

.toolbar{background:var(--cd);padding:10px;display:flex;align-items:center;gap:8px;border-top:1px solid var(--br);overflow-x:auto}
.tb{min-width:40px;height:40px;border-radius:10px;background:var(--br);color:var(--dm);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center}
.tb.on{background:var(--bl);color:#fff}
.tb:hover{background:var(--mt)}

.shapepanel{position:absolute;bottom:75px;left:20px;background:var(--cd);border:1px solid var(--br);border-radius:15px;padding:12px;display:none;grid-template-columns:repeat(4,1fr);gap:10px;z-index:200;box-shadow:0 10px 40px rgba(0,0,0,0.6)}
.shapepanel.on{display:grid}
.shbtn{width:42px;height:42px;background:var(--br);border:none;border-radius:8px;color:#fff;cursor:pointer;transition:.2s}
.shbtn:hover{background:var(--bl);transform:scale(1.1)}

#toasts{position:fixed;top:60px;left:50%;transform:translateX(-50%);z-index:1000;display:flex;flex-direction:column;gap:10px;width:320px}
.toast{background:var(--cd);padding:15px;border-radius:12px;display:flex;align-items:center;justify-content:space-between;border-right:4px solid var(--bl);box-shadow:0 5px 15px rgba(0,0,0,0.3);animation:slideUp 0.3s ease}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}

#txtbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:2000;align-items:center;justify-content:center}
.txtin{background:var(--cd);padding:25px;border-radius:20px;width:300px;border:1px solid var(--bl)}
.txtin input{width:100%;padding:12px;margin:15px 0;background:var(--dk);border:1px solid var(--br);color:#fff;border-radius:10px}
</style>
</head>
<body>

<div class="hdr">
    <div class="logo">My<span>Class</span>2</div>
    <div class="hstats">
        <div class="chip"><i class="fas fa-users"></i> <span id="cnt">0</span></div>
        <div class="chip" id="hbtn" style="cursor:pointer"><i class="fas fa-hand-paper" style="color:var(--yw)"></i> <span id="hcnt">0</span></div>
    </div>
</div>

<div id="shell">
    <div class="main">
        <div class="content">
            <div class="bwrap" id="bwrap">
                <canvas id="mc"></canvas>
            </div>
            <div class="toolbar">
                <button class="tb on" id="bpen" onclick="setTool('pen')"><i class="fas fa-pencil-alt"></i></button>
                <button class="tb" id="bera" onclick="setTool('eraser')"><i class="fas fa-eraser"></i></button>
                <button class="tb" onclick="toggleShapes()"><i class="fas fa-shapes"></i></button>
                <div style="width:2px;height:25px;background:var(--br)"></div>
                <div id="clrs" style="display:flex;gap:6px">
                    <div onclick="setClr('#1e293b',this)" class="cl" style="width:26px;height:26px;border-radius:50%;background:#1e293b;cursor:pointer;border:2px solid #fff"></div>
                    <div onclick="setClr('#ef4444',this)" class="cl" style="width:26px;height:26px;border-radius:50%;background:#ef4444;cursor:pointer"></div>
                </div>
                <button class="tb" onclick="doUndo()" style="margin-right:auto"><i class="fas fa-undo"></i></button>
                <button class="tb" id="micbtn" onclick="toggleMic()"><i class="fas fa-microphone-slash"></i></button>
                <button class="tb" onclick="clearBoard()" style="color:var(--rd)"><i class="fas fa-trash"></i></button>
            </div>
            <div class="shapepanel" id="shapepanel">
                <button class="shbtn" onclick="setShape('line')"><i class="fas fa-minus"></i></button>
                <button class="shbtn" onclick="setShape('arrow')"><i class="fas fa-arrow-left"></i></button>
                <button class="shbtn" onclick="setShape('rect')"><i class="far fa-square"></i></button>
                <button class="shbtn" onclick="setShape('circle')"><i class="far fa-circle"></i></button>
                <button class="shbtn" onclick="setShape('triangle')"><i class="fas fa-caret-up"></i></button>
                <button class="shbtn" onclick="setShape('cylinder')"><i class="fas fa-database"></i></button>
                <button class="shbtn" onclick="setShape('cube')"><i class="fas fa-cube"></i></button>
                <button class="shbtn" onclick="setShape('star')"><i class="fas fa-star"></i></button>
                <button class="shbtn" onclick="setShape('chart')"><i class="fas fa-chart-bar"></i></button>
                <button class="shbtn" onclick="setTool('text')"><i class="fas fa-font"></i></button>
            </div>
        </div>
        <div class="sidebar">
            <div class="sdt">الطلاب في الحصة</div>
            <div class="slist" id="slist"></div>
        </div>
    </div>
</div>

<div id="toasts"></div>
<div id="txtbox">
    <div class="txtin">
        <h3>إضافة نص</h3>
        <input type="text" id="txtinput" placeholder="اكتب هنا...">
        <div style="display:flex;gap:10px">
            <button onclick="confirmText()" style="flex:1;background:var(--bl);border:none;color:#fff;padding:10px;border-radius:10px">إضافة</button>
            <button onclick="document.getElementById('txtbox').style.display='none'" style="flex:1;background:var(--br);border:none;color:#fff;padding:10px;border-radius:10px">إلغاء</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
firebase.initializeApp({
  apiKey:"AIzaSyB7E4NsGQbCehVSQ3Kj97yExRZwpHzTOl8",
  authDomain:"myclaive.firebaseapp.com",
  databaseURL:"https://myclaive-default-rtdb.firebaseio.com",
  projectId:"myclaive",
  storageBucket:"myclaive.firebasestorage.app",
  messagingSenderId:"507299311714",
  appId:"1:507299311714:web:c90440ee4353cfac17613b"
});
const db=firebase.database();

// ── التصفير الجذري عند التشغيل ──
db.ref('onlineStudents').remove();
db.ref('approvedStudents').remove();
db.ref('joinRequests').remove();
db.ref('handRaised').remove();
db.ref('micRequests').remove();

let tool='pen', shape=null, clr='#1e293b', sz=4, down=false, sx, sy, snap, txtPos;
let hist=[], micOn=false, mStream, mRec;
const canvas=document.getElementById('mc'), ctx=canvas.getContext('2d');

function fit(){
    canvas.width=canvas.parentElement.offsetWidth;
    canvas.height=canvas.parentElement.offsetHeight;
    ctx.fillStyle='#fdfbf7'; ctx.fillRect(0,0,canvas.width,canvas.height);
}
window.onresize=fit; setTimeout(fit,100);

// ── منطق الرسم والأشكال ──
canvas.onmousedown=(e)=>{
    const p=getXY(e); sx=p.x; sy=p.y; down=true;
    if(tool==='text'){ txtPos=p; document.getElementById('txtbox').style.display='flex'; down=false; return; }
    if(tool==='shape'){ snap=ctx.getImageData(0,0,canvas.width,canvas.height); return; }
    ctx.beginPath(); ctx.moveTo(sx,sy);
};
canvas.onmousemove=(e)=>{
    if(!down)return; const p=getXY(e);
    if(tool==='shape'){ ctx.putImageData(snap,0,0); drawShape(ctx,shape,sx,sy,p.x,p.y); return; }
    ctx.lineWidth=tool==='eraser'?40:sz; ctx.strokeStyle=tool==='eraser'?'#fdfbf7':clr;
    ctx.lineCap='round'; ctx.lineTo(p.x,p.y); ctx.stroke();
};
canvas.onmouseup=()=>{
    if(!down)return; down=false;
    hist.push(ctx.getImageData(0,0,canvas.width,canvas.height));
    db.ref('boardImg/main').set({data:canvas.toDataURL('image/jpeg',0.5), ts:Date.now()});
};

function getXY(e){
    const r=canvas.getBoundingClientRect();
    return {x:(e.clientX-r.left)*(canvas.width/r.width),y:(e.clientY-r.top)*(canvas.height/r.height)};
}

function drawShape(c,s,x1,y1,x2,y2){
    c.strokeStyle=clr; c.lineWidth=sz; c.beginPath();
    const w=x2-x1, h=y2-y1;
    if(s==='line'){c.moveTo(x1,y1);c.lineTo(x2,y2);}
    else if(s==='rect'){c.strokeRect(x1,y1,w,h);}
    else if(s==='circle'){c.ellipse(x1+w/2,y1+h/2,Math.abs(w/2),Math.abs(h/2),0,0,7);}
    else if(s==='arrow'){
        c.moveTo(x1,y1);c.lineTo(x2,y2);c.stroke();
        const a=Math.atan2(h,w); c.translate(x2,y2); c.rotate(a);
        c.moveTo(0,0);c.lineTo(-15,-8);c.lineTo(-15,8);c.closePath();c.fillStyle=clr;c.fill();
    }
    c.stroke();
}

function confirmText(){
    const t=document.getElementById('txtinput').value;
    if(t){ ctx.font="bold 20px Cairo"; ctx.fillStyle=clr; ctx.fillText(t,txtPos.x,txtPos.y); }
    document.getElementById('txtbox').style.display='none';
}

function toggleShapes(){document.getElementById('shapepanel').classList.toggle('on');}
function setTool(t){tool=t; shape=null; document.querySelectorAll('.tb').forEach(b=>b.classList.remove('on')); document.getElementById('b'+t.substring(0,3))?.classList.add('on');}
function setShape(s){shape=s; tool='shape'; toggleShapes();}
function setClr(c,el){clr=c; document.querySelectorAll('.cl').forEach(i=>i.style.border='none'); el.style.border='2px solid #fff';}
function doUndo(){if(hist.length>0)ctx.putImageData(hist.pop(),0,0);}
function clearBoard(){ctx.fillStyle='#fdfbf7';ctx.fillRect(0,0,canvas.width,canvas.height); db.ref('boardCmd').push({type:'clear'});}

// ── الميكروفون والطلاب ──
async function toggleMic(){
    const btn=document.getElementById('micbtn');
    if(!micOn){
        mStream=await navigator.mediaDevices.getUserMedia({audio:true});
        mRec=new MediaRecorder(mStream);
        mRec.ondataavailable=ev=>{
            const r=new FileReader(); r.onload=()=>db.ref('audio/chunk').set({data:r.result,ts:Date.now()});
            r.readAsDataURL(ev.data);
        };
        mRec.start(500); micOn=true; btn.innerHTML='<i class="fas fa-microphone"></i>'; btn.classList.add('on');
        setInterval(()=>{if(mRec.state==='recording'){mRec.stop();mRec.start(500);}},550);
    }else{
        mStream.getTracks().forEach(t=>t.stop()); micOn=false; btn.innerHTML='<i class="fas fa-microphone-slash"></i>'; btn.classList.remove('on');
    }
}

// ── الأذونات والتنبيهات ──
db.ref('joinRequests').on('child_added', snap=>{
    const s=snap.val();
    const t=document.createElement('div'); t.className='toast';
    t.innerHTML=`<span>${s.name} يطلب الدخول</span> <button onclick="approve('${s.id}','${s.name}',this)" style="background:var(--gn);border:none;padding:5px 10px;color:#fff;border-radius:5px">قبول</button>`;
    document.getElementById('toasts').appendChild(t);
});

function approve(id,name,btn){
    db.ref('approvedStudents/'+id).set({id,name});
    btn.parentElement.remove();
}

db.ref('onlineStudents').on('value', snap=>{
    const list=document.getElementById('slist'), data=snap.val()||{};
    document.getElementById('cnt').textContent=Object.keys(data).length;
    list.innerHTML=Object.keys(data).map(k=>`<div style="padding:10px;background:rgba(255,255,255,0.05);margin-bottom:5px;border-radius:8px;font-size:13px"><i class="fas fa-circle" style="color:var(--gn);font-size:8px"></i> ${data[k].name}</div>`).join('');
});
</script>
</body>
</html>
