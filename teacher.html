<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MyClass2 - Ø§Ù„Ù…Ø¯Ø±Ø³</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100dvh;overflow:hidden;font-family:'Segoe UI',sans-serif;background:#1a2634;color:#fff;display:flex;flex-direction:column}
.hdr{height:48px;min-height:48px;background:#2c3e50;display:flex;align-items:center;justify-content:space-between;padding:0 14px;border-bottom:3px solid #e67e22;flex-shrink:0;gap:8px}
.logo{font-size:15px;font-weight:bold;white-space:nowrap}
.logo i{color:#e67e22;margin-left:6px}
.hdr-r{display:flex;align-items:center;gap:8px}
.badge{padding:4px 12px;border-radius:20px;font-size:12px;display:flex;align-items:center;gap:5px;background:#27ae60}
.mic-ind{display:none;align-items:center;gap:5px;background:#e74c3c;padding:4px 12px;border-radius:20px;font-size:12px;animation:p1 1s infinite}
.mic-ind.on{display:flex}
@keyframes p1{0%,100%{opacity:1}50%{opacity:.5}}
.boards{flex:1;display:flex;padding:6px;gap:6px;overflow:hidden;min-height:0}
@media(max-width:768px){.boards{flex-direction:column}}
.board{flex:1;display:flex;flex-direction:column;background:#2c3e50;border-radius:10px;overflow:hidden;min-height:0}
.bh{padding:8px 12px;background:#34495e;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;border-bottom:2px solid #e67e22}
.bh.b{border-bottom-color:#3498db}
.bh span{font-size:13px;font-weight:bold}
.bh button{background:rgba(255,255,255,.1);border:none;color:#fff;width:30px;height:30px;border-radius:6px;cursor:pointer;font-size:13px;margin-right:4px}
.bh button:hover{background:#e67e22}
.cscroll{flex:1;overflow:auto;background:#ccc;-webkit-overflow-scrolling:touch;min-height:0}
canvas{display:block;width:2000px;height:1500px;background:#fff;touch-action:none;cursor:crosshair}
.tb{background:#34495e;padding:8px;display:flex;flex-wrap:wrap;gap:5px;align-items:center;border-top:2px solid #e67e22;flex-shrink:0}
@media(max-width:768px){.tb{flex-wrap:nowrap;overflow-x:auto;padding:6px 8px}}
.tb::-webkit-scrollbar{height:3px}
.tb::-webkit-scrollbar-thumb{background:#e67e22;border-radius:2px}
.tg{display:flex;gap:3px;background:#2c3e50;padding:4px;border-radius:8px}
.cb{width:30px;height:30px;border-radius:50%;border:3px solid transparent;cursor:pointer;transition:.15s;flex-shrink:0}
.cb.on,.cb:hover{border-color:#fff;transform:scale(1.1)}
.btn{width:36px;height:36px;border:none;border-radius:6px;background:#3d566e;color:#fff;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:.2s}
.btn:hover,.btn.on{background:#e67e22}
.btn.del{background:#c0392b}.btn.del:hover{background:#e74c3c}
.btn.mic-on{background:#e74c3c!important;animation:mp 1.5s infinite}
@keyframes mp{0%,100%{box-shadow:0 0 0 0 rgba(231,76,60,.5)}50%{box-shadow:0 0 0 8px transparent}}
.szd{background:#fff;border-radius:50%}
.students{background:#2c3e50;padding:5px 14px;border-top:1px solid #34495e;max-height:46px;overflow-y:auto;flex-shrink:0}
.slist{display:flex;flex-wrap:wrap;gap:5px}
.chip{background:#34495e;padding:3px 10px;border-radius:20px;font-size:11px;display:flex;align-items:center;gap:5px;border-right:3px solid #27ae60}
.sbar{height:30px;min-height:30px;background:#111b27;border-top:1px solid #243447;display:flex;align-items:center;justify-content:space-between;padding:0 12px;font-size:11px;color:#aab8c8;flex-shrink:0}
.dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.dot.on{background:#27ae60;box-shadow:0 0 5px #27ae60}
.dot.off{background:#e74c3c}
</style>
</head>
<body>
<div class="hdr">
  <div class="logo"><i class="fas fa-chalkboard-teacher"></i>MyClass2 â€” Ø§Ù„Ù…Ø¯Ø±Ø³</div>
  <div class="hdr-r">
    <div class="mic-ind" id="micInd"><i class="fas fa-microphone"></i> Ù…Ø§ÙŠÙƒ Ø´ØºÙ‘Ø§Ù„</div>
    <div class="badge"><i class="fas fa-users"></i><span id="cnt">0</span></div>
  </div>
</div>

<div class="boards">
  <div class="board">
    <div class="bh">
      <span><i class="fas fa-pen-fancy" style="color:#e67e22"></i> Ø³Ø¨ÙˆØ±ØªÙŠ</span>
      <div><button onclick="clearT()"><i class="fas fa-eraser"></i></button></div>
    </div>
    <div class="cscroll" id="ts"><canvas id="tc"></canvas></div>
  </div>
  <div class="board">
    <div class="bh b">
      <span><i class="fas fa-users" style="color:#3498db"></i> Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</span>
      <div><button onclick="clearS()"><i class="fas fa-eraser"></i></button></div>
    </div>
    <div class="cscroll" id="ss"><canvas id="sc"></canvas></div>
  </div>
</div>

<div class="tb">
  <div class="tg">
    <div class="cb on" style="background:#111" onclick="setClr('#111',this)"></div>
    <div class="cb" style="background:#e74c3c" onclick="setClr('#e74c3c',this)"></div>
    <div class="cb" style="background:#2980b9" onclick="setClr('#2980b9',this)"></div>
    <div class="cb" style="background:#27ae60" onclick="setClr('#27ae60',this)"></div>
    <div class="cb" style="background:#8e44ad" onclick="setClr('#8e44ad',this)"></div>
    <div class="cb" style="background:#e67e22" onclick="setClr('#e67e22',this)"></div>
    <div class="cb" style="background:#fff;border:2px solid #999" onclick="setClr('#fff',this)"></div>
  </div>
  <div class="tg">
    <button class="btn on" id="sz1" onclick="setSz(2,'sz1')"><div class="szd" style="width:4px;height:4px"></div></button>
    <button class="btn" id="sz2" onclick="setSz(5,'sz2')"><div class="szd" style="width:8px;height:8px"></div></button>
    <button class="btn" id="sz3" onclick="setSz(12,'sz3')"><div class="szd" style="width:14px;height:14px"></div></button>
  </div>
  <div class="tg">
    <button class="btn on" id="penBtn" onclick="setTool('pen')"><i class="fas fa-pencil-alt"></i></button>
    <button class="btn" id="eraserBtn" onclick="setTool('eraser')"><i class="fas fa-eraser"></i></button>
    <button class="btn del" onclick="clearAll()"><i class="fas fa-trash-alt"></i></button>
  </div>
  <div class="tg">
    <button class="btn" id="micBtn" onclick="toggleMic()" title="Ù…Ø§ÙŠÙƒ Ø§Ù„Ù…Ø¯Ø±Ø³"><i class="fas fa-microphone" id="micIcon"></i></button>
    <button class="btn" id="lockBtn" onclick="toggleLock()" style="background:#27ae60"><i class="fas fa-lock-open" id="lockIcon"></i></button>
  </div>
</div>

<div class="students"><div class="slist" id="slist"></div></div>
<div class="sbar">
  <div style="display:flex;align-items:center;gap:6px"><span class="dot on" id="dotEl"></span><span id="stEl">Ù…ØªØµÙ„</span></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
firebase.initializeApp({
  apiKey:"AIzaSyB7E4NsGQbCehVSQ3Kj97yExRZwpHzTOl8",
  authDomain:"myclaive.firebaseapp.com",
  databaseURL:"https://myclaive-default-rtdb.firebaseio.com",
  projectId:"myclaive",
  storageBucket:"myclaive.firebasestorage.app",
  messagingSenderId:"507299311714",
  appId:"1:507299311714:web:c90440ee4353cfac17613b"
});
const db = firebase.database();

// â”€â”€ Canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const tc = document.getElementById('tc');
const sc = document.getElementById('sc');
const tx = tc.getContext('2d');
const sx = sc.getContext('2d');
const ts = document.getElementById('ts');
const ss = document.getElementById('ss');
tc.width=2000; tc.height=1500;
sc.width=2000; sc.height=1500;
[tx,sx].forEach(c=>{c.lineCap='round';c.lineJoin='round'});

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tool='pen', clr='#111', sz=2;
let drawing=false, lx=0, ly=0;
let canDraw=true;
let micOn=false, micStream=null, mediaRec=null;
let studentsCanDraw=true;

// â”€â”€ Ù…ÙˆÙ‚Ø¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pos(e, canvas, scroll) {
  let cx = e.touches ? e.touches[0].clientX : e.clientX;
  let cy = e.touches ? e.touches[0].clientY : e.clientY;
  const r = canvas.getBoundingClientRect();
  // Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ 2000px Ø¹Ø±Ø¶Ù‡ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ = r.width
  const scaleX = 2000 / r.width;
  const scaleY = 1500 / r.height;
  return {
    x: (cx - r.left + scroll.scrollLeft) * scaleX,
    y: (cy - r.top  + scroll.scrollTop)  * scaleY
  };
}

// â”€â”€ Ø±Ø³Ù… Ù†Ø§Ø¹Ù… Ù…Ø­Ù„ÙŠ + Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø§Ù„ÙÙƒØ±Ø©: Ù†Ø±Ø³Ù… Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙˆØ±Ø§Ù‹ØŒ ÙˆÙ†Ø±Ø³Ù„ ÙƒÙ„ stroke ÙƒÙ€ object ÙˆØ§Ø­Ø¯ Ø¹Ù†Ø¯ Ø§Ù„Ø±ÙØ¹
let strokePts = [];   // Ù†Ù‚Ø§Ø· Ø§Ù„Ù€ stroke Ø§Ù„Ø­Ø§Ù„ÙŠ
let activeRef = null;
let activeCvs = null;
let activeScroll = null;

function applyCtx(ctx, x1, y1, x2, y2) {
  ctx.save();
  if (tool==='eraser') {
    ctx.globalCompositeOperation='destination-out';
    ctx.strokeStyle='rgba(0,0,0,1)';
    ctx.lineWidth=30;
  } else {
    ctx.globalCompositeOperation='source-over';
    ctx.strokeStyle=clr; ctx.lineWidth=sz;
  }
  ctx.lineCap='round'; ctx.lineJoin='round';
  ctx.beginPath(); ctx.moveTo(x1,y1);
  // Ù…Ù†ØªØµÙ Ù„Ù„Ù€ quadratic â†’ Ø®Ø· Ù†Ø§Ø¹Ù… Ø¨Ø¯ÙˆÙ† ØªÙ‚Ø·Ø¹
  const mx=(x1+x2)/2, my=(y1+y2)/2;
  ctx.quadraticCurveTo(x1,y1,mx,my);
  ctx.stroke(); ctx.restore();
}

function startD(cvs, scr, ref, e) {
  e.preventDefault(); drawing=true;
  activeCvs=cvs; activeRef=ref; activeScroll=scr;
  const p=pos(e,cvs,scr); lx=p.x; ly=p.y;
  strokePts=[{x:p.x,y:p.y}];
  // Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
  const ctx = cvs===tc ? tx : sx;
  ctx.save();
  if(tool==='eraser'){ctx.globalCompositeOperation='destination-out';ctx.fillStyle='rgba(0,0,0,1)';}
  else{ctx.globalCompositeOperation='source-over';ctx.fillStyle=clr;}
  ctx.beginPath(); ctx.arc(p.x,p.y,sz/2,0,Math.PI*2); ctx.fill(); ctx.restore();
}

function moveD(e) {
  e.preventDefault(); if(!drawing)return;
  const p=pos(e,activeCvs,activeScroll);
  const ctx=activeCvs===tc?tx:sx;
  applyCtx(ctx,lx,ly,p.x,p.y);
  strokePts.push({x:p.x,y:p.y});
  lx=p.x; ly=p.y;
}

function stopD() {
  if(!drawing)return; drawing=false;
  if(strokePts.length<1)return;
  // Ø£Ø±Ø³Ù„ Ø§Ù„Ù€ stroke ÙƒØ§Ù…Ù„Ø§Ù‹ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
  activeRef.push({
    pts: strokePts,
    c:   tool==='eraser'?null:clr,
    s:   tool==='eraser'?30:sz,
    e:   tool==='eraser'?1:0,
    ts:  Date.now()
  });
  strokePts=[];
}

tc.addEventListener('mousedown',  e=>startD(tc,ts,db.ref('teacherDrawings'),e));
tc.addEventListener('mousemove',  moveD);
tc.addEventListener('mouseup',    stopD);
tc.addEventListener('mouseleave', stopD);
tc.addEventListener('touchstart', e=>startD(tc,ts,db.ref('teacherDrawings'),e),{passive:false});
tc.addEventListener('touchmove',  moveD,{passive:false});
tc.addEventListener('touchend',   stopD);

sc.addEventListener('mousedown',  e=>startD(sc,ss,db.ref('teacherDrawingsOnStudent'),e));
sc.addEventListener('mousemove',  moveD);
sc.addEventListener('mouseup',    stopD);
sc.addEventListener('mouseleave', stopD);
sc.addEventListener('touchstart', e=>startD(sc,ss,db.ref('teacherDrawingsOnStudent'),e),{passive:false});
sc.addEventListener('touchmove',  moveD,{passive:false});
sc.addEventListener('touchend',   stopD);

// â”€â”€ Ø±Ø³Ù… stroke Ù‚Ø§Ø¯Ù… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStroke(ctx, d) {
  if(!d||!d.pts||!d.pts.length)return;
  const pts=d.pts;
  ctx.save();
  if(d.e){ctx.globalCompositeOperation='destination-out';ctx.strokeStyle='rgba(0,0,0,1)';ctx.lineWidth=30;}
  else{ctx.globalCompositeOperation='source-over';ctx.strokeStyle=d.c||'#000';ctx.lineWidth=d.s||3;}
  ctx.lineCap='round'; ctx.lineJoin='round';
  // Ù†Ù‚Ø·Ø© Ø£ÙˆÙ„Ù‰
  ctx.beginPath();
  if(d.e){ctx.fillStyle='rgba(0,0,0,1)';}else{ctx.fillStyle=d.c||'#000';}
  ctx.arc(pts[0].x,pts[0].y,(d.s||3)/2,0,Math.PI*2); ctx.fill();
  // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ù€ quadratic
  ctx.beginPath(); ctx.moveTo(pts[0].x,pts[0].y);
  for(let i=1;i<pts.length;i++){
    const prev=pts[i-1], cur=pts[i];
    const mx=(prev.x+cur.x)/2, my=(prev.y+cur.y)/2;
    ctx.quadraticCurveTo(prev.x,prev.y,mx,my);
  }
  ctx.lineTo(pts[pts.length-1].x,pts[pts.length-1].y);
  ctx.stroke(); ctx.restore();
}

// â”€â”€ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ù… Ø§Ù„Ø·Ù„Ø§Ø¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
db.ref('studentDrawings').on('child_added', snap=>renderStroke(sx,snap.val()));

// â”€â”€ Ø£ÙˆØ§Ù…Ø± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
db.ref('teacherCommands').on('child_added', snap=>{
  const d=snap.val(); if(d&&d.type==='clear'){tx.clearRect(0,0,2000,1500);sx.clearRect(0,0,2000,1500);}
});

// â”€â”€ Ø£Ø¯ÙˆØ§Øª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setClr(c,el){clr=c;tool='pen';document.querySelectorAll('.cb').forEach(b=>b.classList.remove('on'));el.classList.add('on');setTool('pen');}
function setSz(s,id){sz=s;document.querySelectorAll('#sz1,#sz2,#sz3').forEach(b=>b.classList.remove('on'));document.getElementById(id).classList.add('on');}
function setTool(t){tool=t;document.getElementById('penBtn').classList.toggle('on',t==='pen');document.getElementById('eraserBtn').classList.toggle('on',t==='eraser');}
function clearT(){tx.clearRect(0,0,2000,1500);}
function clearS(){sx.clearRect(0,0,2000,1500);}
function clearAll(){if(!confirm('Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ'))return;tx.clearRect(0,0,2000,1500);sx.clearRect(0,0,2000,1500);db.ref('teacherCommands').push({type:'clear',ts:Date.now()});}
function toggleLock(){studentsCanDraw=!studentsCanDraw;db.ref('teacherControls').set({studentsCanDraw});document.getElementById('lockBtn').style.background=studentsCanDraw?'#27ae60':'#e74c3c';document.getElementById('lockIcon').className='fas fa-lock'+(studentsCanDraw?'-open':'');}

// â”€â”€ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ø§Ù„Ø­Ù„ Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚ Ù„Ù„ØµÙˆØª:
// - Ù†Ø³Ø¬Ù‘Ù„ stream ÙƒØ§Ù…Ù„Ø§Ù‹ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† chunks Ù…Ù†ÙØµÙ„Ø©
// - ÙƒÙ„ 4 Ø«ÙˆØ§Ù†ÙŠ Ù†ÙˆÙ‚Ù ÙˆÙ†Ø¨Ø¯Ø£ recorder Ø¬Ø¯ÙŠØ¯ â†’ ÙŠØ¹Ø·ÙŠ blob ÙƒØ§Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù€ decode
// - Ù†Ø­ÙØ¸ ÙÙŠ Firebase ÙƒÙ€ base64 ÙƒØ§Ù…Ù„
// - Ø§Ù„Ø·Ø§Ù„Ø¨ ÙŠÙ„Ø¹Ø¨Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ø¨Ø± <audio src="dataURL">

let recInterval = null;
let sessionId = Date.now(); // Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¬Ù„Ø³Ø©

function getMime(){
  for(const t of['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus'])
    if(MediaRecorder.isTypeSupported(t))return t;
  return '';
}

function b64(blob){return new Promise(r=>{const fr=new FileReader();fr.onloadend=()=>r(fr.result);fr.readAsDataURL(blob);})}

async function sendBlob(blob){
  if(!blob||blob.size<200)return;
  const data=await b64(blob);
  sessionId++;
  db.ref('audioBlob/'+sessionId).set({d:data,ts:Date.now()});
  // Ø§Ø­Ø°Ù Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø£Ø¨Ù‚Ù Ø¢Ø®Ø± 3 ÙÙ‚Ø·)
  db.ref('audioBlob').orderByKey().limitToFirst(1).once('value',snap=>{
    snap.forEach(s=>s.ref.remove());
  });
}

function startRecording(){
  if(!micStream)return;
  const mime=getMime();
  const rec=new MediaRecorder(micStream,mime?{mimeType:mime}:{});
  const chunks=[];
  rec.ondataavailable=ev=>{if(ev.data.size>0)chunks.push(ev.data);};
  rec.onstop=()=>{
    if(chunks.length)sendBlob(new Blob(chunks,{type:rec.mimeType||'audio/webm'}));
  };
  rec.start();
  setTimeout(()=>{if(rec.state==='recording')rec.stop();},3000); // ÙƒÙ„ 3 Ø«ÙˆØ§Ù†ÙŠ blob ÙƒØ§Ù…Ù„
  return rec;
}

async function toggleMic(){
  const btn=document.getElementById('micBtn');
  const icon=document.getElementById('micIcon');
  const ind=document.getElementById('micInd');

  if(!micOn){
    icon.className='fas fa-spinner fa-spin'; btn.disabled=true;
    try{
      micStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:true}});
      micOn=true; btn.disabled=false;
      btn.classList.add('mic-on'); icon.className='fas fa-microphone-slash';
      ind.classList.add('on');
      document.getElementById('stEl').textContent='ğŸ¤ Ù…Ø§ÙŠÙƒ Ø´ØºÙ‘Ø§Ù„';
      db.ref('audioMeta').set({active:true,ts:Date.now()});
      // Ø§Ø¨Ø¯Ø£ recording loop
      recInterval=setInterval(()=>startRecording(),3000);
      startRecording(); // Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙˆØ±Ø§Ù‹
    }catch(err){
      btn.disabled=false; icon.className='fas fa-microphone';
      alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†:\n'+err.message);
    }
  }else{
    clearInterval(recInterval); recInterval=null;
    if(micStream)micStream.getTracks().forEach(t=>t.stop());
    micStream=null; micOn=false;
    btn.classList.remove('mic-on'); icon.className='fas fa-microphone';
    ind.classList.remove('on');
    document.getElementById('stEl').textContent='Ù…ØªØµÙ„';
    db.ref('audioMeta').set({active:false});
    db.ref('audioBlob').remove();
  }
}

// â”€â”€ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØµÙˆØª Ø§Ù„Ø·Ù„Ø§Ø¨ (Ù„Ù„Ù…Ø¯Ø±Ø³) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const seenSt=new Set();
async function playTeacher(d){
  if(!d||!d.d||seenSt.has(d.ts))return;
  seenSt.add(d.ts);
  try{const a=new Audio(d.d);await a.play();}catch(e){}
}
db.ref('studentAudio').on('child_changed',snap=>{const v=snap.val();if(v)Object.values(v).forEach(x=>playTeacher(x));});
db.ref('studentAudio').on('child_added',  snap=>{const v=snap.val();if(v)Object.values(v).forEach(x=>playTeacher(x));});

// â”€â”€ Ø§Ù„Ø·Ù„Ø§Ø¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
db.ref('onlineStudents').on('value',snap=>{
  const v=snap.val()||{};
  document.getElementById('cnt').textContent=Object.keys(v).length;
  const list=document.getElementById('slist');list.innerHTML='';
  Object.keys(v).forEach(()=>{
    const c=document.createElement('div');c.className='chip';
    c.innerHTML='<i class="fas fa-user-graduate"></i> Ø·Ø§Ù„Ø¨';list.appendChild(c);
  });
});
db.ref('.info/connected').on('value',snap=>{
  document.getElementById('dotEl').className='dot '+(snap.val()?'on':'off');
});
db.ref('teacher/online').set({online:true,ts:Date.now()});
db.ref('teacherControls').set({studentsCanDraw:true});
[tc,sc].forEach(c=>c.addEventListener('contextmenu',e=>e.preventDefault()));
</script>
</body>
</html>
