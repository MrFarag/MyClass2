<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyClass2 - Ø§Ù„Ù…Ø¯Ø±Ø³</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a2634;
            display: flex;
            flex-direction: column;
            height: 100dvh;
            overflow: hidden;
            color: white;
        }

        /* ===== HEADER ===== */
        .header {
            background: #2c3e50;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #e67e22;
            flex-shrink: 0;
            gap: 10px;
        }

        .logo {
            font-size: 16px;
            font-weight: bold;
            white-space: nowrap;
        }

        .logo i { color: #e67e22; margin-right: 6px; }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .online-count {
            background: #27ae60;
            padding: 5px 12px;
            border-radius: 30px;
            font-size: 13px;
            white-space: nowrap;
        }

        /* Ù…Ø¤Ø´Ø± Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .mic-indicator {
            display: none;
            align-items: center;
            gap: 6px;
            background: #e74c3c;
            padding: 5px 12px;
            border-radius: 30px;
            font-size: 13px;
            animation: pulseRed 1s infinite;
        }

        .mic-indicator.active { display: flex; }

        @keyframes pulseRed {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* ===== BOARDS WRAPPER ===== */
        .boards-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding: 6px;
            gap: 6px;
        }

        /* Desktop: Ø¬Ù†Ø¨ Ø¨Ø¬Ù†Ø¨ */
        @media (min-width: 769px) {
            .boards-wrapper { flex-direction: row; }
        }

        /* Mobile: ÙÙˆÙ‚ Ø¨Ø¹Ø¶Ù‡Ù… */
        @media (max-width: 768px) {
            .boards-wrapper { flex-direction: column; }
        }

        /* ===== BOARD CONTAINER ===== */
        .board-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #2c3e50;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            min-height: 0;
        }

        .board-header {
            padding: 8px 12px;
            background: #34495e;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e67e22;
            flex-shrink: 0;
        }

        .board-header.right { border-bottom-color: #3498db; }

        .board-title {
            font-size: 14px;
            font-weight: bold;
        }

        .board-title i { margin-right: 6px; }

        .board-controls { display: flex; gap: 6px; }

        .board-controls button {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }

        .board-controls button:hover { background: #e67e22; }

        /* ===== CANVAS AREA ===== */
        .canvas-scroll {
            flex: 1;
            overflow: auto;
            position: relative;
            background: #ecf0f1;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
        }

        /* ÙƒÙŠØ±Ø³ÙˆØ± Ø§Ù„Ù‚Ù„Ù… Ø§Ù„Ù…Ø®ØµØµ */
        .canvas-pen-cursor {
            cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath d='M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z' fill='%23333'/%3E%3C/svg%3E") 0 24, crosshair;
        }

        .canvas-eraser-cursor {
            cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Crect x='2' y='10' width='20' height='10' rx='2' fill='%23e74c3c' opacity='0.8'/%3E%3Cpath d='M10 10 L14 6 L20 12 L16 16' fill='%23e74c3c'/%3E%3C/svg%3E") 0 24, crosshair;
        }

        .board-canvas {
            width: 2000px;
            height: 1500px;
            display: block;
            background: white;
            touch-action: none;
        }

        /* ===== TOOLBAR ===== */
        .toolbar {
            background: #34495e;
            padding: 8px 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            border-top: 2px solid #e67e22;
            flex-shrink: 0;
        }

        .tool-group {
            display: flex;
            gap: 4px;
            background: #2c3e50;
            padding: 4px;
            border-radius: 8px;
        }

        .tool-btn {
            width: 38px;
            height: 38px;
            border: none;
            border-radius: 6px;
            background: #3d566e;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .tool-btn:hover { background: #e67e22; transform: scale(1.05); }
        .tool-btn.active { background: #e67e22; box-shadow: 0 0 8px rgba(230,126,34,0.6); }

        /* Ø²Ø± Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† */
        #audioBtn { transition: all 0.3s; }
        #audioBtn.mic-on {
            background: #e74c3c !important;
            animation: pulseMic 1.5s infinite;
        }

        @keyframes pulseMic {
            0%, 100% { box-shadow: 0 0 0 0 rgba(231,76,60,0.6); }
            50% { box-shadow: 0 0 0 8px rgba(231,76,60,0); }
        }

        /* Ø§Ù„Ø£Ù„ÙˆØ§Ù† */
        .color-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-btn:hover { transform: scale(1.15); border-color: rgba(255,255,255,0.5); }
        .color-btn.active { border-color: white; box-shadow: 0 0 8px white; }

        /* Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ù‚Ù„Ù… */
        .size-btn {
            width: 38px;
            height: 38px;
            border: none;
            border-radius: 6px;
            background: #3d566e;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .size-btn:hover { background: #e67e22; }
        .size-btn.active { background: #e67e22; }

        .size-dot {
            background: white;
            border-radius: 50%;
        }

        /* ===== STUDENTS PANEL ===== */
        .students-panel {
            background: #2c3e50;
            padding: 6px 15px;
            border-top: 1px solid #34495e;
            max-height: 70px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .students-title {
            font-size: 12px;
            margin-bottom: 5px;
            color: #bdc3c7;
        }

        .students-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .student-chip {
            background: #34495e;
            padding: 4px 10px;
            border-radius: 30px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            border-left: 3px solid #27ae60;
        }

        .student-chip button {
            background: none;
            border: none;
            color: #ecf0f1;
            cursor: pointer;
        }

        .student-chip button:hover { color: #e67e22; }

        /* ===== STATUS BAR ===== */
        .connection-status {
            padding: 4px 15px;
            background: #1a2634;
            font-size: 12px;
            color: #ecf0f1;
            text-align: center;
            border-top: 1px solid #34495e;
            flex-shrink: 0;
        }

        .status-badge {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .status-badge.online { background: #27ae60; box-shadow: 0 0 6px #27ae60; }
        .status-badge.offline { background: #e74c3c; }

        /* ===== MOBILE SPECIFIC ===== */
        @media (max-width: 768px) {
            .header { padding: 6px 10px; }
            .logo { font-size: 14px; }

            .toolbar {
                padding: 6px 8px;
                gap: 4px;
                overflow-x: auto;
                flex-wrap: nowrap;
            }

            .tool-group { padding: 3px; gap: 3px; }

            .tool-btn, .size-btn {
                width: 34px;
                height: 34px;
                font-size: 14px;
            }

            .color-btn { width: 28px; height: 28px; }

            .students-panel { max-height: 55px; padding: 4px 10px; }
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        .toolbar::-webkit-scrollbar { height: 3px; }
        .toolbar::-webkit-scrollbar-track { background: #2c3e50; }
        .toolbar::-webkit-scrollbar-thumb { background: #e67e22; border-radius: 2px; }
    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="header">
        <div class="logo">
            <i class="fas fa-chalkboard-teacher"></i> MyClass2 - Ø§Ù„Ù…Ø¯Ø±Ø³
        </div>
        <div class="header-right">
            <div class="mic-indicator" id="micIndicator">
                <i class="fas fa-microphone"></i> Ø§Ù„Ù…ÙŠÙƒ Ø´ØºØ§Ù„
            </div>
            <div class="online-count">
                <i class="fas fa-users"></i> <span id="onlineCount">0</span> Ø·Ø§Ù„Ø¨
            </div>
        </div>
    </div>

    <!-- BOARDS -->
    <div class="boards-wrapper">

        <!-- Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ -->
        <div class="board-container">
            <div class="board-header left">
                <span class="board-title"><i class="fas fa-pen-fancy"></i> Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³</span>
                <div class="board-controls">
                    <button onclick="resetScroll('teacher')" title="Ø¥Ø±Ø¬Ø§Ø¹"><i class="fas fa-compress-alt"></i></button>
                </div>
            </div>
            <div class="canvas-scroll" id="teacherScroll">
                <canvas class="board-canvas canvas-pen-cursor" id="teacherCanvas"></canvas>
            </div>
        </div>

        <!-- Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ -->
        <div class="board-container">
            <div class="board-header right">
                <span class="board-title"><i class="fas fa-users"></i> Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</span>
                <div class="board-controls">
                    <button onclick="resetScroll('student')" title="Ø¥Ø±Ø¬Ø§Ø¹"><i class="fas fa-compress-alt"></i></button>
                    <button onclick="clearStudentBoard()" title="Ù…Ø³Ø­"><i class="fas fa-eraser"></i></button>
                </div>
            </div>
            <div class="canvas-scroll" id="studentScroll">
                <canvas class="board-canvas canvas-pen-cursor" id="studentCanvas"></canvas>
            </div>
        </div>

    </div>

    <!-- TOOLBAR -->
    <div class="toolbar">
        <!-- Ø§Ù„Ø£Ù„ÙˆØ§Ù† -->
        <div class="tool-group">
            <div class="color-btn active" style="background:#1a1a1a" onclick="changeColor('#1a1a1a', this)"></div>
            <div class="color-btn" style="background:#e74c3c" onclick="changeColor('#e74c3c', this)"></div>
            <div class="color-btn" style="background:#2980b9" onclick="changeColor('#2980b9', this)"></div>
            <div class="color-btn" style="background:#27ae60" onclick="changeColor('#27ae60', this)"></div>
            <div class="color-btn" style="background:#8e44ad" onclick="changeColor('#8e44ad', this)"></div>
            <div class="color-btn" style="background:#e67e22" onclick="changeColor('#e67e22', this)"></div>
        </div>

        <!-- Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ù‚Ù„Ù… -->
        <div class="tool-group">
            <button class="size-btn active" id="size1" onclick="changeSize(2, 'size1')">
                <div class="size-dot" style="width:4px;height:4px"></div>
            </button>
            <button class="size-btn" id="size2" onclick="changeSize(5, 'size2')">
                <div class="size-dot" style="width:8px;height:8px"></div>
            </button>
            <button class="size-btn" id="size3" onclick="changeSize(10, 'size3')">
                <div class="size-dot" style="width:14px;height:14px"></div>
            </button>
        </div>

        <!-- Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
        <div class="tool-group">
            <button class="tool-btn active" id="penBtn" onclick="setPen()" title="Ù‚Ù„Ù…"><i class="fas fa-pencil-alt"></i></button>
            <button class="tool-btn" id="eraserBtn" onclick="setEraser()" title="Ù…Ù…Ø­Ø§Ø©"><i class="fas fa-eraser"></i></button>
            <button class="tool-btn" onclick="clearAllBoards()" title="Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„" style="background:#c0392b"><i class="fas fa-trash-alt"></i></button>
        </div>

        <!-- Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙˆØ§Ù„ØµÙˆØª -->
        <div class="tool-group">
            <button class="tool-btn" id="audioBtn" onclick="toggleAudio()" title="Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="tool-btn" id="speakerBtn" onclick="toggleSpeaker()" title="Ø§Ù„ØµÙˆØª">
                <i class="fas fa-volume-up"></i>
            </button>
        </div>

        <!-- Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨ -->
        <div class="tool-group">
            <button class="tool-btn" id="studentControlBtn" onclick="toggleStudentDraw()" title="ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø·Ù„Ø§Ø¨" style="background:#27ae60">
                <i class="fas fa-lock-open"></i>
            </button>
        </div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ -->
    <div class="students-panel">
        <div class="students-title"><i class="fas fa-user-graduate"></i> Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†</div>
        <div class="students-list" id="studentsList"></div>
    </div>

    <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
    <div class="connection-status" id="status">
        <span class="status-badge online"></span>
        <span id="statusText">Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…</span>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ================== Firebase ==================
        const firebaseConfig = {
            apiKey: "AIzaSyB7E4NsGQbCehVSQ3Kj97yExRZwpHzTOl8",
            authDomain: "myclaive.firebaseapp.com",
            databaseURL: "https://myclaive-default-rtdb.firebaseio.com",
            projectId: "myclaive",
            storageBucket: "myclaive.firebasestorage.app",
            messagingSenderId: "507299311714",
            appId: "1:507299311714:web:c90440ee4353cfac17613b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ================== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ==================
        const teacherCanvas = document.getElementById('teacherCanvas');
        const studentCanvas = document.getElementById('studentCanvas');
        const teacherCtx = teacherCanvas.getContext('2d');
        const studentCtx = studentCanvas.getContext('2d');
        const teacherScroll = document.getElementById('teacherScroll');
        const studentScroll = document.getElementById('studentScroll');

        let drawing = false;
        let currentTool = 'pen';
        let currentColor = '#1a1a1a';
        let currentSize = 2;
        let lastX = 0, lastY = 0;
        const teacherId = 'teacher_' + Date.now();
        let studentsCanDraw = true;

        // Ø§Ù„ØµÙˆØª
        let audioStream = null;
        let audioActive = false;
        let speakerActive = true;
        let audioContext = null;
        let mediaRecorder = null;

        // ================== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ ==================
        function initCanvas() {
            teacherCanvas.width = 2000;
            teacherCanvas.height = 1500;
            studentCanvas.width = 2000;
            studentCanvas.height = 1500;

            [teacherCtx, studentCtx].forEach(ctx => {
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.lineWidth = currentSize;
                ctx.strokeStyle = currentColor;
                // Ù„Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ù†Ø§Ø¹Ù…Ø©
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
            });
        }
        initCanvas();

        // ================== Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø³Ù… ==================
        function getPos(e, canvas, scroll) {
            let clientX, clientY;
            if (e.touches) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            const rect = canvas.getBoundingClientRect();
            // Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­Ø¬ÙŠÙ… - Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ 2000px Ù„ÙƒÙ† Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙØ¹Ù„ÙŠ Ø£Ù‚Ù„
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (clientX - rect.left) * scaleX + scroll.scrollLeft * scaleX,
                y: (clientY - rect.top) * scaleY + scroll.scrollTop * scaleY
            };
        }

        // ================== Ø±Ø³Ù… Ù†Ø§Ø¹Ù… (Bezier) ==================
        function drawSmoothLine(ctx, x1, y1, x2, y2) {
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            // Ù†Ù‚Ø·Ø© ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ Ù„Ø®Ø· Ù…Ù†Ø­Ù†Ù‰ Ù†Ø§Ø¹Ù…
            const mx = (x1 + x2) / 2;
            const my = (y1 + y2) / 2;
            ctx.quadraticCurveTo(x1, y1, mx, my);
            ctx.stroke();
        }

        // ================== Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ ==================
        function startDrawTeacher(e) {
            e.preventDefault();
            drawing = true;
            const pos = getPos(e, teacherCanvas, teacherScroll);
            lastX = pos.x; lastY = pos.y;
            teacherCtx.beginPath();
            teacherCtx.moveTo(pos.x, pos.y);
        }

        function drawTeacher(e) {
            e.preventDefault();
            if (!drawing) return;
            const pos = getPos(e, teacherCanvas, teacherScroll);
            applyTool(teacherCtx, pos.x, pos.y);

            db.ref('teacherDrawings').push({
                x: pos.x, y: pos.y,
                lastX, lastY,
                color: currentTool === 'eraser' ? 'eraser' : currentColor,
                size: currentTool === 'eraser' ? 30 : currentSize,
                isEraser: currentTool === 'eraser',
                board: 'teacher',
                teacherId,
                timestamp: Date.now()
            });

            lastX = pos.x; lastY = pos.y;
        }

        function stopDrawing() {
            drawing = false;
            teacherCtx.beginPath();
            studentCtx.beginPath();
            teacherCtx.globalCompositeOperation = 'source-over';
            studentCtx.globalCompositeOperation = 'source-over';
        }

        // ================== Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ (Ù„Ù„Ù…Ø¯Ø±Ø³) ==================
        function startDrawStudent(e) {
            e.preventDefault();
            drawing = true;
            const pos = getPos(e, studentCanvas, studentScroll);
            lastX = pos.x; lastY = pos.y;
            studentCtx.beginPath();
            studentCtx.moveTo(pos.x, pos.y);
        }

        function drawStudent(e) {
            e.preventDefault();
            if (!drawing) return;
            const pos = getPos(e, studentCanvas, studentScroll);
            applyToolOnCtx(studentCtx, pos.x, pos.y);

            db.ref('teacherDrawingsOnStudent').push({
                x: pos.x, y: pos.y,
                lastX, lastY,
                color: currentTool === 'eraser' ? 'eraser' : currentColor,
                size: currentTool === 'eraser' ? 30 : currentSize,
                isEraser: currentTool === 'eraser',
                board: 'student',
                teacherId,
                timestamp: Date.now()
            });

            lastX = pos.x; lastY = pos.y;
        }

        // ================== ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ø¯Ø§Ø© ==================
        function applyTool(ctx, x, y) {
            if (currentTool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.strokeStyle = 'rgba(0,0,0,1)';
                ctx.lineWidth = 30;
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = currentSize;
            }
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            // Ø±Ø³Ù… Ù†Ø§Ø¹Ù… Ø¨Ù€ quadratic curve
            const mx = (lastX + x) / 2;
            const my = (lastY + y) / 2;
            ctx.quadraticCurveTo(lastX, lastY, mx, my);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(mx, my);
        }

        function applyToolOnCtx(ctx, x, y) {
            if (currentTool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.strokeStyle = 'rgba(0,0,0,1)';
                ctx.lineWidth = 30;
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = currentSize;
            }
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            const mx = (lastX + x) / 2;
            const my = (lastY + y) / 2;
            ctx.quadraticCurveTo(lastX, lastY, mx, my);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(mx, my);
        }

        // ================== Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø§ÙˆØ³ ÙˆØ§Ù„ØªØ§ØªØ´ ==================
        teacherCanvas.addEventListener('mousedown', startDrawTeacher);
        teacherCanvas.addEventListener('mousemove', drawTeacher);
        teacherCanvas.addEventListener('mouseup', stopDrawing);
        teacherCanvas.addEventListener('mouseleave', stopDrawing);

        studentCanvas.addEventListener('mousedown', startDrawStudent);
        studentCanvas.addEventListener('mousemove', drawStudent);
        studentCanvas.addEventListener('mouseup', stopDrawing);
        studentCanvas.addEventListener('mouseleave', stopDrawing);

        teacherCanvas.addEventListener('touchstart', startDrawTeacher, {passive: false});
        teacherCanvas.addEventListener('touchmove', drawTeacher, {passive: false});
        teacherCanvas.addEventListener('touchend', stopDrawing);

        studentCanvas.addEventListener('touchstart', startDrawStudent, {passive: false});
        studentCanvas.addEventListener('touchmove', drawStudent, {passive: false});
        studentCanvas.addEventListener('touchend', stopDrawing);

        // ================== Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ù… Ø§Ù„Ø·Ù„Ø§Ø¨ ==================
        db.ref('studentDrawings').on('child_added', (snapshot) => {
            const d = snapshot.val();
            if (!d) return;

            if (d.isEraser) {
                studentCtx.globalCompositeOperation = 'destination-out';
                studentCtx.strokeStyle = 'rgba(0,0,0,1)';
            } else {
                studentCtx.globalCompositeOperation = 'source-over';
                studentCtx.strokeStyle = d.color;
            }
            studentCtx.lineWidth = d.size || 3;
            studentCtx.lineCap = 'round';
            studentCtx.lineJoin = 'round';

            studentCtx.beginPath();
            studentCtx.moveTo(d.lastX, d.lastY);
            const mx = (d.lastX + d.x) / 2;
            const my = (d.lastY + d.y) / 2;
            studentCtx.quadraticCurveTo(d.lastX, d.lastY, mx, my);
            studentCtx.stroke();
            studentCtx.globalCompositeOperation = 'source-over';
        });

        // ================== Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø³Ù… ==================
        function changeColor(color, el) {
            currentColor = color;
            currentTool = 'pen';
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('penBtn').classList.add('active');
            document.getElementById('eraserBtn').classList.remove('active');
            updateCanvasCursors();
        }

        function changeSize(size, btnId) {
            currentSize = size;
            document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(btnId).classList.add('active');
        }

        function setPen() {
            currentTool = 'pen';
            document.getElementById('penBtn').classList.add('active');
            document.getElementById('eraserBtn').classList.remove('active');
            updateCanvasCursors();
        }

        function setEraser() {
            currentTool = 'eraser';
            document.getElementById('eraserBtn').classList.add('active');
            document.getElementById('penBtn').classList.remove('active');
            updateCanvasCursors();
        }

        function updateCanvasCursors() {
            [teacherCanvas, studentCanvas].forEach(c => {
                c.className = 'board-canvas ' + (currentTool === 'eraser' ? 'canvas-eraser-cursor' : 'canvas-pen-cursor');
            });
        }

        function clearAllBoards() {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø³Ø¨ÙˆØ±Ø§ØªØŸ')) return;
            teacherCtx.clearRect(0, 0, teacherCanvas.width, teacherCanvas.height);
            studentCtx.clearRect(0, 0, studentCanvas.width, studentCanvas.height);
            db.ref('teacherCommands').push({ type: 'clear', teacherId, timestamp: Date.now() });
        }

        function clearStudentBoard() {
            studentCtx.clearRect(0, 0, studentCanvas.width, studentCanvas.height);
        }

        function resetScroll(board) {
            const el = board === 'teacher' ? teacherScroll : studentScroll;
            el.scrollTo({ left: 0, top: 0, behavior: 'smooth' });
        }

        function toggleStudentDraw() {
            studentsCanDraw = !studentsCanDraw;
            const btn = document.getElementById('studentControlBtn');
            btn.innerHTML = studentsCanDraw
                ? '<i class="fas fa-lock-open"></i>'
                : '<i class="fas fa-lock"></i>';
            btn.style.background = studentsCanDraw ? '#27ae60' : '#e74c3c';
            db.ref('teacherControls').set({ studentsCanDraw });
        }

// ================== Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙˆØ§Ù„ØµÙˆØª Ù…Ø¹ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ==================
async function toggleAudio() {
    const btn = document.getElementById('audioBtn');
    const indicator = document.getElementById('micIndicator');

    if (!audioActive) {
        try {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            audioStream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });

            audioActive = true;
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            btn.classList.add('mic-on');
            indicator.classList.add('active');

            // âœ… Ø¨Ø« Ø§Ù„ØµÙˆØª Ù„Ù„Ø·Ù„Ø§Ø¨
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaStreamSource(audioStream);
            const destination = audioContext.createMediaStreamDestination();
            source.connect(destination);
            
            const mediaRecorder = new MediaRecorder(destination.stream);
            
            mediaRecorder.ondataavailable = event => {
                const reader = new FileReader();
                reader.readAsDataURL(event.data);
                reader.onloadend = () => {
                    db.ref('audioStream/teacher').set({
                        active: true,
                        audioData: reader.result,
                        timestamp: Date.now()
                    });
                };
            };
            
            // Ø¨Ø« ÙƒÙ„ Ø«Ø§Ù†ÙŠØªÙŠÙ†
            mediaRecorder.start(2000);
            window.teacherMediaRecorder = mediaRecorder;

            document.getElementById('statusText').innerText = 'ğŸ¤ ÙŠØªÙ… Ø¨Ø« Ø§Ù„ØµÙˆØª...';

        } catch (err) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-microphone"></i>';
            console.error('Mic error:', err);
            alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: ' + err.message);
        }
    } else {
        if (audioStream) {
            audioStream.getTracks().forEach(t => t.stop());
            audioStream = null;
        }
        if (window.teacherMediaRecorder) {
            window.teacherMediaRecorder.stop();
        }
        if (audioContext) {
            audioContext.close();
        }
        audioActive = false;
        btn.innerHTML = '<i class="fas fa-microphone"></i>';
        btn.classList.remove('mic-on');
        indicator.classList.remove('active');
        document.getElementById('statusText').innerText = 'ğŸ”‡ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…ØªÙˆÙ‚Ù';
        db.ref('audioStream/teacher').remove();
    }
}

        function toggleSpeaker() {
            speakerActive = !speakerActive;
            const btn = document.getElementById('speakerBtn');
            btn.innerHTML = speakerActive
                ? '<i class="fas fa-volume-up"></i>'
                : '<i class="fas fa-volume-mute"></i>';
            btn.style.background = speakerActive ? '#3d566e' : '#e74c3c';
        }

        // ================== Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ==================
        db.ref('onlineStudents').on('value', (snapshot) => {
            const students = snapshot.val();
            const list = document.getElementById('studentsList');
            const count = document.getElementById('onlineCount');
            list.innerHTML = '';

            if (students) {
                const arr = Object.keys(students).map(k => ({ id: k, ...students[k] }));
                count.innerText = arr.length;
                arr.forEach(s => {
                    const chip = document.createElement('div');
                    chip.className = 'student-chip';
                    chip.innerHTML = `
                        <i class="fas fa-user-graduate"></i> Ø·Ø§Ù„Ø¨
                        <button onclick="toggleStudentPermission('${s.id}')">
                            <i class="fas ${s.canDraw !== false ? 'fa-lock-open' : 'fa-lock'}"></i>
                        </button>`;
                    list.appendChild(chip);
                });
            } else {
                count.innerText = '0';
            }
        });

        function toggleStudentPermission(id) {
            db.ref('onlineStudents/' + id).once('value', snap => {
                const s = snap.val();
                db.ref('onlineStudents/' + id).update({ canDraw: !(s.canDraw !== false) });
            });
        }

        // ================== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³ ==================
        db.ref('teacher/online').set({ online: true, timestamp: Date.now() });
        db.ref('teacherControls').set({ studentsCanDraw: true });

        // Ù…Ù†Ø¹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ù‚
        [teacherCanvas, studentCanvas].forEach(c => {
            c.addEventListener('contextmenu', e => e.preventDefault());
        });

        setPen();
    </script>
</body>
</html>
