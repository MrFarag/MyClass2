<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EduStream Pro - المدرس</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: #0a0f1e;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        /* ===== الشريط العلوي ===== */
        .top-bar {
            background: #0d1326;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #1e2a47;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            color: #4f9cf7;
        }

        .logo span {
            color: #ff6b4a;
        }

        .online-count {
            background: #1e2a47;
            padding: 6px 16px;
            border-radius: 40px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .online-count i {
            color: #4ade80;
        }

        .online-count strong {
            color: #4f9cf7;
            margin: 0 4px;
        }

        .quick-actions {
            display: flex;
            gap: 12px;
        }

        .action-btn {
            background: #1e2a47;
            border: none;
            color: #8b9bb5;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #2a3a60;
            color: #fff;
        }

        .action-btn.active {
            background: #4f9cf7;
            color: #fff;
        }

        /* ===== التخطيط الرئيسي ===== */
        .main-layout {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* ===== الشريط الجانبي للطلاب ===== */
        .students-sidebar {
            width: 320px;
            background: #0d1326;
            border-left: 1px solid #1e2a47;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px 16px;
            border-bottom: 1px solid #1e2a47;
        }

        .sidebar-header h3 {
            font-size: 14px;
            color: #8b9bb5;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-box {
            background: #1a2338;
            border-radius: 30px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-box i {
            color: #5f7a9c;
            font-size: 14px;
        }

        .search-box input {
            background: none;
            border: none;
            color: #fff;
            width: 100%;
            outline: none;
            font-size: 13px;
        }

        .students-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .student-item {
            background: #1a2338;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .student-item:hover {
            background: #202d48;
            border-color: #4f9cf7;
        }

        .student-item.speaking {
            border-color: #4ade80;
            background: #1a3a2e;
        }

        .student-item.hand-raised {
            border-color: #fbbf24;
            background: #3a3220;
        }

        .student-item.waiting {
            border-color: #ff6b4a;
            background: #3a2a2a;
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .student-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4f9cf7, #6c5ce7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        .student-details {
            flex: 1;
        }

        .student-details h4 {
            font-size: 14px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .student-details .status {
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #8b9bb5;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.speaking {
            background: #4ade80;
            animation: pulse 1.5s infinite;
        }

        .status-dot.hand-raised {
            background: #fbbf24;
        }

        .status-dot.waiting {
            background: #ff6b4a;
        }

        .status-dot.idle {
            background: #8b9bb5;
        }

        .student-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #2a3a60;
        }

        .student-btn {
            flex: 1;
            padding: 6px;
            border: none;
            border-radius: 20px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: 0.2s;
        }

        .student-btn.approve {
            background: #27ae60;
            color: #fff;
        }

        .student-btn.approve:hover {
            background: #2ecc71;
        }

        .student-btn.allow-mic {
            background: #4f9cf7;
            color: #fff;
        }

        .student-btn.allow-mic:hover {
            background: #6c5ce7;
        }

        .student-btn.disallow-mic {
            background: #e74c3c;
            color: #fff;
        }

        .student-btn.disallow-mic:hover {
            background: #ff6b4a;
        }

        .student-btn.remove {
            background: #7f8c8d;
            color: #fff;
        }

        .student-btn.remove:hover {
            background: #95a5a6;
        }

        .mic-badge {
            background: #4f9cf7;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 10px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .mic-badge.active {
            background: #4ade80;
            color: #0a0f1e;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ===== المحتوى الرئيسي ===== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }

        .control-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .live-indicator {
            background: #ff4d4d;
            padding: 6px 16px;
            border-radius: 30px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            animation: pulse 2s infinite;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .control-btn {
            background: #1e2a47;
            border: none;
            color: #fff;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: #2a3a60;
        }

        .control-btn.active {
            background: #4f9cf7;
        }

        .control-btn.warning {
            background: #ff6b4a;
        }

        .control-btn.mic-active {
            background: #4ade80;
        }

        .boards-container {
            display: flex;
            gap: 20px;
            flex: 1;
            min-height: 0;
        }

        .board-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0d1326;
            border-radius: 16px;
            border: 1px solid #1e2a47;
            overflow: hidden;
        }

        .board-header {
            padding: 16px;
            background: #1a2338;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #4f9cf7;
        }

        .board-header.students {
            border-bottom-color: #ff6b4a;
        }

        .board-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .board-title i {
            color: #4f9cf7;
        }

        .board-title.students i {
            color: #ff6b4a;
        }

        .board-actions button {
            background: #2a3a60;
            border: none;
            color: #fff;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
        }

        .board-content {
            flex: 1;
            background: #fff;
            position: relative;
            overflow: hidden;
        }

        .board-content canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 1600px;
            height: 1200px;
            transform-origin: top left;
        }

        .toolbar {
            background: #0d1326;
            border-top: 1px solid #1e2a47;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .tool-group {
            display: flex;
            gap: 8px;
            background: #1a2338;
            padding: 6px;
            border-radius: 40px;
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #2a3a60;
            color: #fff;
            cursor: pointer;
            transition: 0.2s;
        }

        .tool-btn:hover {
            background: #4f9cf7;
        }

        .tool-btn.active {
            background: #4f9cf7;
        }

        .color-picker {
            display: flex;
            gap: 6px;
            padding: 4px 8px;
        }

        .color-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .color-dot.active {
            border-color: #fff;
            transform: scale(1.15);
        }

        .view-tabs {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 0 20px;
            background: #0d1326;
            border-top: 1px solid #1e2a47;
            height: 48px;
        }

        .tab {
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 13px;
            cursor: pointer;
            color: #8b9bb5;
        }

        .tab:hover {
            color: #fff;
            background: #1e2a47;
        }

        .tab.active {
            background: #4f9cf7;
            color: #fff;
        }
    </style>
</head>
<body>

    <!-- الشريط العلوي -->
    <div class="top-bar">
        <div class="logo-area">
            <div class="logo">Edu<span>Stream</span> Pro</div>
            <div class="online-count">
                <i class="fas fa-circle"></i>
                <span>المتصلون</span>
                <strong id="onlineCount">0</strong>
            </div>
        </div>
        <div class="quick-actions">
            <button class="action-btn active"><i class="fas fa-chalkboard"></i>السبورة الرئيسية</button>
            <button class="action-btn"><i class="fas fa-th"></i>عرض الطلاب</button>
        </div>
    </div>

    <!-- التخطيط الرئيسي -->
    <div class="main-layout">
        <!-- الشريط الجانبي للطلاب -->
        <div class="students-sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-users"></i> إدارة الطلاب</h3>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="ابحث عن طالب..." id="studentSearch">
                </div>
            </div>
            <div class="students-list" id="studentsList"></div>
        </div>

        <!-- المحتوى الرئيسي -->
        <div class="main-content">
            <!-- شريط التحكم -->
            <div class="control-bar">
                <div class="live-indicator"><i class="fas fa-circle"></i>بث مباشر</div>
                <div class="control-buttons">
                    <button class="control-btn" id="micBtn" onclick="toggleTeacherMic()">
                        <i class="fas fa-microphone-slash" id="micIcon"></i>
                        <span id="micText">تشغيل المايك</span>
                    </button>
                    <button class="control-btn" id="lockBtn" onclick="toggleLock()">
                        <i class="fas fa-lock-open" id="lockIcon"></i>
                        <span>الكتابة للطلاب</span>
                    </button>
                </div>
            </div>

            <!-- اللوحات -->
            <div class="boards-container">
                <div class="board-wrapper">
                    <div class="board-header">
                        <div class="board-title"><i class="fas fa-star"></i><span>السبورة الرئيسية</span></div>
                        <div class="board-actions">
                            <button onclick="clearMainBoard()"><i class="fas fa-eraser"></i></button>
                        </div>
                    </div>
                    <div class="board-content" id="mainBoardContainer">
                        <canvas id="mainBoard"></canvas>
                    </div>
                </div>
                <div class="board-wrapper">
                    <div class="board-header students">
                        <div class="board-title students"><i class="fas fa-users"></i><span>لوحة الطلاب</span></div>
                        <div class="board-actions">
                            <button onclick="clearStudentsBoard()"><i class="fas fa-eraser"></i></button>
                        </div>
                    </div>
                    <div class="board-content" id="studentsBoardContainer">
                        <canvas id="studentsBoard"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- شريط الأدوات -->
    <div class="toolbar">
        <div class="tool-group">
            <div class="color-picker">
                <div class="color-dot active" style="background:#000000" onclick="selectColor('#000000', this)"></div>
                <div class="color-dot" style="background:#e74c3c" onclick="selectColor('#e74c3c', this)"></div>
                <div class="color-dot" style="background:#3498db" onclick="selectColor('#3498db', this)"></div>
                <div class="color-dot" style="background:#27ae60" onclick="selectColor('#27ae60', this)"></div>
                <div class="color-dot" style="background:#f39c12" onclick="selectColor('#f39c12', this)"></div>
                <div class="color-dot" style="background:#9b59b6" onclick="selectColor('#9b59b6', this)"></div>
            </div>
        </div>
        <div class="tool-group">
            <button class="tool-btn active" onclick="selectTool('pen')" id="penTool"><i class="fas fa-pencil-alt"></i></button>
            <button class="tool-btn" onclick="selectTool('eraser')" id="eraserTool"><i class="fas fa-eraser"></i></button>
        </div>
        <div class="tool-group">
            <button class="tool-btn" onclick="setSize(2)">◉</button>
            <button class="tool-btn active" onclick="setSize(4)">◉</button>
            <button class="tool-btn" onclick="setSize(8)">◉</button>
        </div>
    </div>

    <!-- علامات التبويب -->
    <div class="view-tabs">
        <div class="tab active"><i class="fas fa-columns"></i>عرض منقسم</div>
        <div class="tab"><i class="fas fa-expand"></i>ملء الشاشة</div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // تهيئة Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyB7E4NsGQbCehVSQ3Kj97yExRZwpHzTOl8",
            authDomain: "myclaive.firebaseapp.com",
            databaseURL: "https://myclaive-default-rtdb.firebaseio.com",
            projectId: "myclaive",
            storageBucket: "myclaive.firebasestorage.app",
            messagingSenderId: "507299311714",
            appId: "1:507299311714:web:c90440ee4353cfac17613b"
        });
        const db = firebase.database();

        // إعدادات Canvas
        const CW = 1600, CH = 1200;
        const mainBoard = document.getElementById('mainBoard');
        const studentsBoard = document.getElementById('studentsBoard');
        const mainCtx = mainBoard.getContext('2d');
        const studentsCtx = studentsBoard.getContext('2d');
        const mainContainer = document.getElementById('mainBoardContainer');
        const studentsContainer = document.getElementById('studentsBoardContainer');

        mainBoard.width = CW; mainBoard.height = CH;
        studentsBoard.width = CW; studentsBoard.height = CH;

        let mainScale = { x: 1, y: 1 };
        let studentsScale = { x: 1, y: 1 };

        function fitCanvases() {
            const fitMain = () => {
                const bw = mainContainer.clientWidth, bh = mainContainer.clientHeight;
                if (!bw || !bh) return;
                mainScale.x = bw / CW; mainScale.y = bh / CH;
                mainBoard.style.width = CW + 'px'; mainBoard.style.height = CH + 'px';
                mainBoard.style.transform = `scale(${mainScale.x}, ${mainScale.y})`;
            };
            const fitStudents = () => {
                const bw = studentsContainer.clientWidth, bh = studentsContainer.clientHeight;
                if (!bw || !bh) return;
                studentsScale.x = bw / CW; studentsScale.y = bh / CH;
                studentsBoard.style.width = CW + 'px'; studentsBoard.style.height = CH + 'px';
                studentsBoard.style.transform = `scale(${studentsScale.x}, ${studentsScale.y})`;
            };
            fitMain(); fitStudents();
        }
        fitCanvases();
        window.addEventListener('resize', fitCanvases);

        // متغيرات الحالة
        let currentColor = '#000000';
        let currentSize = 4;
        let currentTool = 'pen';
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let teacherMicOn = false;
        let teacherMicStream = null;
        let teacherRecInterval = null;
        let studentsCanDraw = true;
        
        // بيانات الطلاب
        let students = {};
        let waitingStudents = {};
        let micPermissions = {};

        // دوال الرسم
        function getCoordinates(e, canvas, scale) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (clientX - rect.left) / scale.x,
                y: (clientY - rect.top) / scale.y
            };
        }

        function drawStart(e) {
            e.preventDefault();
            isDrawing = true;
            const coords = getCoordinates(e, mainBoard, mainScale);
            lastX = coords.x; lastY = coords.y;
            mainCtx.beginPath();
            mainCtx.moveTo(lastX, lastY);
        }

        function drawMove(e) {
            e.preventDefault();
            if (!isDrawing) return;
            const coords = getCoordinates(e, mainBoard, mainScale);
            mainCtx.strokeStyle = currentColor;
            mainCtx.lineWidth = currentSize;
            mainCtx.lineTo(coords.x, coords.y);
            mainCtx.stroke();
            mainCtx.beginPath();
            mainCtx.moveTo(coords.x, coords.y);
            lastX = coords.x; lastY = coords.y;
        }

        function drawEnd(e) {
            e.preventDefault();
            isDrawing = false;
        }

        mainBoard.addEventListener('mousedown', drawStart);
        mainBoard.addEventListener('mousemove', drawMove);
        mainBoard.addEventListener('mouseup', drawEnd);
        mainBoard.addEventListener('mouseleave', drawEnd);
        mainBoard.addEventListener('touchstart', drawStart, { passive: false });
        mainBoard.addEventListener('touchmove', drawMove, { passive: false });
        mainBoard.addEventListener('touchend', drawEnd);

        // أدوات الرسم
        window.selectColor = function(color, element) {
            currentColor = color;
            document.querySelectorAll('.color-dot').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        };

        window.selectTool = function(tool) {
            currentTool = tool;
            document.querySelectorAll('#penTool, #eraserTool').forEach(el => el.classList.remove('active'));
            document.getElementById(tool + 'Tool').classList.add('active');
            mainCtx.globalCompositeOperation = tool === 'eraser' ? 'destination-out' : 'source-over';
        };

        window.setSize = function(size) {
            currentSize = size;
        };

        window.clearMainBoard = function() {
            mainCtx.clearRect(0, 0, CW, CH);
            db.ref('cmd').push({ type: 'clearMain', ts: Date.now() });
        };

        window.clearStudentsBoard = function() {
            studentsCtx.clearRect(0, 0, CW, CH);
            db.ref('cmd').push({ type: 'clearStudents', ts: Date.now() });
        };

        window.toggleLock = function() {
            studentsCanDraw = !studentsCanDraw;
            db.ref('ctrl').set({ studentsCanDraw });
            const btn = document.getElementById('lockBtn');
            const icon = document.getElementById('lockIcon');
            btn.style.background = studentsCanDraw ? '#4f9cf7' : '#e74c3c';
            icon.className = studentsCanDraw ? 'fas fa-lock-open' : 'fas fa-lock';
        };

        // ===== نظام الصوت للمدرس =====
        function getMime() {
            const types = ['audio/webm;codecs=opus', 'audio/webm', 'audio/ogg;codecs=opus'];
            return types.find(t => MediaRecorder.isTypeSupported(t)) || '';
        }

        function toB64(blob) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        }

        let audioSlot = 0;
        function recordTeacherAudio() {
            if (!teacherMicStream || !teacherMicOn) return;
            
            const mime = getMime();
            const recorder = new MediaRecorder(teacherMicStream, {
                mimeType: mime,
                audioBitsPerSecond: 48000
            });
            
            const chunks = [];
            recorder.ondataavailable = e => {
                if (e.data && e.data.size > 0) chunks.push(e.data);
            };
            
            recorder.onstop = async () => {
                if (!chunks.length) return;
                const blob = new Blob(chunks, { type: mime || 'audio/webm' });
                const b64 = await toB64(blob);
                audioSlot = audioSlot === 0 ? 1 : 0;
                db.ref('audio/s' + audioSlot).set({
                    d: b64,
                    ts: Date.now(),
                    speaker: 'teacher'
                });
            };
            
            recorder.start(500);
            setTimeout(() => recorder.stop(), 2000);
        }

        window.toggleTeacherMic = async function() {
            const btn = document.getElementById('micBtn');
            const icon = document.getElementById('micIcon');
            const text = document.getElementById('micText');
            
            if (!teacherMicOn) {
                try {
                    teacherMicStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });
                    teacherMicOn = true;
                    btn.classList.add('mic-active');
                    btn.style.background = '#4ade80';
                    icon.className = 'fas fa-microphone';
                    text.textContent = 'إيقاف المايك';
                    db.ref('audioMeta').set({ active: true, speaker: 'teacher' });
                    recordTeacherAudio();
                    teacherRecInterval = setInterval(recordTeacherAudio, 2100);
                } catch (err) {
                    alert('خطأ في تشغيل المايك: ' + err.message);
                }
            } else {
                clearInterval(teacherRecInterval);
                if (teacherMicStream) teacherMicStream.getTracks().forEach(t => t.stop());
                teacherMicOn = false;
                btn.classList.remove('mic-active');
                btn.style.background = '#ff6b4a';
                icon.className = 'fas fa-microphone-slash';
                text.textContent = 'تشغيل المايك';
                db.ref('audioMeta').set({ active: false });
                db.ref('audio').remove();
            }
        };

        // ===== نظام إدارة الطلاب =====
        function updateStudentsList() {
            const list = document.getElementById('studentsList');
            const onlineCount = document.getElementById('onlineCount');
            
            let html = '';
            let totalOnline = 0;

            // الطلاب المعتمدين
            Object.values(students).forEach(student => {
                if (!student.online) return;
                totalOnline++;
                
                const hasMicPermission = micPermissions[student.id]?.allowed || false;
                const isSpeaking = micPermissions[student.id]?.speaking || false;
                
                html += `
                    <div class="student-item ${isSpeaking ? 'speaking' : ''}" data-id="${student.id}">
                        <div class="student-info">
                            <div class="student-avatar">${student.name.charAt(0)}</div>
                            <div class="student-details">
                                <h4>
                                    ${student.name}
                                    ${hasMicPermission ? '<span class="mic-badge active"><i class="fas fa-microphone"></i></span>' : ''}
                                </h4>
                                <div class="status">
                                    <span class="status-dot ${isSpeaking ? 'speaking' : 'idle'}"></span>
                                    <span>${isSpeaking ? 'يتحدث' : 'مستمع'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="student-actions">
                            ${!hasMicPermission ? 
                                `<button class="student-btn allow-mic" onclick="allowMic('${student.id}')">
                                    <i class="fas fa-microphone"></i> السماح
                                </button>` :
                                `<button class="student-btn disallow-mic" onclick="disallowMic('${student.id}')">
                                    <i class="fas fa-microphone-slash"></i> منع
                                </button>`
                            }
                            <button class="student-btn remove" onclick="removeStudent('${student.id}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            });

            // الطلاب المنتظرين
            Object.values(waitingStudents).forEach(student => {
                html += `
                    <div class="student-item waiting">
                        <div class="student-info">
                            <div class="student-avatar">⏳</div>
                            <div class="student-details">
                                <h4>${student.name}</h4>
                                <div class="status">
                                    <span class="status-dot waiting"></span>
                                    <span>في انتظار الموافقة</span>
                                </div>
                            </div>
                        </div>
                        <div class="student-actions">
                            <button class="student-btn approve" onclick="approveStudent('${student.id}', '${student.name}')">
                                <i class="fas fa-check"></i> موافقة
                            </button>
                        </div>
                    </div>
                `;
            });

            list.innerHTML = html || '<div style="padding:20px; text-align:center; color:#8b9bb5">لا يوجد طلاب</div>';
            onlineCount.textContent = totalOnline;
        }

        // الموافقة على طالب
        window.approveStudent = function(studentId, studentName) {
            db.ref('joinRequests/' + studentId).remove();
            db.ref('approvedStudents/' + studentId).set({
                id: studentId,
                name: studentName,
                approvedAt: Date.now()
            });
            db.ref('studentPermissions/' + studentId).set({
                canDraw: true,
                canSpeak: false
            });
        };

        // السماح باستخدام المايك
        window.allowMic = function(studentId) {
            db.ref('micPermissions/' + studentId).set({
                allowed: true,
                ts: Date.now()
            });
        };

        // منع استخدام المايك
        window.disallowMic = function(studentId) {
            db.ref('micPermissions/' + studentId).remove();
            db.ref('stuAudio').remove();
        };

        // إزالة طالب
        window.removeStudent = function(studentId) {
            if (confirm('هل تريد إزالة هذا الطالب؟')) {
                db.ref('approvedStudents/' + studentId).remove();
                db.ref('studentPermissions/' + studentId).remove();
                db.ref('micPermissions/' + studentId).remove();
                db.ref('onlineStudents/' + studentId).remove();
            }
        };

        // استقبال صوت الطلاب
        const heardAudio = new Set();
        db.ref('stuAudio/s0').on('value', snap => {
            const data = snap.val();
            if (!data || !data.d || heardAudio.has(data.ts)) return;
            heardAudio.add(data.ts);
            
            // تشغيل صوت الطالب
            try {
                const audio = new Audio(data.d);
                audio.volume = 0.8;
                audio.play().catch(() => {});
            } catch (e) {}
        });

        db.ref('stuAudio/s1').on('value', snap => {
            const data = snap.val();
            if (!data || !data.d || heardAudio.has(data.ts)) return;
            heardAudio.add(data.ts);
            
            try {
                const audio = new Audio(data.d);
                audio.volume = 0.8;
                audio.play().catch(() => {});
            } catch (e) {}
        });

        // استقبال طلبات الانضمام
        db.ref('joinRequests').on('child_added', snap => {
            const student = snap.val();
            if (student) {
                waitingStudents[student.id] = student;
                updateStudentsList();
            }
        });

        db.ref('joinRequests').on('child_removed', snap => {
            const student = snap.val();
            if (student) {
                delete waitingStudents[student.id];
                updateStudentsList();
            }
        });

        // استقبال الطلاب المعتمدين
        db.ref('approvedStudents').on('value', snap => {
            students = snap.val() || {};
            updateStudentsList();
        });

        // استقبال حالة الطلاب
        db.ref('onlineStudents').on('value', snap => {
            const online = snap.val() || {};
            Object.keys(students).forEach(id => {
                if (students[id]) students[id].online = online[id] ? true : false;
            });
            updateStudentsList();
        });

        // استقبال أذونات المايك
        db.ref('micPermissions').on('value', snap => {
            micPermissions = snap.val() || {};
            updateStudentsList();
        });

        // حالة الاتصال
        db.ref('.info/connected').on('value', snap => {
            if (snap.val()) {
                db.ref('teacher/online').set({ online: true, ts: Date.now() });
            }
        });

        // استقبال أوامر المسح
        db.ref('cmd').on('child_added', snap => {
            const cmd = snap.val();
            if (!cmd) return;
            if (cmd.type === 'clearMain') mainCtx.clearRect(0, 0, CW, CH);
            if (cmd.type === 'clearStudents') studentsCtx.clearRect(0, 0, CW, CH);
            if (cmd.type === 'clearAll') {
                mainCtx.clearRect(0, 0, CW, CH);
                studentsCtx.clearRect(0, 0, CW, CH);
            }
        });

        // استقبال رسم الطلاب
        db.ref('draw_st').on('child_added', snap => {
            const data = snap.val();
            if (!data || !data.pts) return;
            
            const isEraser = data.s === -1;
            studentsCtx.save();
            studentsCtx.global
