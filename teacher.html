<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EduStream Pro - Teacher Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: #0A0C14;
            color: #E8E9ED;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ===== HEADER SECTION ===== */
        .header {
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #2A2E3D;
            background: #0A0C14;
        }

        .logo-area h1 {
            font-size: 22px;
            font-weight: 600;
            color: #FFFFFF;
        }

        .logo-area h1 span {
            color: #4B7BEC;
        }

        .online-status {
            background: #1E2230;
            padding: 8px 16px;
            border-radius: 100px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .online-status .dot {
            width: 10px;
            height: 10px;
            background: #3FE0A6;
            border-radius: 50%;
            box-shadow: 0 0 10px #3FE0A6;
        }

        .online-status .count {
            color: #4B7BEC;
            font-weight: 600;
            margin: 0 4px;
        }

        .nav-buttons {
            display: flex;
            gap: 8px;
        }

        .nav-btn {
            background: #1E2230;
            border: none;
            color: #9AA1B9;
            padding: 8px 20px;
            border-radius: 100px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn.active {
            background: #4B7BEC;
            color: #FFFFFF;
        }

        .nav-btn i {
            font-size: 14px;
        }

        /* ===== MAIN LAYOUT ===== */
        .main-layout {
            display: flex;
            flex: 1;
            min-height: 0;
            padding: 20px;
            gap: 20px;
        }

        /* ===== LEFT SIDEBAR - STUDENTS LIST ===== */
        .students-sidebar {
            width: 300px;
            background: #121520;
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border: 1px solid #2A2E3D;
        }

        .sidebar-title {
            font-size: 14px;
            color: #9AA1B9;
            margin-bottom: 16px;
            letter-spacing: 0.5px;
        }

        .search-box {
            background: #1E2230;
            border-radius: 100px;
            padding: 10px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-box i {
            color: #5A6279;
            font-size: 14px;
        }

        .search-box input {
            background: none;
            border: none;
            color: #FFFFFF;
            width: 100%;
            outline: none;
            font-size: 14px;
        }

        .search-box input::placeholder {
            color: #5A6279;
        }

        .students-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .student-card {
            background: #1E2230;
            border-radius: 14px;
            padding: 16px;
            border: 1px solid #2A2E3D;
            transition: all 0.2s;
        }

        .student-card.speaking {
            border-color: #3FE0A6;
            background: #1E2A2A;
        }

        .student-card.hand-raised {
            border-color: #F9C74F;
            background: #2A2620;
        }

        .student-card.waiting {
            border-color: #4B7BEC;
            background: #1A1F30;
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .student-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4B7BEC, #9D65FF);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            color: #FFFFFF;
        }

        .student-details {
            flex: 1;
        }

        .student-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .student-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #9AA1B9;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-indicator.speaking {
            background: #3FE0A6;
            animation: pulse 1.5s infinite;
        }

        .status-indicator.hand-raised {
            background: #F9C74F;
        }

        .status-indicator.idle {
            background: #5A6279;
        }

        .student-badge {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 100px;
            background: #2A2E3D;
            color: #9AA1B9;
        }

        .student-badge.speaking {
            background: #3FE0A6;
            color: #0A0C14;
        }

        .student-badge.hand-raised {
            background: #F9C74F;
            color: #0A0C14;
        }

        .student-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #2A2E3D;
        }

        .action-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .action-btn.approve {
            background: #4B7BEC;
            color: #FFFFFF;
        }

        .action-btn.mic-allow {
            background: #3FE0A6;
            color: #0A0C14;
        }

        .action-btn.mic-deny {
            background: #F24E52;
            color: #FFFFFF;
        }

        .action-btn.remove {
            background: #2A2E3D;
            color: #9AA1B9;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ===== MAIN CONTENT AREA ===== */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 0;
        }

        /* ===== CONTROL BAR ===== */
        .control-bar {
            background: #121520;
            border-radius: 100px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #2A2E3D;
        }

        .live-feed {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .live-badge {
            background: #F24E52;
            padding: 6px 16px;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .live-badge i {
            font-size: 10px;
            animation: pulse 2s infinite;
        }

        .control-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ctrl-btn {
            background: #1E2230;
            border: none;
            color: #9AA1B9;
            padding: 8px 16px;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ctrl-btn:hover {
            background: #2A2E3D;
            color: #FFFFFF;
        }

        .ctrl-btn.active {
            background: #4B7BEC;
            color: #FFFFFF;
        }

        .ctrl-btn i {
            font-size: 14px;
        }

        .gain-control {
            background: #1E2230;
            padding: 8px 16px;
            border-radius: 100px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .gain-value {
            color: #3FE0A6;
            font-weight: 600;
        }

        /* ===== BOARDS SECTION ===== */
        .boards-container {
            display: flex;
            gap: 20px;
            flex: 1;
            min-height: 0;
        }

        .board {
            flex: 1;
            background: #121520;
            border-radius: 20px;
            border: 1px solid #2A2E3D;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .board-header {
            padding: 16px 20px;
            background: #1A1E2A;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #4B7BEC;
        }

        .board-header.students-board {
            border-bottom-color: #F9C74F;
        }

        .board-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 15px;
        }

        .board-title i {
            color: #4B7BEC;
        }

        .board-title.students i {
            color: #F9C74F;
        }

        .board-actions {
            display: flex;
            gap: 8px;
        }

        .board-actions button {
            background: #2A2E3D;
            border: none;
            color: #9AA1B9;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .board-actions button:hover {
            background: #4B7BEC;
            color: #FFFFFF;
        }

        .canvas-container {
            flex: 1;
            background: #FFFFFF;
            position: relative;
            overflow: hidden;
        }

        .canvas-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 1600px;
            height: 1200px;
            transform-origin: top left;
        }

        /* ===== BOTTOM TOOLBAR ===== */
        .bottom-toolbar {
            background: #121520;
            border-top: 1px solid #2A2E3D;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .tools-section {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #1E2230;
            padding: 6px;
            border-radius: 100px;
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #9AA1B9;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
        }

        .tool-btn:hover {
            background: #2A2E3D;
            color: #FFFFFF;
        }

        .tool-btn.active {
            background: #4B7BEC;
            color: #FFFFFF;
        }

        .color-palette {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 8px;
        }

        .color-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-dot:hover {
            transform: scale(1.15);
        }

        .color-dot.active {
            border-color: #FFFFFF;
            transform: scale(1.15);
        }

        .size-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 12px;
        }

        .size-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #1E2230;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .size-option:hover {
            background: #2A2E3D;
        }

        .size-option.active {
            background: #4B7BEC;
        }

        .size-dot {
            background: #FFFFFF;
            border-radius: 50%;
        }

        /* ===== STATUS BAR ===== */
        .status-bar {
            background: #0A0C14;
            border-top: 1px solid #2A2E3D;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .latency {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .latency-value {
            color: #3FE0A6;
            font-weight: 600;
        }

        .connection-quality {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .quality-dot {
            width: 8px;
            height: 8px;
            background: #3FE0A6;
            border-radius: 50%;
        }

        .broadcast-btn {
            background: #4B7BEC;
            border: none;
            color: #FFFFFF;
            padding: 8px 24px;
            border-radius: 100px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .broadcast-btn:hover {
            background: #5F8BEE;
            transform: translateY(-1px);
        }

        .broadcast-btn.active {
            background: #F24E52;
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: #9AA1B9;
            padding: 6px 16px;
            border-radius: 100px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tab-btn.active {
            background: #1E2230;
            color: #FFFFFF;
        }

        .zoom-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .zoom-control button {
            background: #1E2230;
            border: none;
            color: #FFFFFF;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
        }

        .zoom-level {
            color: #4B7BEC;
            font-weight: 600;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <div class="logo-area">
            <h1>Edu<span>Stream</span> Pro</h1>
        </div>
        
        <div class="online-status">
            <span class="dot"></span>
            <span>Online Students</span>
            <span class="count" id="onlineCount">0</span>
            <span>/ 30</span>
        </div>

        <div class="nav-buttons">
            <button class="nav-btn active"><i class="fas fa-chalkboard"></i> MAIN BOARD</button>
            <button class="nav-btn"><i class="fas fa-th"></i> STUDENT GRIDS</button>
            <button class="nav-btn"><i class="fas fa-cubes"></i> RESOURCE HUB</button>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Students Sidebar -->
        <div class="students-sidebar">
            <div class="sidebar-title">STUDENTS · ONLINE</div>
            
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Find student..." id="studentSearch">
            </div>

            <div class="students-list" id="studentsList">
                <!-- Students will be populated here -->
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Control Bar -->
            <div class="control-bar">
                <div class="live-feed">
                    <div class="live-badge">
                        <i class="fas fa-circle"></i> LIVE FEED
                    </div>
                </div>

                <div class="control-buttons">
                    <button class="ctrl-btn" id="cameraBtn">
                        <i class="fas fa-video"></i> CAMERA ON
                    </button>
                    
                    <div class="gain-control">
                        <i class="fas fa-microphone"></i>
                        <span>INPUT GAIN</span>
                        <span class="gain-value" id="gainValue">NORMAL</span>
                    </div>

                    <button class="ctrl-btn" id="shareBtn">
                        <i class="fas fa-desktop"></i> SHARE SCREEN
                    </button>

                    <button class="ctrl-btn active" id="noiseBtn">
                        <i class="fas fa-wave-square"></i> NOISE CANCEL
                    </button>

                    <button class="ctrl-btn" id="autoMuteBtn">
                        <i class="fas fa-microphone-slash"></i> AUTO-MUTE
                    </button>
                </div>
            </div>

            <!-- Boards -->
            <div class="boards-container">
                <!-- Main Board -->
                <div class="board">
                    <div class="board-header">
                        <div class="board-title">
                            <i class="fas fa-star"></i>
                            <span>Interactive Whiteboard Active</span>
                        </div>
                        <div class="board-actions">
                            <button onclick="clearMainBoard()"><i class="fas fa-eraser"></i></button>
                            <button onclick="saveBoard()"><i class="fas fa-download"></i></button>
                        </div>
                    </div>
                    <div class="canvas-container" id="mainBoardContainer">
                        <canvas id="mainBoard"></canvas>
                    </div>
                </div>

                <!-- Students Board -->
                <div class="board">
                    <div class="board-header students-board">
                        <div class="board-title students">
                            <i class="fas fa-users"></i>
                            <span>Student Collaboration Board</span>
                        </div>
                        <div class="board-actions">
                            <button onclick="clearStudentsBoard()"><i class="fas fa-eraser"></i></button>
                        </div>
                    </div>
                    <div class="canvas-container" id="studentsBoardContainer">
                        <canvas id="studentsBoard"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Toolbar -->
    <div class="bottom-toolbar">
        <div class="tools-section">
            <button class="tool-btn active" id="penBtn" onclick="selectTool('pen')">
                <i class="fas fa-pencil-alt"></i>
            </button>
            <button class="tool-btn" id="eraserBtn" onclick="selectTool('eraser')">
                <i class="fas fa-eraser"></i>
            </button>
            <button class="tool-btn" id="highlighterBtn" onclick="selectTool('highlighter')">
                <i class="fas fa-highlighter"></i>
            </button>
        </div>

        <div class="color-palette">
            <div class="color-dot active" style="background:#000000" onclick="selectColor('#000000', this)"></div>
            <div class="color-dot" style="background:#F24E52" onclick="selectColor('#F24E52', this)"></div>
            <div class="color-dot" style="background:#4B7BEC" onclick="selectColor('#4B7BEC', this)"></div>
            <div class="color-dot" style="background:#3FE0A6" onclick="selectColor('#3FE0A6', this)"></div>
            <div class="color-dot" style="background:#F9C74F" onclick="selectColor('#F9C74F', this)"></div>
            <div class="color-dot" style="background:#9D65FF" onclick="selectColor('#9D65FF', this)"></div>
        </div>

        <div class="size-selector">
            <div class="size-option active" onclick="setSize(2)">
                <div class="size-dot" style="width:4px; height:4px"></div>
            </div>
            <div class="size-option" onclick="setSize(4)">
                <div class="size-dot" style="width:8px; height:8px"></div>
            </div>
            <div class="size-option" onclick="setSize(8)">
                <div class="size-dot" style="width:12px; height:12px"></div>
            </div>
            <div class="size-option" onclick="setSize(16)">
                <div class="size-dot" style="width:16px; height:16px"></div>
            </div>
        </div>

        <div class="tools-section">
            <button class="tool-btn"><i class="fas fa-chart-bar"></i></button>
            <button class="tool-btn"><i class="fas fa-question-circle"></i></button>
            <button class="tool-btn"><i class="fas fa-comment"></i></button>
            <button class="tool-btn"><i class="fas fa-cog"></i></button>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-left">
            <div class="latency">
                <i class="fas fa-bolt" style="color:#3FE0A6"></i>
                <span>Latency: <span class="latency-value" id="latency">24ms</span></span>
            </div>
            <div class="connection-quality">
                <span class="quality-dot"></span>
                <span>Stable</span>
            </div>
            <button class="broadcast-btn" id="broadcastBtn" onclick="toggleBroadcast()">
                <i class="fas fa-broadcast-tower" id="broadcastIcon"></i>
                <span id="broadcastText">START BROADCASTING</span>
            </button>
        </div>
        <div class="status-right">
            <button class="tab-btn active">
                <i class="fas fa-columns"></i> SPILT VIEW
            </button>
            <div class="zoom-control">
                <button onclick="zoomOut()"><i class="fas fa-minus"></i></button>
                <span class="zoom-level" id="zoomLevel">100%</span>
                <button onclick="zoomIn()"><i class="fas fa-plus"></i></button>
            </div>
        </div>
    </div>

    <!-- Hidden Audio Element -->
    <audio id="audioPlayer" style="display:none"></audio>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration
        firebase.initializeApp({
            apiKey: "AIzaSyB7E4NsGQbCehVSQ3Kj97yExRZwpHzTOl8",
            authDomain: "myclaive.firebaseapp.com",
            databaseURL: "https://myclaive-default-rtdb.firebaseio.com",
            projectId: "myclaive",
            storageBucket: "myclaive.firebasestorage.app",
            messagingSenderId: "507299311714",
            appId: "1:507299311714:web:c90440ee4353cfac17613b"
        });
        const db = firebase.database();

        // Canvas Setup
        const CW = 1600, CH = 1200;
        const mainBoard = document.getElementById('mainBoard');
        const studentsBoard = document.getElementById('studentsBoard');
        const mainCtx = mainBoard.getContext('2d');
        const studentsCtx = studentsBoard.getContext('2d');
        const mainContainer = document.getElementById('mainBoardContainer');
        const studentsContainer = document.getElementById('studentsBoardContainer');

        mainBoard.width = CW; mainBoard.height = CH;
        studentsBoard.width = CW; studentsBoard.height = CH;

        // Drawing Settings
        let currentColor = '#000000';
        let currentSize = 4;
        let currentTool = 'pen';
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let broadcastActive = false;
        let micStream = null;
        let recInterval = null;
        let audioSlot = 0;

        // Students Data
        let approvedStudents = {};
        let waitingStudents = {};
        let micPermissions = {};

        // Canvas Scaling
        let mainScale = { x: 1, y: 1 };
        let studentsScale = { x: 1, y: 1 };

        function fitCanvases() {
            if (mainContainer.clientWidth && mainContainer.clientHeight) {
                mainScale.x = mainContainer.clientWidth / CW;
                mainScale.y = mainContainer.clientHeight / CH;
                mainBoard.style.width = CW + 'px';
                mainBoard.style.height = CH + 'px';
                mainBoard.style.transform = `scale(${mainScale.x}, ${mainScale.y})`;
            }
            if (studentsContainer.clientWidth && studentsContainer.clientHeight) {
                studentsScale.x = studentsContainer.clientWidth / CW;
                studentsScale.y = studentsContainer.clientHeight / CH;
                studentsBoard.style.width = CW + 'px';
                studentsBoard.style.height = CH + 'px';
                studentsBoard.style.transform = `scale(${studentsScale.x}, ${studentsScale.y})`;
            }
        }
        fitCanvases();
        window.addEventListener('resize', fitCanvases);

        // Drawing Functions
        function getCoordinates(e, container, scale) {
            const rect = container.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (clientX - rect.left) / scale.x,
                y: (clientY - rect.top) / scale.y
            };
        }

        function drawStart(e) {
            e.preventDefault();
            isDrawing = true;
            const coords = getCoordinates(e, mainContainer, mainScale);
            lastX = coords.x;
            lastY = coords.y;
            mainCtx.beginPath();
            mainCtx.moveTo(lastX, lastY);
        }

        function drawMove(e) {
            e.preventDefault();
            if (!isDrawing) return;
            const coords = getCoordinates(e, mainContainer, mainScale);
            
            mainCtx.strokeStyle = currentColor;
            mainCtx.lineWidth = currentSize;
            mainCtx.lineTo(coords.x, coords.y);
            mainCtx.stroke();
            mainCtx.beginPath();
            mainCtx.moveTo(coords.x, coords.y);
            
            lastX = coords.x;
            lastY = coords.y;
        }

        function drawEnd(e) {
            e.preventDefault();
            isDrawing = false;
        }

        mainBoard.addEventListener('mousedown', drawStart);
        mainBoard.addEventListener('mousemove', drawMove);
        mainBoard.addEventListener('mouseup', drawEnd);
        mainBoard.addEventListener('mouseleave', drawEnd);
        mainBoard.addEventListener('touchstart', drawStart, { passive: false });
        mainBoard.addEventListener('touchmove', drawMove, { passive: false });
        mainBoard.addEventListener('touchend', drawEnd);

        // Tool Functions
        window.selectTool = function(tool) {
            currentTool = tool;
            document.querySelectorAll('#penBtn, #eraserBtn, #highlighterBtn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(tool + 'Btn').classList.add('active');
            
            if (tool === 'eraser') {
                mainCtx.globalCompositeOperation = 'destination-out';
            } else {
                mainCtx.globalCompositeOperation = 'source-over';
            }
        };

        window.selectColor = function(color, element) {
            currentColor = color;
            document.querySelectorAll('.color-dot').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        };

        window.setSize = function(size) {
            currentSize = size;
            document.querySelectorAll('.size-option').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };

        window.clearMainBoard = function() {
            mainCtx.clearRect(0, 0, CW, CH);
        };

        window.clearStudentsBoard = function() {
            studentsCtx.clearRect(0, 0, CW, CH);
        };

        // Broadcast Functions
        window.toggleBroadcast = async function() {
            const btn = document.getElementById('broadcastBtn');
            const icon = document.getElementById('broadcastIcon');
            const text = document.getElementById('broadcastText');
            
            if (!broadcastActive) {
                try {
                    micStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });
                    
                    broadcastActive = true;
                    btn.classList.add('active');
                    icon.className = 'fas fa-broadcast-tower';
                    text.textContent = 'BROADCASTING';
                    
                    // Start broadcasting
                    db.ref('audioMeta').set({ active: true, ts: Date.now() });
                    startRecording();
                    
                } catch (err) {
                    alert('Microphone access denied');
                }
            } else {
                broadcastActive = false;
                btn.classList.remove('active');
                icon.className = 'fas fa-broadcast-tower';
                text.textContent = 'START BROADCASTING';
                
                if (micStream) {
                    micStream.getTracks().forEach(t => t.stop());
                    micStream = null;
                }
                clearInterval(recInterval);
                db.ref('audioMeta').set({ active: false });
                db.ref('audio').remove();
            }
        };

        function startRecording() {
            if (!micStream || !broadcastActive) return;
            
            const mime = 'audio/webm;codecs=opus';
            const recorder = new MediaRecorder(micStream, { mimeType: mime });
            const chunks = [];
            
            recorder.ondataavailable = e => {
                if (e.data && e.data.size > 0) chunks.push(e.data);
            };
            
            recorder.onstop = () => {
                if (!chunks.length) return;
                const blob = new Blob(chunks, { type: mime });
                const reader = new FileReader();
                reader.onloadend = () => {
                    audioSlot = audioSlot === 0 ? 1 : 0;
                    db.ref('audio/s' + audioSlot).set({
                        d: reader.result,
                        ts: Date.now()
                    });
                };
                reader.readAsDataURL(blob);
            };
            
            recorder.start();
            setTimeout(() => recorder.stop(), 2000);
            
            recInterval = setInterval(startRecording, 2500);
        }

        // Student Management
        function updateStudentsList() {
            const list = document.getElementById('studentsList');
            const onlineCount = document.getElementById('onlineCount');
            
            let html = '';
            let online = 0;
            
            // Approved students
            Object.values(approvedStudents).forEach(student => {
                if (!student.online) return;
                online++;
                
                const hasMic = micPermissions[student.id]?.allowed || false;
                const isSpeaking = micPermissions[student.id]?.speaking || false;
                
                html += `
                    <div class="student-card ${isSpeaking ? 'speaking' : ''}">
                        <div class="student-info">
                            <div class="student-avatar">${student.name.charAt(0)}</div>
                            <div class="student-details">
                                <div class="student-name">${student.name}</div>
                                <div class="student-status">
                                    <span class="status-indicator ${isSpeaking ? 'speaking' : 'idle'}"></span>
                                    <span>${isSpeaking ? 'Speaking' : 'Watching Stream'}</span>
                                </div>
                            </div>
                            ${hasMic ? '<span class="student-badge speaking"><i class="fas fa-microphone"></i> MIC</span>' : ''}
                        </div>
                        <div class="student-actions">
                            ${!hasMic ? 
                                `<button class="action-btn mic-allow" onclick="allowMic('${student.id}')">
                                    <i class="fas fa-microphone"></i> Allow Mic
                                </button>` :
                                `<button class="action-btn mic-deny" onclick="disallowMic('${student.id}')">
                                    <i class="fas fa-microphone-slash"></i> Disable
                                </button>`
                            }
                            <button class="action-btn remove" onclick="removeStudent('${student.id}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            // Waiting students
            Object.values(waitingStudents).forEach(student => {
                html += `
                    <div class="student-card waiting">
                        <div class="student-info">
                            <div class="student-avatar">⏳</div>
                            <div class="student-details">
                                <div class="student-name">${student.name}</div>
                                <div class="student-status">
                                    <span class="status-indicator hand-raised"></span>
                                    <span>Waiting Approval</span>
                                </div>
                            </div>
                        </div>
                        <div class="student-actions">
                            <button class="action-btn approve" onclick="approveStudent('${student.id}', '${student.name}')">
                                <i class="fas fa-check"></i> Approve
                            </button>
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = html || '<div style="padding:20px; text-align:center; color:#5A6279">No students online</div>';
            onlineCount.textContent = online;
        }

        window.approveStudent = function(studentId, studentName) {
            db.ref('joinRequests/' + studentId).remove();
            db.ref('approvedStudents/' + studentId).set({
                id: studentId,
                name: studentName,
                approvedAt: Date.now()
            });
        };

        window.allowMic = function(studentId) {
            db.ref('micPermissions/' + studentId).set({
                allowed: true,
                ts: Date.now()
            });
        };

        window.disallowMic = function(studentId) {
            db.ref('micPermissions/' + studentId).remove();
        };

        window.removeStudent = function(studentId) {
            if (confirm('Remove this student?')) {
                db.ref('approvedStudents/' + studentId).remove();
                db.ref('micPermissions/' + studentId).remove();
                db.ref('onlineStudents/' + studentId).remove();
            }
        };

        // Listeners
        db.ref('joinRequests').on('child_added', snap => {
            const student = snap.val();
            if (student) {
                waitingStudents[student.id] = student;
                updateStudentsList();
            }
        });

        db.ref('joinRequests').on('child_removed', snap => {
            const student = snap.val();
            if (student) {
                delete waitingStudents[student.id];
                updateStudentsList();
            }
        });

        db.ref('approvedStudents').on('value', snap => {
            approvedStudents = snap.val() || {};
            updateStudentsList();
        });

        db.ref('onlineStudents').on('value', snap => {
            const online = snap.val() || {};
            Object.keys(approvedStudents).forEach(id => {
                if (approvedStudents[id]) {
                    approvedStudents[id].online = online[id] ? true : false;
                }
            });
            updateStudentsList();
        });

        db.ref('micPermissions').on('value', snap => {
            micPermissions = snap.val() || {};
            updateStudentsList();
        });

        // Receive student drawings
        db.ref('draw_st').on('child_added', snap => {
            const data = snap.val();
            if (!data || !data.pts) return;
            
            const isEraser = data.s === -1;
            studentsCtx.save();
            studentsCtx.globalCompositeOperation = isEraser ? 'destination-out' : 'source-over';
            studentsCtx.strokeStyle = isEraser ? '#ffffff' : (data.c || '#000000');
            studentsCtx.lineWidth = isEraser ? 30 : (data.s || 4);
            studentsCtx.beginPath();
            studentsCtx.moveTo(data.pts[0].x, data.pts[0].y);
            for (let i = 1; i < data.pts.length; i++) {
                studentsCtx.lineTo(data.pts[i].x, data.pts[i].y);
            }
            studentsCtx.stroke();
            studentsCtx.restore();
        });

        // Teacher presence
        db.ref('.info/connected').on('value', snap => {
            if (snap.val()) {
                db.ref('teacher/online').set({ online: true, ts: Date.now() });
            }
        });

        // Prevent context menu
        [mainBoard, studentsBoard].forEach(c => c.addEventListener('contextmenu', e => e.preventDefault()));

        // Zoom functions
        window.zoomIn = function() {
            let current = parseInt(document.getElementById('zoomLevel').textContent);
            if (current < 200) {
                current += 10;
                document.getElementById('zoomLevel').textContent = current + '%';
            }
        };

        window.zoomOut = function() {
            let current = parseInt(document.getElementById('zoomLevel').textContent);
            if (current > 50) {
                current -= 10;
                document.getElementById('zoomLevel').textContent = current + '%';
            }
        };

        // Simulate latency
        setInterval(() => {
            const latency = Math.floor(Math.random() * 30) + 10;
            document.getElementById('latency').textContent = latency + 'ms';
        }, 3000);
    </script>
</body>
</html>
