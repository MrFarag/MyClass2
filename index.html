<!DOCTYPE html>
<html>
<head>
    <title>Ø³Ø¨ÙˆØ±Ø© Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±</title>
    <style>
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; }
        canvas { flex: 1; background: white; border: 1px solid #ccc; }
        .tools { padding: 10px; background: #333; text-align: center; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; cursor: pointer; }
        .btn-primary { background: #4CAF50; color: white; border: none; }
        .btn-danger { background: #f44336; color: white; border: none; }
        .btn-warning { background: #ff9800; color: white; border: none; }
        #status { color: white; margin-top: 10px; }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div class="tools">
        <button class="btn-primary" onclick="startAudio()">ğŸ¤ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø§Ù„ØµÙˆØªÙŠ</button>
        <button class="btn-danger" onclick="stopAudio()">ğŸ”´ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«</button>
        <button class="btn-warning" onclick="clearBoard()">ğŸ§½ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¨ÙˆØ±Ø©</button>
        <div id="status"></div>
    </div>

    <!-- Ø¥Ø¶Ø§ÙØ© Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Ø¥Ø¶Ø§ÙØ© PeerJS Ù„Ù„ØµÙˆØª -->
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <script>
    // ===== 1. Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ù‡Ù†Ø§ =====
    const firebaseConfig = {
        apiKey: "Ø¶Ø¹_Ø§Ù„Ù…ÙØªØ§Ø­_Ù‡Ù†Ø§",
        authDomain: "myclass2.firebaseapp.com",
        databaseURL: "https://myclass2-default-rtdb.firebaseio.com",
        projectId: "myclass2",
        storageBucket: "myclass2.appspot.com",
        messagingSenderId: "123456789",
        appId: "1:123456789:web:abc123"
    };

    // ØªÙ‡ÙŠØ¦Ø© Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // ===== 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø³Ù… =====
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    let lastX = 0, lastY = 0;
    
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight - 100;
    
    function getMousePos(e) {
        const rect = canvas.getBoundingClientRect();
        return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
        };
    }
    
    // ===== 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ù… Ø¥Ù„Ù‰ Firebase =====
    function sendDrawing(x, y, isDrawing) {
        database.ref('drawings').push({
            x: x,
            y: y,
            isDrawing: isDrawing,
            userId: peer?.id || 'teacher',
            timestamp: Date.now()
        });
    }
    
    // ===== 4. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ù… Ù…Ù† Firebase =====
    database.ref('drawings').on('child_added', (snapshot) => {
        const data = snapshot.val();
        
        // Ù…Ø§ Ù†ÙƒØ±Ø´ Ø§Ù„Ø±Ø³Ù… Ø¨ØªØ§Ø¹Ù†Ø§
        if (data.userId === peer?.id) return;
        
        if (data.isDrawing) {
            // Ø±Ø³Ù… Ø®Ø·
            ctx.lineTo(data.x, data.y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(data.x, data.y);
        } else {
            // Ø¨Ø¯Ø§ÙŠØ© Ø®Ø· Ø¬Ø¯ÙŠØ¯
            ctx.beginPath();
            ctx.moveTo(data.x, data.y);
        }
    });
    
    // ===== 5. Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø±Ø³Ù… =====
    canvas.addEventListener('mousedown', (e) => {
        const pos = getMousePos(e);
        drawing = true;
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        sendDrawing(pos.x, pos.y, false);
    });
    
    canvas.addEventListener('mousemove', (e) => {
        if (!drawing) return;
        
        const pos = getMousePos(e);
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.strokeStyle = 'black';
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        
        sendDrawing(pos.x, pos.y, true);
    });
    
    canvas.addEventListener('mouseup', () => {
        drawing = false;
    });
    
    canvas.addEventListener('mouseleave', () => {
        drawing = false;
    });
    
    // Ø¯Ø¹Ù… Ø§Ù„Ù„Ù…Ø³ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const pos = {
            x: touch.clientX - rect.left,
            y: touch.clientY - rect.top
        };
        drawing = true;
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        sendDrawing(pos.x, pos.y, false);
    });
    
    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!drawing) return;
        
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const pos = {
            x: touch.clientX - rect.left,
            y: touch.clientY - rect.top
        };
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        
        sendDrawing(pos.x, pos.y, true);
    });
    
    canvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        drawing = false;
    });
    
    // Ù…Ø³Ø­ Ø§Ù„Ø³Ø¨ÙˆØ±Ø©
    function clearBoard() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        database.ref('drawings').remove();
    }
    
    // ===== 6. Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª =====
    let localStream;
    let peer;
    
    peer = new Peer();
    
    peer.on('open', (id) => {
        document.getElementById('status').innerHTML = `
            âœ… Ø§Ù„Ø¨Ø« Ø¬Ø§Ù‡Ø² - Ù…Ø¹Ø±ÙÙƒ: <strong>${id}</strong>
        `;
    });
    
    peer.on('call', (call) => {
        if (localStream) {
            call.answer(localStream);
        }
    });
    
    async function startAudio() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            document.getElementById('status').innerHTML = 'ğŸ”´ Ø§Ù„Ø¨Ø« Ø§Ù„ØµÙˆØªÙŠ Ø´ØºØ§Ù„';
        } catch (err) {
            alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: ' + err.message);
        }
    }
    
    function stopAudio() {
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
            document.getElementById('status').innerHTML = 'â¹ï¸ Ø§Ù„Ø¨Ø« Ù…ØªÙˆÙ‚Ù';
        }
    }
    </script>
</body>
</html>
